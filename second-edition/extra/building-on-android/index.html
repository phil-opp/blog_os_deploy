<!doctype html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="I finally managed to get blog_os building on my Android phone using termux. This post explains the necessary steps to set it up.
">
    <meta name="author" content="Philipp Oppermann">

    
        <link rel="canonical" href="https://os.phil-opp.com/second-edition/extra/building-on-android/" />
    
    <link href="/css/poole.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">

    <script async src="/js/main.js"></script>

    <title>Building on Android | Writing an OS in Rust</title>
</head>

<body>
    <div class="container content">
        <header class="masthead">
            <div style="position:relative">
                <h1 class="masthead-title">
                    <a href="https://os.phil-opp.com" title="Home">Writing an OS in Rust</a>
                </h1>
                <p><small>Philipp&nbsp;Oppermann's&nbsp;blog</small></p>
                
            </div>
        </header>

        <main>
    <h1>Building on Android</h1>
    <p>I finally managed to get <code>blog_os</code> building on my Android phone using <a href="https://termux.com/">termux</a>. This post explains the necessary steps to set it up.</p>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<img src="building-on-android.png" alt="Screenshot of the compilation output from android" style="height: 50rem;" >
<h3 id="install-termux-and-nightly-rust"><a class="zola-anchor" href="#install-termux-and-nightly-rust" aria-label="Anchor link for: install-termux-and-nightly-rust">ðŸ”—</a>Install Termux and Nightly Rust</h3>
<p>First, install <a href="https://termux.com/">termux</a> from the <a href="https://play.google.com/store/apps/details?id=com.termux">Google Play Store</a> or from <a href="https://f-droid.org/packages/com.termux/">F-Droid</a>. After installing, open it and perform the following steps:</p>
<ul>
<li>
<p>Install fish shell, set as default shell, and launch it:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">pkg install fish
</span><span style="color:#dcdcdc;">chsh -s fish
</span><span style="color:#dcdcdc;">fish
</span></pre>
<p>This step is of course optional. However, if you continue with bash you will need to adjust some of the following commands to bash syntax.</p>
</li>
<li>
<p>Install some basic tools:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">pkg install wget tar
</span></pre></li>
<li>
<p>Add the <a href="https://wiki.termux.com/wiki/Package_Management#By_its-pointless_.28live_the_dream.29:">community repository by its-pointless</a>:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">wget https://its-pointless.github.io/setup-pointless-repo.sh
</span><span style="color:#dcdcdc;">bash setup-pointless-repo.sh
</span></pre></li>
<li>
<p>Install cargo and a nightly version of rustc:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">pkg install rustc cargo rustc-nightly
</span></pre></li>
<li>
<p>Prepend the nightly rustc path to your <code>PATH</code> in order to use nightly (fish syntax):</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">set -U fish_user_paths $PREFIX/opt/rust-nightly/bin/ $fish_user_paths
</span></pre></li>
</ul>
<p>Now <code>rustc --version</code> should work and output a nightly version number.</p>
<h3 id="install-git-and-clone-blog-os"><a class="zola-anchor" href="#install-git-and-clone-blog-os" aria-label="Anchor link for: install-git-and-clone-blog-os">ðŸ”—</a>Install Git and Clone blog_os</h3>
<p>We need something to compile, so let's download the <code>blog_os</code> repository:</p>
<ul>
<li>
<p>Install git:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">pkg install git
</span></pre></li>
<li>
<p>Clone the <code>blog_os</code> repository:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">git clone https://github.com/phil-opp/blog_os.git
</span></pre></li>
</ul>
<p>If you want to clone/push via SSH, you need to install the <code>openssh</code> package: <code>pkg install openssh</code>.</p>
<h3 id="install-xbuild-and-bootimage"><a class="zola-anchor" href="#install-xbuild-and-bootimage" aria-label="Anchor link for: install-xbuild-and-bootimage">ðŸ”—</a>Install Xbuild and Bootimage</h3>
<p>Now we're ready to install <code>cargo xbuild</code> and <code>bootimage</code></p>
<ul>
<li>
<p>Run <code>cargo install</code>:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">cargo install cargo-xbuild bootimage
</span></pre></li>
<li>
<p>Add the cargo bin directory to your <code>PATH</code> (fish syntax):</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">set -U fish_user_paths ~/.cargo/bin/ $fish_user_paths
</span></pre></li>
</ul>
<p>Now <code>cargo xbuild</code> and <code>bootimage</code> should be available. It does not work yet because <code>cargo xbuild</code> needs access to the rust source code. By default it tries to use rustup for this, but we have no rustup support so we need a different way.</p>
<h3 id="providing-the-rust-source-code"><a class="zola-anchor" href="#providing-the-rust-source-code" aria-label="Anchor link for: providing-the-rust-source-code">ðŸ”—</a>Providing the Rust Source Code</h3>
<p>The Rust source code corresponding to our installed nightly is available in the <a href="https://github.com/its-pointless/its-pointless.github.io"><code>its-pointless</code> repository</a>:</p>
<ul>
<li>
<p>Download a tar containing the source code:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">wget https://github.com/its-pointless/its-pointless.github.io/raw/master/rust-src-nightly.tar.xz
</span></pre></li>
<li>
<p>Extract it:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">tar xf rust-src-nightly.tar.xz
</span></pre></li>
<li>
<p>Set the <code>XARGO_RUST_SRC</code> environment variable to tell cargo-xbuild the source path (fish syntax):</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">set -Ux XARGO_RUST_SRC ~/rust-src-nightly/rust-src/lib/rustlib/src/rust/src
</span></pre></li>
</ul>
<p>Now cargo-xbuild should no longer complain about a missing <code>rust-src</code> component. However it will throw an I/O error after building the sysroot. The problem is that the downloaded Rust source code has a different structure than the source provided by rustup. We can fix this by adding a symbolic link:</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">ln -s ~/../usr/opt/rust-nightly/bin ~/../usr/opt/rust-nightly/lib/rustlib/aarch64-linux-android/bin
</span></pre>
<p>Now <code>cargo xbuild --target x86_64-blog_os.json</code> and <code>bootimage build</code> should both work!</p>
<p>I couldn't get QEMU to run yet, so you won't be able to run your kernel. If you manage to get it working, please tell me :).</p>

</main>

        <div>
    <hr>
    <section>
        <h2>Comments</h2>
        
    <script src="https://utteranc.es/client.js"
        data-repo="phil-opp/blog_os"
        data-issue-term="url"
        data-label="comments"
        crossorigin="anonymous"
        async>
    </script>

    </section>
</div>

        <footer class="footer">
            <hr>
            <small>
                &copy; <time datetime="2020">2020</time>. All rights reserved.
                <a href="https://os.phil-opp.com/contact/">Contact</a>
            </small>
        </footer>
    </div>

    <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
    <script>
        (function(f, a, t, h, o, m){
            a[h]=a[h]||function(){
                (a[h].q=a[h].q||[]).push(arguments)
            };
            o=f.createElement('script'),
            m=f.getElementsByTagName('script')[0];
            o.async=1; o.src=t; o.id='fathom-script';
            m.parentNode.insertBefore(o,m)
        })(document, window, '//fathom.phil-opp.com/tracker.js', 'fathom');
        fathom('set', 'siteId', 'MUXWM');
        fathom('trackPageview');
    </script>
    <!-- / Fathom -->
</body>

</html>
