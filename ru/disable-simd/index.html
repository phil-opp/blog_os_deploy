<!doctype html><html lang=ru><head><meta charset=UTF-8><meta content=yes name=apple-mobile-web-app-capable><meta content="width=device-width,initial-scale=1" name=viewport><meta content="light dark" name=color-scheme><meta content="Инструкции Single Instruction Multiple Data (SIMD) способны выполнять операцию (например, сложение) одновременно над несколькими словами данных, что м…" name=description><meta content="Philipp Oppermann" name=author><link href=https://os.phil-opp.com/ru/disable-simd/ rel=canonical><link href=/css/edition-2/main.css rel=stylesheet><link title="RSS feed for os.phil-opp.com" href=https://os.phil-opp.com/rss.xml rel=alternate type=application/rss+xml><script>let theme = localStorage.getItem("theme");
        if (theme != null) {
            document.documentElement.setAttribute("data-theme", theme);
        }</script><script async src=/js/edition-2/main.js></script><title>Отключение SIMD | Writing an OS in Rust</title><body><div class="container content"><header class=masthead><div style=position:relative><h2 class=masthead-title><a href=https://os.phil-opp.com title=Home>Writing an OS in Rust</a></h2><p><small>Philipp Oppermann's blog</small></div></header><div class=theme-switch><div title="Switch between light and dark theme" class=light-switch onclick=toggle_lights()></div><div title="Clear the theme override and go back to the system theme" class=light-switch-reset onclick=clear_theme_override()></div></div><div><main><h1>Отключение SIMD</h1><p>Инструкции <a href=https://en.wikipedia.org/wiki/SIMD>Single Instruction Multiple Data (SIMD)</a> способны выполнять операцию (например, сложение) одновременно над несколькими словами данных, что может значительно ускорить работу программ. Архитектура <code>x86_64</code> поддерживает различные стандарты SIMD:</p><span id=continue-reading></span><ul><li><a href=https://en.wikipedia.org/wiki/MMX_(instruction_set)>MMX</a>: Набор инструкций <em>Multi Media Extension</em> был представлен в 1997 году и определяет восемь 64-битных регистров, называемых <code>mm0</code> - <code>mm7</code>. Эти регистры являются псевдонимами регистров <a href=https://en.wikipedia.org/wiki/X87>x87 блока с плавающей запятой</a>.<li><a href=https://en.wikipedia.org/wiki/Streaming_SIMD_Extensions>SSE</a>: Набор инструкций <em>Streaming SIMD Extensions</em> был представлен в 1999 году. Вместо повторного использования регистров с плавающей запятой он добавляет совершенно новый набор регистров. Шестнадцать новых регистров называются <code>xmm0</code> - <code>xmm15</code> и имеют размер 128 бит каждый.<li><a href=https://en.wikipedia.org/wiki/Advanced_Vector_Extensions>AVX</a>: <em>Advanced Vector Extensions</em> - это расширения, которые еще больше увеличивают размер мультимедийных регистров. Новые регистры называются <code>ymm0</code> - <code>ymm15</code> и имеют размер 256 бит каждый. Они расширяют регистры <code>xmm</code>, поэтому, например, <code>xmm0</code> - это нижняя половина <code>ymm0</code>.</ul><p>Используя такие стандарты SIMD, программы часто могут значительно ускориться. Хорошие компиляторы способны автоматически преобразовывать обычные циклы в такой SIMD-код с помощью процесса, называемого <a href=https://en.wikipedia.org/wiki/Automatic_vectorization>автовекторизацией</a>.<p>Однако большие регистры SIMD приводят к проблемам в ядрах ОС. Причина в том, что ядро должно создавать резервные копии всех регистров, которые оно использует, в память при каждом аппаратном прерывании, потому что они должны иметь свои первоначальные значения, когда прерванная программа продолжает работу. Поэтому, если ядро использует SIMD-регистры, ему приходится резервировать гораздо больше данных (512-1600 байт), что заметно снижает производительность. Чтобы избежать этого снижения производительности, мы хотим отключить функции <code>sse</code> и <code>mmx</code> (функция <code>avx</code> отключена по умолчанию).<p>Мы можем сделать это через поле <code>features</code> в нашей целевой спецификации. Чтобы отключить функции <code>mmx</code> и <code>sse</code>, мы добавим их с минусом:<pre class=language-json data-lang=json style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-json data-lang=json><span style=color:#d69d85;>"features"</span><span>: </span><span style=color:#d69d85;>"-mmx,-sse"
</span></code></pre><h2 id=chisla-s-plavaiushchei-tochkoi>Числа с плавающей точкой</h2><p>К сожалению для нас, архитектура <code>x86_64</code> использует регистры SSE для операций с числами с плавающей точкой. Таким образом, каждое использование чисел с плавающей точкой с отключенным SSE вызовёт ошибку в LLVM. Проблема в том, что библиотека <code>core</code> уже использует числа с плавающей точкой (например, в ней реализованы трейты для <code>f32</code> и <code>f64</code>), поэтому недостаточно избегать чисел с плавающей точкой в нашем ядре.<p>К счастью, LLVM поддерживает функцию <code>soft-float</code>, эмулирующую все операции с числавами с плавающей точкой через программные функции, основанные на обычных целых числах. Это позволяет использовать плавающие числа в нашем ядре без SSE, просто это будет немного медленнее.<p>Чтобы включить функцию <code>soft-float</code> для нашего ядра, мы добавим ее в строку <code>features</code> в спецификации цели с префиксом плюс:<pre class=language-json data-lang=json style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-json data-lang=json><span style=color:#d69d85;>"features"</span><span>: </span><span style=color:#d69d85;>"-mmx,-sse,+soft-float"
</span></code></pre></main></div><div><hr><section><h2 id=comments>Comments</h2><p class=comment-note>Do you have a problem, want to share feedback, or discuss further ideas? Feel free to leave a comment here! Please stick to English and follow Rust's <a href=https://www.rust-lang.org/policies/code-of-conduct>code of conduct</a>. This comment thread directly maps to a <a href='https://github.com/phil-opp/blog_os/discussions/categories/post-comments?discussions_q="Отключение SIMD (Extra Post)"'><em>discussion on GitHub</em></a>, so you can also comment there if you prefer.<div class=giscus></div><script data-category="Post Comments" data-repo-id="MDEwOlJlcG9zaXRvcnkzOTU3NTEwMQ==" data-term="Отключение SIMD (Extra Post)" async crossorigin=anonymous data-category-id=MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDE4OTg1 data-emit-metadata=1 data-mapping=specific data-reactions-enabled=1 data-repo=phil-opp/blog_os data-theme=preferred_color_scheme src=https://giscus.app/client.js></script><p class=comment-directly-on-github>Instead of authenticating the <a href=https://giscus.app>giscus</a> application, you can also comment directly <a href='https://github.com/phil-opp/blog_os/discussions/categories/post-comments?discussions_q="Отключение SIMD (Extra Post)"'><em>on GitHub</em></a>.</section></div><footer class=footer><hr><small> © <time datetime=2021>2021</time>. All rights reserved. <a href=https://os.phil-opp.com/contact/>Contact</a> </small></footer></div><script async data-goatcounter=https://phil-opp.goatcounter.com/count src=//gc.zgo.at/count.js></script>