<!doctype html>

<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Красная зона — это оптимизация System V ABI, которая позволяет функциям временно использовать 128 байт ниже своего стекового кадра без корректировки у…">
    <meta name="author" content="Philipp Oppermann">

    
        <link rel="canonical" href="https://os.phil-opp.com/ru/red-zone/" />
    
    <link href="/css/edition-2/poole.css" rel="stylesheet">
    <link href="/css/edition-2/main.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="RSS feed for os.phil-opp.com" href="https://os.phil-opp.com/rss.xml" />

    <script async src="/js/edition-2/main.js"></script>

    <title>Отключение красной зоны | Writing an OS in Rust</title>
</head>

<body>
    <div class="container content">
        <header class="masthead">
            <div style="position:relative">
                <h2 class="masthead-title">
                    <a href="https://os.phil-opp.com" title="Home">Writing an OS in Rust</a>
                </h2>
                <p><small>Philipp&nbsp;Oppermann's&nbsp;blog</small></p>
                
            </div>
        </header>

        <div>
            
            <main>
    <h1>Отключение красной зоны</h1>
    <p><a href="https://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64#the-red-zone">Красная зона</a> — это оптимизация <a href="https://wiki.osdev.org/System_V_ABI">System V ABI</a>, которая позволяет функциям временно использовать 128 байт ниже своего стекового кадра без корректировки указателя стека:</p>
<span id="continue-reading"></span>
<p><img src="https://os.phil-opp.com/ru/red-zone/red-zone.svg" alt="stack frame with red zone" /></p>
<p>На рисунке показан стековый фрейм функции с <code>n</code> локальных переменных. При входе в функцию указатель стека корректируется, чтобы освободить место в стеке для адреса возврата и локальных переменных.</p>
<p>Красная зона определяется как 128 байт ниже скорректированного указателя стека. Функция может использовать эту зону для временных данных, которые не нужны при всех вызовах функции. Таким образом, в некоторых случаях (например, в небольших листовых функциях) можно обойтись без двух инструкций для корректировки указателя стека.</p>
<p>Однако такая оптимизация приводит к огромным проблемам при работе с исключениями или аппаратными прерываниями. Предположим, что во время использования функцией красной зоны происходит исключение:</p>
<p><img src="https://os.phil-opp.com/ru/red-zone/red-zone-overwrite.svg" alt="red zone overwritten by exception handler" /></p>
<p>Процессор и обработчик исключений перезаписывают данные в красной зоне. Но эти данные все еще нужны прерванной функции. Поэтому функция не будет работать правильно, когда мы вернемся из обработчика исключений. Это может привести к странным ошибкам, на отладку которых <a href="https://forum.osdev.org/viewtopic.php?t=21720">уйдут недели</a>.</p>
<p>Чтобы избежать подобных ошибок при реализации обработки исключений в будущем, мы отключим красную зону с самого начала. Это достигается путем добавления строки <code>&quot;disable-redzone&quot;: true</code> в наш целевой конфигурационный файл.</p>

</main>
        </div>

        <div>
    <hr>
    <section>
        <h2 id="comments">Comments</h2>
        
    <div class="giscus"></div>

    <script src="https://giscus.app/client.js"
        data-repo="phil-opp/blog_os"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzOTU3NTEwMQ=="
        data-category="Post Comments"
        data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDE4OTg1"
    
        data-mapping="specific"
    
        data-term="Отключение красной зоны (Extra Post)"
        data-reactions-enabled="1"
        data-theme="preferred_color_scheme"
        crossorigin="anonymous"
        async>
    </script>

    <p class="comment-directly-on-github">
        Instead of authenticating the <a href="https://giscus.app">giscus</a> application, you can also comment directly on the <span class="discussion_link">on GitHub. Just click the <i>"X comments"</i> link at the <a href="#comments">top</a> — or the date of any comment — to go to the GitHub discussion.</span>
    </p>

    </section>
</div>

        <footer class="footer">
            <hr>
            <small>
                &copy; <time datetime="2021">2021</time>. All rights reserved.
                <a href="https://os.phil-opp.com/contact/">Contact</a>
            </small>
        </footer>
    </div>

    <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
    <script>
        (function(f, a, t, h, o, m){
            a[h]=a[h]||function(){
                (a[h].q=a[h].q||[]).push(arguments)
            };
            o=f.createElement('script'),
            m=f.getElementsByTagName('script')[0];
            o.async=1; o.src=t; o.id='fathom-script';
            m.parentNode.insertBefore(o,m)
        })(document, window, '//fathom.phil-opp.com/tracker.js', 'fathom');
        fathom('set', 'siteId', 'MUXWM');
        fathom('trackPageview');
    </script>
    <!-- / Fathom -->
</body>

</html>
