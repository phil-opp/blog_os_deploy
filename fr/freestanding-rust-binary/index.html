<!doctype html>

<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="+++
La premi√®re √©tape pour cr√©er notre propre noyau de syst√®me d&#x27;exploitation est de cr√©er un ex√©cutable Rust qui ne relie pas la biblioth√®que standar‚Ä¶">
    <meta name="author" content="Philipp Oppermann">

    
        <link rel="canonical" href="https://os.phil-opp.com/fr/freestanding-rust-binary/" />
    
    <link href="/css/edition-2/main.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="RSS feed for os.phil-opp.com" href="https://os.phil-opp.com/rss.xml" />

    <script>
        let theme = localStorage.getItem("theme");
        if (theme != null) {
            document.documentElement.setAttribute("data-theme", theme);
        }
    </script>

    <script async src="/js/edition-2/main.js"></script>

    <title>A Freestanding Rust Binary | Writing an OS in Rust</title>
</head>

<body>
    <div class="container content">
        <header class="masthead">
            <div style="position:relative">
                <h2 class="masthead-title">
                    <a href="https://os.phil-opp.com" title="Home">Writing an OS in Rust</a>
                </h2>
                <p><small>Philipp&nbsp;Oppermann's&nbsp;blog</small></p>
                
    <aside id="all-posts-link"><a href="https://os.phil-opp.com/fr" title="All Posts">¬´ Tous les articles</a></aside>

            </div>
        </header>

        <div class="theme-switch">
            <div class="light-switch" onclick="toggle_lights()" title="Switch between light and dark theme"></div>
            <div class="light-switch-reset" onclick="clear_theme_override()" title="Clear the theme override and go back to the system theme"></div>
        </div>

        <div>
            
<aside id="toc-aside" class="">
        <h2>Table des mati√®res</h2>
    <ol>
        <li>
            <a href="#introduction">Introduction</a>
            
        </li><li>
            <a href="#desactiver-la-bibliotheque-standard">D√©sactiver la Biblioth√®que Standard</a>
            <ol>
                <li>
                    <a href="#l-attribut-no-std">L'Attribut no_std</a>
                </li>
            </ol>
        </li><li>
            <a href="#implementation-de-panic">Impl√©mentation de Panic</a>
            
        </li><li>
            <a href="#l-objet-de-langage-eh-personality">L'Objet de Langage eh_personality</a>
            <ol>
                <li>
                    <a href="#desactiver-le-deroulement">D√©sactiver le D√©roulement</a>
                </li>
            </ol>
        </li><li>
            <a href="#l-attribut-start">L'attribut start</a>
            <ol>
                <li>
                    <a href="#reecrire-le-point-d-entree">R√©√©crire le Point d'Entr√©e</a>
                </li>
            </ol>
        </li><li>
            <a href="#erreurs-de-linker">Erreurs de Linker</a>
            <ol>
                <li>
                    <a href="#compiler-pour-une-cible-bare-metal">Compiler pour une Cible Bare Metal</a>
                </li><li>
                    <a href="#arguments-du-linker">Arguments du Linker</a>
                </li>
            </ol>
        </li><li>
            <a href="#resume">R√©sum√©</a>
            
        </li><li>
            <a href="#et-ensuite">Et ensuite ?</a>
            
        </li>
        <li class="toc-comments-link"><a href="#comments">Commentaires</a></li>
    </ol>
</aside>

            <main>
    <div class="">
    <h1>A Freestanding Rust Binary</h1>
    <time datetime="2018-02-10" class="post-date">
        Feb 10, 2018
        
    </time>
    </div>

    
        <div class="warning">
            
            
            <p>
            <b>Contenu traduit : </b>
            Ceci est une traduction communautaire de l'article <strong><a href="https://os.phil-opp.com/freestanding-rust-binary/">A Freestanding Rust Binary</a></strong>. Il peut √™tre incomplet, obsol√®te ou contenir des erreurs. Veuillez signaler les quelconques probl√®mes !
            </p>
            <p>
                Traduit par :  <a href="https://github.com/Alekzus">@Alekzus</a>.
            </p>
            </div>
    

    <div class="">
    <p>+++</p>
<p>La premi√®re √©tape pour cr√©er notre propre noyau de syst√®me d'exploitation est de cr√©er un ex√©cutable Rust qui ne relie pas la biblioth√®que standard. Cela rend possible l'ex√©cution du code Rust sur la <a href="https://en.wikipedia.org/wiki/Bare_machine">&quot;bare machine&quot;</a> sans syst√®me d'exploitation sous-jacent.</p>
<span id="continue-reading"></span>
<p>Ce blog est d√©velopp√© sur <a href="https://github.com/phil-opp/blog_os">GitHub</a>. Si vous avez un probl√®me ou une question, veuillez ouvrir une issue. Vous pouvez aussi laisser un commentaire <a href="https://os.phil-opp.com/fr/freestanding-rust-binary/#comments">en bas de page</a>. Le code source complet de cet article est disponible sur la branche <a href="https://github.com/phil-opp/blog_os/tree/post-01"><code>post-01</code></a>.</p>

    <details id = "toc-inline">
        <summary><b>Table des mati√®res</b></summary>
        <ul>
            <li>
                <a href="#introduction">Introduction</a>
                
            </li><li>
                <a href="#desactiver-la-bibliotheque-standard">D√©sactiver la Biblioth√®que Standard</a>
                <ul>
                    <li>
                        <a href="#l-attribut-no-std">L'Attribut no_std</a>
                    </li>
                </ul>
            </li><li>
                <a href="#implementation-de-panic">Impl√©mentation de Panic</a>
                
            </li><li>
                <a href="#l-objet-de-langage-eh-personality">L'Objet de Langage eh_personality</a>
                <ul>
                    <li>
                        <a href="#desactiver-le-deroulement">D√©sactiver le D√©roulement</a>
                    </li>
                </ul>
            </li><li>
                <a href="#l-attribut-start">L'attribut start</a>
                <ul>
                    <li>
                        <a href="#reecrire-le-point-d-entree">R√©√©crire le Point d'Entr√©e</a>
                    </li>
                </ul>
            </li><li>
                <a href="#erreurs-de-linker">Erreurs de Linker</a>
                <ul>
                    <li>
                        <a href="#compiler-pour-une-cible-bare-metal">Compiler pour une Cible Bare Metal</a>
                    </li><li>
                        <a href="#arguments-du-linker">Arguments du Linker</a>
                    </li>
                </ul>
            </li><li>
                <a href="#resume">R√©sum√©</a>
                
            </li><li>
                <a href="#et-ensuite">Et ensuite ?</a>
                
            </li>
            <li class="toc-comments-link"><a href="#comments">Commentaires</a></li>
        </ul>
    </details>

<h2 id="introduction"><a class="zola-anchor" href="#introduction" aria-label="Anchor link for: introduction">üîó</a>Introduction</h2>
<p>Pour √©crire un noyau de syst√®me d'exploitation, nous avons besoin d'un code qui ne d√©pend pas de fonctionnalit√©s de syst√®me d'exploitation. Cela signifie que nous ne pouvons pas utiliser les fils d'ex√©cution, les fichiers, la m√©moire sur le tas, le r√©seau, les nombres al√©atoires, la sortie standard ou tout autre fonctionnalit√© n√©cessitant une abstraction du syst√®me d'exploitation ou un mat√©riel sp√©cifique. Cela a du sens, √©tant donn√© que nous essayons d'√©crire notre propre OS et nos propres pilotes.
Cela signifie que nous ne pouvons pas utiliser la majeure partie de la <a href="https://doc.rust-lang.org/std/">biblioth√®que standard de Rust</a>. Il y a n√©anmoins beaucoup de fonctionnalit√©s de Rust que nous <em>pouvons</em> utiliser. Par exemple, nous pouvons utiliser les <a href="https://doc.rust-lang.org/book/ch13-02-iterators.html">iterators</a>, les <a href="https://doc.rust-lang.org/book/ch13-01-closures.html">closures</a>, le <a href="https://doc.rust-lang.org/book/ch06-00-enums.html">pattern matching</a>, l'<a href="https://doc.rust-lang.org/core/option/">option</a> et le <a href="https://doc.rust-lang.org/core/result/">result</a>, le <a href="https://doc.rust-lang.org/core/macro.write.html">string formatting</a>, et bien-s√ªr l'<a href="https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html">ownership system</a>. Ces fonctionnalit√©s permettent l'√©criture d'un noyeau d'une fa√ßon expressive et haut-niveau sans se soucier des [comportements ind√©finis] ou de la <a href="https://tonyarcieri.com/it-s-time-for-a-memory-safety-intervention">s√©curit√© de la m√©moire</a>.</p>
<p>Pour cr√©er un noyau d'OS en Rust, nous devons cr√©er un ex√©cutable qui peut tourner sans syst√®me d'exploitation sous-jacent. Un tel ex√©cutable est appel√© ‚Äúfreestanding‚Äù (autoport√©) ou ‚Äúbare-metal‚Äù.
Cet article d√©crit les √©tapes n√©cessaires pour cr√©er un ex√©cutable Rust autoport√© et explique pourquoi ces √©tapes sont importantes. Si vous n'√™tes int√©ress√© que par un exemple minimal, vous pouvez <strong><a href="https://os.phil-opp.com/fr/freestanding-rust-binary/#r%C3%A9sum%C3%A9">aller au r√©sum√©</a></strong>.</p>
<h2 id="desactiver-la-bibliotheque-standard"><a class="zola-anchor" href="#desactiver-la-bibliotheque-standard" aria-label="Anchor link for: desactiver-la-bibliotheque-standard">üîó</a>D√©sactiver la Biblioth√®que Standard</h2>
<p>Par d√©faut, tous les crates Rust relient la <a href="https://doc.rust-lang.org/std/">biblioth√®que standard</a>, qui d√©pend du syst√®me d'exploitation pour les fonctionnalit√©s telles que les fils d'ex√©cution, les fichiers ou le r√©seau. Elle d√©pend aussi de la biblioth√®que standard de C <code>libc</code>, qui int√©ragit de pr√®s avec les services de l'OS. Comme notre plan est d'√©crire un syst√®me d'exploitation, nous ne pouvons pas utiliser des biblioth√®ques d√©pendant de l'OS. Nous devons donc d√©sactiver l'inclusion automatique de la biblioth√®que standard en utilisant l'<a href="https://doc.rust-lang.org/1.30.0/book/first-edition/using-rust-without-the-standard-library.html">attribut <code>no std</code></a>.</p>
<p>Nous commencons par cr√©er un nouveau projet d'application cargo. La mani√®re la plus simple de faire est avec la ligne de commande : </p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo new blog_os --bin --edition 2018
</span></code></pre>
<p>J'ai nomm√© le projet <code>blog_os</code>, mais vous pouvez bien-s√ªr choisir le nom qu'il vous convient. Le flag <code>--bin</code> indique que nous voulons cr√©er un ex√©cutable (contrairement √† une biblioth√®que) et le flag <code>--edition 2018</code> indique que nous voulons utiliser l'<a href="https://doc.rust-lang.org/nightly/edition-guide/rust-2018/index.html">√©dition 2018</a> de Rust pour notre crate. Quand nous lan√ßons la commande, cargo cr√©e la structure de r√©pertoire suivante pour nous :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">blog_os
‚îú‚îÄ‚îÄ Cargo.toml
‚îî‚îÄ‚îÄ src
    ‚îî‚îÄ‚îÄ main.rs
</span></code></pre>
<p>Le fichier <code>Cargo.toml</code> contient la configuration de la crate, par exemple le nom de la crate, l'auteur, le num√©ro de <a href="https://semver.org/">versionnage s√©mantique</a> et les d√©pendances. Le fichier <code>src/main.rs</code> contient le module racine de notre crate et notre fonction <code>main</code>. Vous pouvez compiler votre crate avec <code>cargo build</code> et ensuite ex√©cuter l'ex√©cutable compil√© <code>blog_os</code> dans le sous-dossier <code>target/debug</code>.</p>
<h3 id="l-attribut-no-std"><a class="zola-anchor" href="#l-attribut-no-std" aria-label="Anchor link for: l-attribut-no-std">üîó</a>L'Attribut <code>no_std</code></h3>
<p>Pour l'instant, notre crate relie la bilbioth√®que standard implicitement. D√©sactivons cela en ajoutant l'<a href="https://doc.rust-lang.org/1.30.0/book/first-edition/using-rust-without-the-standard-library.html">attribut <code>no std</code></a> : </p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#608b4e;">// main.rs

</span><span style="color:#dcdcdc;">#![no_std]

</span><span style="color:#569cd6;">fn </span><span style="color:#dcdcdc;">main() {
    println!(</span><span style="color:#d69d85;">&quot;Hello, world!&quot;</span><span style="color:#dcdcdc;">);
}
</span></code></pre>
<p>Quand nous essayons maintenant de compiler (avec <code>cargo build)</code>, l'erreur suivante se produit :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">error: cannot find macro `println!` in this scope
 --&gt; src/main.rs:4:5
  |
4 |     println!(&quot;Hello, world!&quot;);
  |     ^^^^^^^
</span></code></pre>
<p>La raison est que la <a href="https://doc.rust-lang.org/std/macro.println.html">macro <code>println</code></a> fait partie de la biblioth√®que standard, que nous ne pouvons plus utiliser. Nous ne pouvons donc plus afficher de texte avec. Cela est logique, car <code>println</code> √©crit dans la <a href="https://fr.wikipedia.org/wiki/Flux_standard#Sortie_standard">sortie standard</a>, qui est un descripteur de fichier sp√©cial fourni par le syst√®me d'eploitation.</p>
<p>Supprimons l'affichage et essayons √† nouveau avec une fonction main vide :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#608b4e;">// main.rs

</span><span style="color:#dcdcdc;">#![no_std]

</span><span style="color:#569cd6;">fn </span><span style="color:#dcdcdc;">main() {}
</span></code></pre><pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">&gt; cargo build
error: `#[panic_handler]` function required, but not found
error: language item required, but not found: `eh_personality`
</span></code></pre>
<p>Maintenant le compilateur a besoin d'une fonction <code>#[panic_handler]</code> et d'un <em>objet de langage</em>.</p>
<h2 id="implementation-de-panic"><a class="zola-anchor" href="#implementation-de-panic" aria-label="Anchor link for: implementation-de-panic">üîó</a>Impl√©mentation de Panic</h2>
<p>L'attribut <code>panic_handler</code> d√©finit la fonction que le compilateur doit appeler lorsqu'un <a href="https://doc.rust-lang.org/stable/book/ch09-01-unrecoverable-errors-with-panic.html">panic</a> arrive. La biblioth√®que standard fournit sa propre fonction de gestion de panic mais dans un environnement <code>no_std</code>, nous avons besoin de le d√©finir nous-m√™mes : </p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#608b4e;">// dans main.rs

</span><span style="color:#569cd6;">use </span><span style="color:#dcdcdc;">core::panic::PanicInfo;

</span><span style="color:#608b4e;">/// Cette fonction est appel√©e √† chaque panic.
</span><span style="color:#dcdcdc;">#[panic_handler]
</span><span style="color:#569cd6;">fn </span><span style="color:#dcdcdc;">panic(_info: </span><span style="color:#569cd6;">&amp;</span><span style="color:#dcdcdc;">PanicInfo) -&gt; </span><span style="color:#569cd6;">! </span><span style="color:#dcdcdc;">{
    </span><span style="color:#569cd6;">loop </span><span style="color:#dcdcdc;">{}
}
</span></code></pre>
<p>Le <a href="https://doc.rust-lang.org/nightly/core/panic/struct.PanicInfo.html">param√®tre <code>PanicInfo</code></a> contient le fichier et la ligne o√π le panic a eu lieu et le message optionnel de panic. La fonction ne devrait jamais retourner quoi que ce soit, elle est donc marqu√©e comme <a href="https://doc.rust-lang.org/1.30.0/book/first-edition/functions.html#diverging-functions">fonction divergente</a> en retournant le <a href="https://doc.rust-lang.org/nightly/std/primitive.never.html">type ‚Äúnever‚Äù</a> <code>!</code>. Nous ne pouvons pas faire grand chose dans cette fonction pour le moment, nous bouclons donc ind√©finiment.</p>
<h2 id="l-objet-de-langage-eh-personality"><a class="zola-anchor" href="#l-objet-de-langage-eh-personality" aria-label="Anchor link for: l-objet-de-langage-eh-personality">üîó</a>L'Objet de Langage <code>eh_personality</code></h2>
<p>Les objets de langage sont des fonctions et des types sp√©ciaux qui sont requis par le compilateur de mani√®re interne. Par exemple, le trait <a href="https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html"><code>Copy</code></a> est un objet de langage qui indique au compilateur quels types poss√®dent la <a href="https://doc.rust-lang.org/nightly/core/marker/trait.Copy.html">s√©mantique copy</a>. Quand nous regardons l'<a href="https://github.com/rust-lang/rust/blob/485397e49a02a3b7ff77c17e4a3f16c653925cb3/src/libcore/marker.rs#L296-L299">impl√©mentation</a> du code, nous pouvons voir qu'il poss√®de l'attribut sp√©cial <code>#[lang = copy]</code> qui le d√©finit comme √©tant un objet de langage.</p>
<p>Bien qu'il soit possible de fournir des impl√©mentations personnalis√©es des objets de langage, cela ne devrait √™tre fait qu'en dernier recours. La raison est que les objets de langages sont des d√©tails d'impl√©mentation tr√®s instables et qui ne sont m√™me pas v√©rifi√©s au niveau de leur type (donc le compilateur ne v√©rifie m√™me pas qu'une fonction poss√®de les bons types d'arguments). Heureusement, il y a une mani√®re plus robuste de corriger l'erreur d'objet de langage ci-dessus.</p>
<p>L'<a href="https://github.com/rust-lang/rust/blob/edb368491551a77d77a48446d4ee88b35490c565/src/libpanic_unwind/gcc.rs#L11-L45">objet de langage <code>eh_personality</code></a> marque une fonction qui est utilis√©e pour l'impl√©mentation du <a href="https://docs.microsoft.com/fr-fr/cpp/cpp/exceptions-and-stack-unwinding-in-cpp?view=msvc-160">d√©roulement de pile</a>. Par d√©faut, Rust utilise le d√©roulement de pile pour ex√©cuter les destructeurs de chaque variable vivante sur la pile en cas de <a href="https://doc.rust-lang.org/stable/book/ch09-01-unrecoverable-errors-with-panic.html">panic</a>. Cela assure que toute la m√©moire utilis√©e est lib√©r√©e et permet au fil d'ex√©cution parent d'attraper la panic et de continuer l'ex√©cution. Le d√©roulement toutefois est un processus compliqu√© et n√©cessite des biblioth√®ques sp√©cifiques √† l'OS (<a href="https://www.nongnu.org/libunwind/">libunwind</a> pour Linux ou <a href="https://docs.microsoft.com/fr-fr/windows/win32/debug/structured-exception-handling">gestion structur√©e des erreurs</a> pour Windows), nous ne voulons donc pas l'utiliser pour notre syst√®me d'exploitation.</p>
<h3 id="desactiver-le-deroulement"><a class="zola-anchor" href="#desactiver-le-deroulement" aria-label="Anchor link for: desactiver-le-deroulement">üîó</a>D√©sactiver le D√©roulement</h3>
<p>Il y a d'autres cas d'utilisation pour lesquels le d√©roulement n'est pas souhait√©. Rust offre donc une option pour <a href="https://github.com/rust-lang/rust/pull/32900">interrompre apr√®s un panic</a>. Cela d√©sactive la g√©n√©ration de symboles de d√©roulement et ainsi r√©duit consid√©rablement la taille de l'ex√©cutable. Il y a de multiples endroit o√π nous pouvons d√©sactiver le d√©roulement. Le plus simple est d'ajouter les lignes suivantes dans notre <code>Cargo.toml</code> :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">[</span><span style="color:#808080;">profile.dev</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">panic </span><span style="color:#dcdcdc;">= </span><span style="color:#d69d85;">&quot;abort&quot;

</span><span style="color:#dcdcdc;">[</span><span style="color:#808080;">profile.release</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">panic </span><span style="color:#dcdcdc;">= </span><span style="color:#d69d85;">&quot;abort&quot;
</span></code></pre>
<p>Cela configure la strat√©gie de panic √† <code>abort</code> pour le profil <code>dev</code> (utilis√© pour <code>cargo build</code>) et le profil <code>release</code> (utilis√© pour <code>cargo build --release</code>). Maintenant l'objet de langage <code>eh_personality</code> ne devrait plus √™tre requis. </p>
<p>Nous avons dor√©navant corrig√© les deux erreurs ci-dessus. Toutefois, si nous essayons de compiler, une autre erreur appara√Æt :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">&gt; cargo build
error: requires `start` lang_item
</span></code></pre>
<p>L'objet de langage <code>start</code> manque √† notre programme. Il d√©finit le point d'entr√©e.</p>
<h2 id="l-attribut-start"><a class="zola-anchor" href="#l-attribut-start" aria-label="Anchor link for: l-attribut-start">üîó</a>L'attribut <code>start</code></h2>
<p>On pourrait penser que la fonction <code>main</code> est la premi√®re fonction appel√©e lorsqu'un programme est ex√©cut√©. Toutefois, la plupart des langages ont un <a href="https://fr.wikipedia.org/wiki/Environnement_d%27ex%C3%A9cution">environnement d'ex√©cution</a> qui est responsable des t√¢ches telles que le ramassage des miettes (ex: dans Java) ou les fils d'ex√©cution logiciel (ex: les goroutines dans Go). Cet environnement doit √™tre appel√© avant <code>main</code> puisqu'il a besoin de s'initialiser.</p>
<p>Dans un ex√©cutable Rust classique qui relie la biblioth√®que standard, l'ex√©cution commence dans une biblioth√®que d'environnement d'ex√©cution C appel√© <code>crt0</code> (‚ÄúC runtime zero‚Äù). Elle configure l'environnement pour une application C. Cela comprend la cr√©ation d'une pile et le placement des arguments dans les bons registres. L'environnement d'ex√©cution C appelle ensuite <a href="https://github.com/rust-lang/rust/blob/bb4d1491466d8239a7a5fd68bd605e3276e97afb/src/libstd/rt.rs#L32-L73">le point d'entr√©e de l'environnement d'ex√©cution de Rust</a>, qui est marqu√© par l'objet de langage <code>start</code>. Rust poss√®de un environnement d'ex√©cution tr√®s minime, qui se charge de petites t√¢ches telles que la configuration des guardes de d√©passement de pile ou l'affichage de la trace d'appels lors d'un panic. L'environnement d'ex√©cution finit par appeler la fonction <code>main</code>.</p>
<p>Notre ex√©cutable autoport√© n'a pas acc√®s √† l'environnement d'ex√©cution de Rust ni √† <code>crt0</code>. Nous avons donc besion de d√©finir notre propre point d'entr√©e. Impl√©menter l'objet de langage <code>start</code> n'aiderait pas car nous aurions toujours besoin de <code>crt0</code>. Nous avons plut√¥t besoin de r√©√©crire le point d'entr√©e de <code>crt0</code> directement.</p>
<h3 id="reecrire-le-point-d-entree"><a class="zola-anchor" href="#reecrire-le-point-d-entree" aria-label="Anchor link for: reecrire-le-point-d-entree">üîó</a>R√©√©crire le Point d'Entr√©e</h3>
<p>Pour indiquer au compilateur que nous ne voulons pas utiliser la cha√Æne de point d'entr√©e normale, nous ajoutons l'attribut <code>#![no_main]</code>. </p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">#![no_std]
#![no_main]

</span><span style="color:#569cd6;">use </span><span style="color:#dcdcdc;">core::panic::PanicInfo;

</span><span style="color:#608b4e;">/// Cette fonction est appel√©e √† chaque panic.
</span><span style="color:#dcdcdc;">#[panic_handler]
</span><span style="color:#569cd6;">fn </span><span style="color:#dcdcdc;">panic(_info: </span><span style="color:#569cd6;">&amp;</span><span style="color:#dcdcdc;">PanicInfo) -&gt; </span><span style="color:#569cd6;">! </span><span style="color:#dcdcdc;">{
    </span><span style="color:#569cd6;">loop </span><span style="color:#dcdcdc;">{}
}
</span></code></pre>
<p>Vous remarquerez peut-√™tre que nous avons retir√© la fonction <code>main</code>. La raison est que la pr√©sence de cette fonction n'a pas de sens sans un environnement d'ex√©cution sous-jacent qui l'appelle. √Ä la place, nous r√©√©crivons le point d'entr√©e du syst√®me d'exploitation avec notre propre fonction <code>_start</code> :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">#[no_mangle]
</span><span style="color:#569cd6;">pub extern </span><span style="color:#d69d85;">&quot;C&quot; </span><span style="color:#569cd6;">fn </span><span style="color:#dcdcdc;">_start() -&gt; </span><span style="color:#569cd6;">! </span><span style="color:#dcdcdc;">{
    </span><span style="color:#569cd6;">loop </span><span style="color:#dcdcdc;">{}
}
</span></code></pre>
<p>En utilisant l'attribut <code>#[no_mangle]</code>, nous d√©sactivons la <a href="https://fr.wikipedia.org/wiki/D%C3%A9coration_de_nom">d√©coration de nom</a> pour assurer que le compilateur Rust cr√©e une fonction avec le nom <code>_start</code>. Sans cet attribut, le compilateur g√©n√®rerait un symbol obscure <code>_ZN3blog_os4_start7hb173fedf945531caE</code> pour donner un nom unique √† chaque fonction. L'attribut est n√©cessaire car nous avons besoin d'indiquer le nom de la fonction de point d'entr√©e √† l'√©diteur de lien (<em>linker</em>) dans l'√©tape suivante.</p>
<p>Nous devons aussi marquer la fonction avec <code>extern C</code> pour indiquer au compilateur qu'il devrait utiliser la <a href="https://fr.wikipedia.org/wiki/Convention_de_nommage">convention de nommage</a> de C pour cette fonction (au lieu de la convention de nommage de Rust non-sp√©cifi√©e). Cette fonction se nomme <code>_start</code> car c'est le nom par d√©faut des points d'entr√©e pour la plupart des syst√®mes.</p>
<p>Le type de retour <code>!</code> signifie que la fonction est divergente, c-√†-d qu'elle n'a pas le droit de retourner quoi que ce soit. Cela est n√©cessaire car le point d'entr√©e n'est pas appel√© par une fonction, mais invoqu√© directement par le syst√®me d'exploitation ou par le chargeur d'amor√ßage. Donc au lieu de retourner une valeur, le point d'entr√©e doit invoquer l'<a href="https://fr.wikipedia.org/wiki/Appel_syst%C3%A8me">appel syst√®me <code>exit</code></a> du syst√®me d'exploitation. Dans notre cas, arr√™ter la machine pourrait √™tre une action convenable, puisqu'il ne reste rien d'autre √† faire si un ex√©cutable autoport√© s'arr√™te. Pour l'instant, nous remplissons la condition en bouclant ind√©finiement.</p>
<p>Quand nous lan√ßons <code>cargo build</code>, nous obtenons une erreur de <em>linker</em>.</p>
<h2 id="erreurs-de-linker"><a class="zola-anchor" href="#erreurs-de-linker" aria-label="Anchor link for: erreurs-de-linker">üîó</a>Erreurs de Linker</h2>
<p>Le linker est un programme qui va transformer le code g√©n√©r√© en ex√©cutable. Comme le format de l'ex√©cutable differt entre Linux, Windows et macOS, chaque syst√®me poss√®de son propre linker qui l√®ve une erreur diff√©rente. La cause fondamentale de cette erreur est la m√™me : la configuration par d√©faut du linker part du principe que notre programme d√©pend de l'environnement d'ex√©cution de C, ce qui n'est pas le cas.</p>
<p>Pour r√©soudre les erreurs, nous devons indiquer au linker qu'il ne doit pas inclure l'environnement d'ex√©cution de C. Nous pouvons faire cela soit en passant un ensemble pr√©cis d'arguments, soit en compilant pour une cible bare metal.</p>
<h3 id="compiler-pour-une-cible-bare-metal"><a class="zola-anchor" href="#compiler-pour-une-cible-bare-metal" aria-label="Anchor link for: compiler-pour-une-cible-bare-metal">üîó</a>Compiler pour une Cible Bare Metal</h3>
<p>Par d√©faut Rust essaie de compiler un ex√©cutable qui est compatible avec l'environnment du syst√®me actuel. Par exemple, si vous utilisez Windows avec <code>x86_64</code>, Rust essaie de compiler un ex√©cutable Windows <code>.exe</code> qui utilises des instructions <code>x86_64</code>. Cet environnement est appel√© syst√®me &quot;h√¥te&quot;.</p>
<p>Pour d√©crire plusieurs environnements, Rust utilise une cha√Æne de caract√®res appel√©e <a href="https://clang.llvm.org/docs/CrossCompilation.html#target-triple"><em>tripl√© cible</em></a>. Vous pouvez voir le tripl√© cible de votre syst√®me h√¥te en lan√ßant la commande <code>rustc --version --verbose</code> :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">rustc 1.35.0-nightly (474e7a648 2019-04-07)
binary: rustc
commit-hash: 474e7a6486758ea6fc761893b1a49cd9076fb0ab
commit-date: 2019-04-07
host: x86_64-unknown-linux-gnu
release: 1.35.0-nightly
LLVM version: 8.0
</span></code></pre>
<p>La sortie ci-dessus provient d'un syst√®me Linux <code>x86_64</code>. Nous pouvons voir que le tripl√© <code>host</code> est <code>x86_64-unknown-linux-gnu</code>, qui inclut l'architecture du CPU (<code>x86_64</code>), le vendeur (<code>unknown</code>), le syst√®me d'exploitation (<code>linux</code>) et l'<a href="https://fr.wikipedia.org/wiki/Application_binary_interface">ABI</a> (<code>gnu</code>).</p>
<p>En compilant pour notre tripl√© h√¥te, le compilateur Rust ainsi que le linker supposent qu'il y a un syst√®me d'exploitation sous-jacent comme Linux ou Windows qui utilise l'environnement d'ex√©cution C par d√©faut, ce qui cause les erreurs de linker. Donc pour √©viter ces erreurs, nous pouvons compiler pour un environnement diff√©rent sans syst√®me d'exploitation sous-jacent.</p>
<p>Un exemple d'un tel envrironnement est le tripl√© cible <code>thumbv7em-none-eabihf</code>, qui d√©crit un syst√®me <a href="https://fr.wikipedia.org/wiki/Architecture_ARM">ARM</a> <a href="https://fr.wikipedia.org/wiki/Syst%C3%A8me_embarqu%C3%A9">embarqu√©</a>. Les d√©tails ne sont pas importants, tout ce qui compte est que le tripl√© cible n'a pas de syst√®me d'exploitation sous-jacent, ce qui est indiqu√© par le <code>none</code> dans le tripl√© cible. Pour pouvoir compil√© pour cette cible, nous avons besoin de l'ajouter dans rustup :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">rustup target add thumbv7em-none-eabihf
</span></code></pre>
<p>Cela t√©l√©charge une copie de la biblioth√®que standard (et core) pour le syst√®me. Maintenant nous pouvons compiler notre ex√©cutable autoport√© pour cette cible :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo build --target thumbv7em-none-eabihf
</span></code></pre>
<p>En donnant un argument <code>--target</code>, nous effectuons une [compilation crois√©e][cross_compile] de notre ex√©cutable pour un syst√®me bare metal. Comme le syst√®me cible n'a pas de syst√®me d'exploitation, le linker n'essaie pas de lier l'environnement d'ex√©cution C et notre compilation r√©ussit sans erreur de linker.</p>
<p>C'est l'approche que nous allons utiliser pour construire notre noyau d'OS. Plut√¥t que <code>thumbv7em-none-eabihf</code>, nous allons utiliser une <a href="https://doc.rust-lang.org/rustc/targets/custom.html">cible personnalis√©e</a> qui d√©crit un environnement bare metal <code>x86_64</code>. Les d√©tails seront expliqu√©s dans le prochain article.</p>
<h3 id="arguments-du-linker"><a class="zola-anchor" href="#arguments-du-linker" aria-label="Anchor link for: arguments-du-linker">üîó</a>Arguments du Linker</h3>
<p>Au lieu de compiler pour un syst√®me bare metal, il est aussi possible de r√©soudre les erreurs de linker en passant un ensemble pr√©cis d'arguments au linker. Ce n'est pas l'approche que nous allons utiliser pour notre noyau. Cette section est donc optionnelle et fournis uniquement √† titre de compl√©tude. Cliquez sur <em>&quot;Arguments du Linker&quot;</em> ci-dessous pour montrer le contenu optionel.</p>
<details>
<summary>Arguments du Linker</summary>
<p>Dans cette section nous allons parler des erreurs de linker qui se produisent sur Linux, Windows et macOS. Nous allons aussi apprendre √† r√©soudre ces erreurs en passant des arguments compl√©mentaires au linker. √Ä noter que le format de l'ex√©cutable et le linker diff√®rent entre les syst√®mes d'exploitation. Il faut donc un ensemble d'arguments diff√©rent pour chaque syst√®me.</p>
<h4 id="linux"><a class="zola-anchor" href="#linux" aria-label="Anchor link for: linux">üîó</a>Linux</h4>
<p>Sur Linux, voici l'erreur de linker qui se produit (raccourcie) :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">error: linking with `cc` failed: exit code: 1
  |
  = note: &quot;cc&quot; [‚Ä¶]
  = note: /usr/lib/gcc/../x86_64-linux-gnu/Scrt1.o: In function `_start&#39;:
          (.text+0x12): undefined reference to `__libc_csu_fini&#39;
          /usr/lib/gcc/../x86_64-linux-gnu/Scrt1.o: In function `_start&#39;:
          (.text+0x19): undefined reference to `__libc_csu_init&#39;
          /usr/lib/gcc/../x86_64-linux-gnu/Scrt1.o: In function `_start&#39;:
          (.text+0x25): undefined reference to `__libc_start_main&#39;
          collect2: error: ld returned 1 exit status
</span></code></pre>
<p>Le probl√®me est que le linker inclut par d√©faut la routine de d√©marrage de l'environnement d'ex√©cution de C, qui est aussi appel√©e <code>_start</code>. Elle requiert des symboles de la biblioth√®que standard de C <code>libc</code> que nous n'incluons pas √† cause de l'attribut <code>no_std</code>. Le linker ne peut donc pas r√©soudre ces r√©f√©rences. Pour r√©soudre cela, nous pouvons indiquer au linker qu'il ne devrait pas lier la routine de d√©marrage de C en passant l'argument <code>-nostartfiles</code>.</p>
<p>Une fa√ßon de passer des attributs au linker via cargo est la commande <code>cargo rustc</code>. Cette commande se comporte exactement comme <code>cargo build</code>, mais permet aussi de donner des options √† <code>rustc</code>, le compilateur Rust sous-jacent. <code>rustc</code> poss√®de le flag <code>-C link-arg</code>, qui donne un argument au linker. Combin√©s, notre nouvelle commande ressemble √† ceci :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo rustc -- -C link-arg=-nostartfiles
</span></code></pre>
<p>Dor√©navant notre crate compile en tant qu'ex√©cutable Linux autoport√© !</p>
<p>Nous n'avions pas besoin de sp√©cifier le nom de notre point d'entr√©e de fa√ßon explicite car le linker cherche par d√©faut une fonction nomm√©e <code>_start</code>. </p>
<h4 id="windows"><a class="zola-anchor" href="#windows" aria-label="Anchor link for: windows">üîó</a>Windows</h4>
<p>Sur Windows, une erreur de linker diff√©rente se produit (raccourcie) :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">error: linking with `link.exe` failed: exit code: 1561
  |
  = note: &quot;C:\\Program Files (x86)\\‚Ä¶\\link.exe&quot; [‚Ä¶]
  = note: LINK : fatal error LNK1561: entry point must be defined
</span></code></pre>
<p>Cette erreur signifie que le linker ne peut pas trouver le point d'entr√©e. Sur Windows, le nom par d√©faut du point d'entr√©e <a href="https://docs.microsoft.com/fr-fr/cpp/build/reference/entry-entry-point-symbol?view=msvc-160">d√©pend du sous-syst√®me utilis√©</a>. Pour le sous-syst√®me <code>CONSOLE</code>, le linker cherche une fonction nomm√©e <code>mainCRTStartup</code> et pour le sous-syst√®me <code>WINDOWS</code>, il cherche une fonction nom√©e <code>WinMainCRTStartup</code>. Pour r√©√©crire la valeur par d√©faut et indiquer au linker de chercher notre fonction <code>_start</code> √† la place, nous pouvons donner l'argument <code>/ENTRY</code> au linker :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo rustc -- -C link-arg=/ENTRY:_start
</span></code></pre>
<p>Vu le format d'argument diff√©rent nous pouvons clairement voir que le linker Windows est un programme totalement diff√©rent du linker Linux.</p>
<p>Maintenant une erreur de linker diff√©rente se produit :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">error: linking with `link.exe` failed: exit code: 1221
  |
  = note: &quot;C:\\Program Files (x86)\\‚Ä¶\\link.exe&quot; [‚Ä¶]
  = note: LINK : fatal error LNK1221: a subsystem can&#39;t be inferred and must be
          defined
</span></code></pre>
<p>Cette erreur se produit car les ex√©cutables Windows peuvent utiliser diff√©rents <a href="https://docs.microsoft.com/fr-fr/cpp/build/reference/entry-entry-point-symbol?view=msvc-160">sous-syst√®mes</a>. Pour les programmes normaux, ils sont inf√©r√©s en fonction du nom du point d'entr√©e : s'il est nomm√© <code>main</code>, le sous-syst√®me <code>CONSOLE</code> est utilis√©. Si le point d'entr√©e est nomm√© <code>WinMain</code>, alors le sous-syt√®me <code>WINDOWS</code> est utilis√©.  Comme notre fonction <code>_start</code> poss√®de un nom diff√©rent, nous devons pr√©ciser le sous-syst√®me explicitement :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo rustc -- -C link-args=&quot;/ENTRY:_start /SUBSYSTEM:console&quot;
</span></code></pre>
<p>Ici nous utilisons le sous-syst√®me <code>CONSOLE</code>, mais le sous-syst√®me <code>WINDOWS</code> pourrait fonctionner aussi. Au lieu de donner <code>-C link-arg</code> plusieurs fois, nous utilisons <code>-C link-args</code> qui utilise des arguments s√©par√©s par des espaces.</p>
<p>Avec cette commande, notre ex√©cutable devrait compiler avec succ√®s sous Windows.</p>
<h4 id="macos"><a class="zola-anchor" href="#macos" aria-label="Anchor link for: macos">üîó</a>macOS</h4>
<p>Sur macOS, voici l'erreur de linker qui se produit (raccourcie) :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">error: linking with `cc` failed: exit code: 1
  |
  = note: &quot;cc&quot; [‚Ä¶]
  = note: ld: entry point (_main) undefined. for architecture x86_64
          clang: error: linker command failed with exit code 1 [‚Ä¶]
</span></code></pre>
<p>Cette erreur nous indique que le linker ne peut pas trouver une fonction de point d'entr√©e avec le nom par d√©faut <code>main</code> (pour une quelconque raison, toutes les fonctions sur macOS sont pr√©c√©d√©es de <code>_</code>). Pour configurer le point d'entr√©e sur notre fonction <code>_start</code>, nous donnons l'argument <code>-e</code> au linker :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo rustc -- -C link-args=&quot;-e __start&quot;
</span></code></pre>
<p>L'argument <code>-e</code> sp√©cifie le nom de la fonction de point d'entr√©e. Comme toutes les fonctions ont un pr√©fixe suppl√©mentaire <code>_</code> sur macOS, nous devons configurer le point d'entr√©e comme √©tant <code>__start</code> au lieu de <code>_start</code>.</p>
<p>Maintenant l'erreur de linker suivante se produit :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">error: linking with `cc` failed: exit code: 1
  |
  = note: &quot;cc&quot; [‚Ä¶]
  = note: ld: dynamic main executables must link with libSystem.dylib
          for architecture x86_64
          clang: error: linker command failed with exit code 1 [‚Ä¶]
</span></code></pre>
<p>macOS <a href="https://developer.apple.com/library/archive/qa/qa1118/_index.html">ne supporte pas officiellement les biblioth√®ques li√©es de fa√ßon statique</a> et nec√©essite que les programmes lient la biblioth√®que <code>libSystem</code> par d√©faut. Pour r√©√©crire ceci et lier une biblioth√®que statique, nous donnons l'argument <code>-static</code> au linker :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo rustc -- -C link-args=&quot;-e __start -static&quot;
</span></code></pre>
<p>Cela ne suffit toujours pas, une troisi√®me erreur de linker se produit :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">error: linking with `cc` failed: exit code: 1
  |
  = note: &quot;cc&quot; [‚Ä¶]
  = note: ld: library not found for -lcrt0.o
          clang: error: linker command failed with exit code 1 [‚Ä¶]
</span></code></pre>
<p>Cette erreur se produit car les programmes sous macOS lient <code>crt0</code> (‚ÄúC runtime zero‚Äù) par d√©faut. Ceci est similaire √† l'erreur que nous avions eu sous Linux et peut aussi √™tre r√©solue en ajoutant l'argument <code>-nostartfiles</code> au linker :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo rustc -- -C link-args=&quot;-e __start -static -nostartfiles&quot;
</span></code></pre>
<p>Maintenant notre programme compile avec succ√®s sous macOS.</p>
<h4 id="unifier-les-commandes-de-compilation"><a class="zola-anchor" href="#unifier-les-commandes-de-compilation" aria-label="Anchor link for: unifier-les-commandes-de-compilation">üîó</a>Unifier les Commandes de Compilation</h4>
<p>√Ä cet instant nous avons diff√©rentes commandes de compilation en fonction de la plateforme h√¥te, ce qui n'est pas id√©al. Pour √©viter cela, nous pouvons cr√©er un ficher nomm√© <code>.cargo/config.toml</code> qui contient les arguments sp√©cifiques aux plateformes :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#608b4e;"># dans .cargo/config.toml

</span><span style="color:#dcdcdc;">[</span><span style="color:#808080;">target.</span><span style="color:#d69d85;">&#39;cfg(target_os = &quot;linux&quot;)&#39;</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">rustflags </span><span style="color:#dcdcdc;">= [</span><span style="color:#d69d85;">&quot;-C&quot;</span><span style="color:#dcdcdc;">, </span><span style="color:#d69d85;">&quot;link-arg=-nostartfiles&quot;</span><span style="color:#dcdcdc;">]

[</span><span style="color:#808080;">target.</span><span style="color:#d69d85;">&#39;cfg(target_os = &quot;windows&quot;)&#39;</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">rustflags </span><span style="color:#dcdcdc;">= [</span><span style="color:#d69d85;">&quot;-C&quot;</span><span style="color:#dcdcdc;">, </span><span style="color:#d69d85;">&quot;link-args=/ENTRY:_start /SUBSYSTEM:console&quot;</span><span style="color:#dcdcdc;">]

[</span><span style="color:#808080;">target.</span><span style="color:#d69d85;">&#39;cfg(target_os = &quot;macos&quot;)&#39;</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">rustflags </span><span style="color:#dcdcdc;">= [</span><span style="color:#d69d85;">&quot;-C&quot;</span><span style="color:#dcdcdc;">, </span><span style="color:#d69d85;">&quot;link-args=-e __start -static -nostartfiles&quot;</span><span style="color:#dcdcdc;">]
</span></code></pre>
<p>La cl√© <code>rustflags</code> contient des arguments qui sont automatiquement ajout√©s √† chaque appel de <code>rustc</code>. Pour plus d'informations sur le fichier <code>.cargo/config.toml</code>, allez voir la <a href="https://doc.rust-lang.org/cargo/reference/config.html">documentation officielle</a></p>
<p>Maintenant notre programme devrait √™tre compilable sur les trois plateformes avec un simple <code>cargo build</code>.</p>
<h4 id="devriez-vous-faire-ca"><a class="zola-anchor" href="#devriez-vous-faire-ca" aria-label="Anchor link for: devriez-vous-faire-ca">üîó</a>Devriez-vous Faire √áa ?</h4>
<p>Bien qu'il soit possible de compiler un ex√©cutable autoport√© pour Linux, Windows et macOS, ce n'est probablement pas une bonne id√©e. La raison est que notre ex√©cutable s'attend toujours √† trouver certaines choses, par exemple une pile initialis√©e lorsque la fonction <code>_start</code> est appel√©e. Sans l'environnement d'ex√©cution C, certains de ces conditions peuvent ne pas √™tre remplies, ce qui pourrait faire planter notre programme, avec par exemple une erreur de segmentation.</p>
<p>Si vous voulez cr√©er un ex√©cutable minimal qui tourne sur un syst√®me d'exploitation existant, include <code>libc</code> et mettre l'attribut <code>#[start]</code> come d√©crit <a href="https://doc.rust-lang.org/1.16.0/book/no-stdlib.html">ici</a> semble √™tre une meilleure id√©e.</p>
</details>
<h2 id="resume"><a class="zola-anchor" href="#resume" aria-label="Anchor link for: resume">üîó</a>R√©sum√©</h2>
<p>Un ex√©cutable Rust autoport√© minimal ressemble √† ceci :</p>
<p><code>src/main.rs</code>:</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">#![no_std] </span><span style="color:#608b4e;">// ne pas lier la biblioth√®que standard Rust
</span><span style="color:#dcdcdc;">#![no_main] </span><span style="color:#608b4e;">// d√©sactiver tous les points d&#39;entr√©e au niveau de Rust

</span><span style="color:#569cd6;">use </span><span style="color:#dcdcdc;">core::panic::PanicInfo;

#[no_mangle] </span><span style="color:#608b4e;">// ne pas d√©corer le nom de cette fonction
</span><span style="color:#569cd6;">pub extern </span><span style="color:#d69d85;">&quot;C&quot; </span><span style="color:#569cd6;">fn </span><span style="color:#dcdcdc;">_start() -&gt; </span><span style="color:#569cd6;">! </span><span style="color:#dcdcdc;">{
    </span><span style="color:#608b4e;">// cette fonction est le point d&#39;entr√©e, comme le linker cherche une fonction
    // nom√©e `_start` par d√©faut
    </span><span style="color:#569cd6;">loop </span><span style="color:#dcdcdc;">{}
}

</span><span style="color:#608b4e;">/// Cette fonction est appel√©e √† chaque panic.
</span><span style="color:#dcdcdc;">#[panic_handler]
</span><span style="color:#569cd6;">fn </span><span style="color:#dcdcdc;">panic(_info: </span><span style="color:#569cd6;">&amp;</span><span style="color:#dcdcdc;">PanicInfo) -&gt; </span><span style="color:#569cd6;">! </span><span style="color:#dcdcdc;">{
    </span><span style="color:#569cd6;">loop </span><span style="color:#dcdcdc;">{}
}
</span></code></pre>
<p><code>Cargo.toml</code>:</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">[</span><span style="color:#808080;">package</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">name </span><span style="color:#dcdcdc;">= </span><span style="color:#d69d85;">&quot;crate_name&quot;
</span><span style="color:#569cd6;">version </span><span style="color:#dcdcdc;">= </span><span style="color:#d69d85;">&quot;0.1.0&quot;
</span><span style="color:#569cd6;">authors </span><span style="color:#dcdcdc;">= [</span><span style="color:#d69d85;">&quot;Author Name &lt;author@example.com&gt;&quot;</span><span style="color:#dcdcdc;">]

</span><span style="color:#608b4e;"># le profile utilis√© pour `cargo build`
</span><span style="color:#dcdcdc;">[</span><span style="color:#808080;">profile.dev</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">panic </span><span style="color:#dcdcdc;">= </span><span style="color:#d69d85;">&quot;abort&quot; </span><span style="color:#608b4e;"># d√©sactive le d√©roulement de la pile lors d&#39;un panic

# le profile utilis√© pour `cargo build --release`
</span><span style="color:#dcdcdc;">[</span><span style="color:#808080;">profile.release</span><span style="color:#dcdcdc;">]
</span><span style="color:#569cd6;">panic </span><span style="color:#dcdcdc;">= </span><span style="color:#d69d85;">&quot;abort&quot; </span><span style="color:#608b4e;"># d√©sactive le d√©roulement de la pile lors d&#39;un panic
</span></code></pre>
<p>Pour compiler cet ex√©cutable, nous devons compiler pour une cible bare metal telle que <code>thumbv7em-none-eabihf</code> :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#dcdcdc;">cargo build --target thumbv7em-none-eabihf
</span></code></pre>
<p>Sinon, nous pouvons aussi compiler pour le syst√®me h√¥te en donnant des arguments suppl√©mentaires pour le linker :</p>
<pre style="background-color:#1e1e1e;">
<code><span style="color:#608b4e;"># Linux
</span><span style="color:#dcdcdc;">cargo rustc</span><span style="color:#569cd6;"> --</span><span style="color:#dcdcdc;"> -C link-arg=-nostartfiles
</span><span style="color:#608b4e;"># Windows
</span><span style="color:#dcdcdc;">cargo rustc -- -C link-args=</span><span style="color:#d69d85;">&quot;/ENTRY:_start /SUBSYSTEM:console&quot;
</span><span style="color:#608b4e;"># macOS
</span><span style="color:#dcdcdc;">cargo rustc -- -C link-args=</span><span style="color:#d69d85;">&quot;-e __start -static -nostartfiles&quot;
</span></code></pre>
<p>√Ä noter que ceci est juste un exemple minimal d'un ex√©cutable Rust autoport√©. Cet ex√©cutable s'attend √† de nombreuses choses, comme par exemple le fait qu'une pile soit initialis√©e lorsque la fonction <code>_start</code> est appel√©e. <strong>Donc pour une r√©elle utilisation d'un tel ex√©cutable, davantages d'√©tapes sont requises.</strong></p>
<h2 id="et-ensuite"><a class="zola-anchor" href="#et-ensuite" aria-label="Anchor link for: et-ensuite">üîó</a>Et ensuite ?</h2>
<p>Le <a href="https://os.phil-opp.com/minimal-rust-kernel/">poste suivant</a> explique les √©tapes n√©cessaires pour transformer notre ex√©cutable autoport√© minimal en noyau de syst√®me d'op√©ration. Cela comprend la cr√©ation d'une cible personnalis√©e, l'int√©gration de notre ex√©cutable avec un chargeur d'amor√ßage et l'apprentissage de comment imprimer quelque chose sur l'√©cran.</p>

    </div>

    <div class="post-footer-support">
        <h2>Support Me</h2>
        
<p>
    Creating and <a href="https:&#x2F;&#x2F;os.phil-opp.com&#x2F;status-update&#x2F;">maintaining</a> this blog and the associated libraries is a lot of work, but I really enjoy doing it. By supporting me, you allow me to invest more time in new content, new features, and continuous maintenance.
</p>
<p>
    The best way to support me is to <a href="https://github.com/sponsors/phil-opp"><em>sponsor me on GitHub</em></a>, since they don't charge any fees. If you prefer other platforms, I also have <a href="https://www.patreon.com/phil_opp"><em>Patreon</em></a> and <a href="https://donorbox.org/phil-opp"><em>Donorbox</em></a> accounts. The latter is the most flexible as it supports multiple currencies and one-time contributions.
</p>
<p>
    Thank you!
</p>

    </div>

    <hr>
    <div class="PageNavigation">
        
        
    </div>

    <hr>
    <section>
        <h2 id="comments" class="">Commentaires</h2>

        
            
            
            
        
        
    
        
    

    <p class="comment-note">
        Do you have a problem, want to share feedback, or discuss further ideas? Feel free to leave a comment here! Please stick to English and follow Rust's <a href="https://www.rust-lang.org/policies/code-of-conduct">code of conduct</a>. This comment thread directly maps to a <a href="https:&#x2F;&#x2F;github.com&#x2F;phil-opp&#x2F;blog_os&#x2F;discussions&#x2F;categories&#x2F;post-comments?discussions_q=&quot;A Freestanding Rust Binary (fr)&quot;"><em>discussion on GitHub</em></a>, so you can also comment there if you prefer.
    </p>

    <div class="giscus"></div>

    <script src="https://giscus.app/client.js"
        data-repo="phil-opp/blog_os"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzOTU3NTEwMQ=="
        data-category="Post Comments"
        data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDE4OTg1"
    
        data-mapping="specific"
    
        data-term="A Freestanding Rust Binary (fr)"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-theme="preferred_color_scheme"
        crossorigin="anonymous"
        async>
    </script>

    <p class="comment-directly-on-github">
        Instead of authenticating the <a href="https://giscus.app">giscus</a> application, you can also comment directly <a href="https:&#x2F;&#x2F;github.com&#x2F;phil-opp&#x2F;blog_os&#x2F;discussions&#x2F;categories&#x2F;post-comments?discussions_q=&quot;A Freestanding Rust Binary (fr)&quot;"><em>on GitHub</em></a>.
    </p>

        <p class="">
            Veuillez commenter en Anglais si possible.
        </p>
        
    </section>

    <aside class="page-aside-right">
        <div class="block" id="language-selector">
            <h2>Other Languages</h2>
            <ul>
                <li data-lang-switch-to="en" class=""><a href="https://os.phil-opp.com/freestanding-rust-binary/">English (original)</a></li>
            
                <li data-lang-switch-to="fa" class=""><a href="https://os.phil-opp.com/fa/freestanding-rust-binary/">Persian</a></li>
            
                <li data-lang-switch-to="ja" class=""><a href="https://os.phil-opp.com/ja/freestanding-rust-binary/">Japanese</a></li>
            
                <li data-lang-switch-to="ru" class=""><a href="https://os.phil-opp.com/ru/freestanding-rust-binary/">Russian</a></li>
            
                <li data-lang-switch-to="zh-CN" class=""><a href="https://os.phil-opp.com/zh-CN/freestanding-rust-binary/">Chinese (simplified)</a></li>
            
                <li data-lang-switch-to="zh-TW" class=""><a href="https://os.phil-opp.com/zh-TW/freestanding-rust-binary/">Chinese (traditional)</a></li>
            </ul>
        </div>

        
<div class="dark-mode-note warning">
    <h2>Dark Mode is Experimental</h2>
    <p>
        We're still working on adjusting text colors, fixing images, and removing inconsistencies. If you have any problems, please <a href="https://github.com/phil-opp/blog_os/issues">file an issue</a>.
    </p>
</aside>

    </aside>

</main>
        </div>

        <div></div>

        <footer class="footer">
            <hr>
            <small>
                &copy; <time datetime="2021">2021</time>. All rights reserved.
                <a href="https://os.phil-opp.com/contact/">Contact</a>
            </small>
        </footer>
    </div>

    <script data-goatcounter="https://phil-opp.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>
