<!doctype html><html lang=en><head><meta charset=UTF-8><meta content=yes name=apple-mobile-web-app-capable><meta content="width=device-width,initial-scale=1" name=viewport><meta content="This blog series creates a small operating system in the Rust programming language. Each post is a small tutorial and includes all needed code." name=description><meta content="Philipp Oppermann" name=author><link href=/css/edition-1/poole.css rel=stylesheet><link href=/css/edition-1/main.css rel=stylesheet><link href=/css/edition-1/isso.css rel=stylesheet><script async src=/js/edition-1/main.js></script><title>Page Tables | Writing an OS in Rust (First Edition)</title><body><div class="container content"><header class=masthead><h2 class=masthead-title><a href=/edition-1 title=Home>Writing an OS in Rust (First Edition)</a></h2><p><small>Philipp¬†Oppermann's¬†blog</small></header><main><h1>Page Tables</h1><time class=post-date datetime=2015-12-09> Dec 09, 2015 </time><aside id=toc-aside><h2>Table of Contents</h2><ol><li><a href=#paging>Paging</a><li><a href=#a-basic-paging-module>A Basic Paging Module</a> <ol><li><a href=#page-table-entries>Page Table Entries</a><li><a href=#page-tables>Page Tables</a></ol><li><a href=#mapping-page-tables>Mapping Page Tables</a> <ol><li><a href=#recursive-mapping>Recursive Mapping</a><li><a href=#implementation>Implementation</a><li><a href=#the-next-table-methods>The next_table Methods</a></ol><li><a href=#some-clever-solution>Some Clever Solution</a><li><a href=#translating-addresses>Translating Addresses</a> <ol><li><a href=#safety-1>Safety</a><li><a href=#huge-pages>Huge Pages</a></ol><li><a href=#mapping-pages>Mapping Pages</a> <ol><li><a href=#safety-2>Safety</a><li><a href=#page-table-ownership>Page Table Ownership</a><li><a href=#more-mapping-functions>More Mapping Functions</a><li><a href=#unmapping-pages>Unmapping Pages</a></ol><li><a href=#testing-and-bugfixing>Testing and Bugfixing</a> <ol><li><a href=#map-to>map_to</a><li><a href=#unmap>unmap</a></ol><li><a href=#conclusion>Conclusion</a><li><a href=#what-s-next>What‚Äôs next?</a><li><a href=#footnotes>Footnotes</a></ol></aside><div class=warning><b>No longer updated!</b> You are viewing the a post of the first edition of ‚ÄúWriting an OS in Rust‚Äù, which is no longer updated. You can find the second edition <a href=https://os.phil-opp.com/edition-2/>here</a>.</div><p>In this post we will create a paging module, which allows us to access and modify the 4-level page table. We will explore recursive page table mapping and use some Rust features to make it safe. Finally we will create functions to translate virtual addresses and to map and unmap pages.</p><span id=continue-reading></span><p>You can find the source code and this post itself on <a href=https://github.com/phil-opp/blog_os/tree/first_edition_post_6>GitHub</a>. Please file an issue there if you have any problems or improvement suggestions. There is also a comment section at the end of this page. Note that this post requires a current Rust nightly.<h2 id=paging><a aria-label="Anchor link for: paging" class=zola-anchor href=#paging>üîó</a>Paging</h2><p><em>Paging</em> is a memory management scheme that separates virtual and physical memory. The address space is split into equal sized <em>pages</em> and <em>page tables</em> specify which virtual page points to which physical frame. For an extensive paging introduction take a look at the paging chapter (<a href=http://pages.cs.wisc.edu/%7Eremzi/OSTEP/vm-paging.pdf>PDF</a>) of the <a href=http://pages.cs.wisc.edu/%7Eremzi/OSTEP/>Three Easy Pieces</a> OS book.<p>The x86 architecture uses a 4-level page table in 64-bit mode. A virtual address has the following structure:<p><img alt="structure of a virtual address on x86" src=x86_address_structure.svg><p>The bits 48‚Äì63 are so-called <em>sign extension</em> bits and must be copies of bit 47. The following 36 bits define the page table indexes (9 bits per table) and the last 12 bits specify the offset in the 4KiB page.<p>Each table has 2^9 = 512 entries and each entry is 8 byte. Thus a page table fits exactly in one page (4 KiB).<p>To translate an address, the CPU reads the P4 address from the CR3 register. Then it uses the indexes to walk the tables:<p><img alt="translation of virtual to physical addresses in 64 bit mode" src=X86_Paging_64bit.svg><p>The P4 entry points to a P3 table, where the next 9 bits of the address are used to select an entry. The P3 entry then points to a P2 table and the P2 entry points to a P1 table. The P1 entry, which is specified through bits 12‚Äì20, finally points to the physical frame.<h2 id=a-basic-paging-module><a aria-label="Anchor link for: a-basic-paging-module" class=zola-anchor href=#a-basic-paging-module>üîó</a>A Basic Paging Module</h2><p>Let‚Äôs create a basic paging module in <code>memory/paging/mod.rs</code>:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>memory::</span><span style=color:#b4cea8;>PAGE_SIZE</span><span>; </span><span style=color:#608b4e;>// needed later
</span><span>
</span><span style=color:#569cd6;>const </span><span style=color:#b4cea8;>ENTRY_COUNT</span><span>: </span><span style=color:#569cd6;>usize </span><span>= </span><span style=color:#b5cea8;>512</span><span>;
</span><span>
</span><span style=color:#569cd6;>pub type </span><span style=color:#4ec9b0;>PhysicalAddress </span><span>= </span><span style=color:#569cd6;>usize</span><span>;
</span><span style=color:#569cd6;>pub type </span><span style=color:#4ec9b0;>VirtualAddress </span><span>= </span><span style=color:#569cd6;>usize</span><span>;
</span><span>
</span><span style=color:#569cd6;>pub struct </span><span>Page {
</span><span>   number: </span><span style=color:#569cd6;>usize</span><span>,
</span><span>}
</span></code></pre><p>We import the <code>PAGE_SIZE</code> and define a constant for the number of entries per table. To make future function signatures more expressive, we can use the type aliases <code>PhysicalAddress</code> and <code>VirtualAddress</code>. The <code>Page</code> struct is similar to the <code>Frame</code> struct in the <a href=https://os.phil-opp.com/allocating-frames/#a-memory-module>previous post</a>, but represents a virtual page instead of a physical frame.<h3 id=page-table-entries><a aria-label="Anchor link for: page-table-entries" class=zola-anchor href=#page-table-entries>üîó</a>Page Table Entries</h3><p>To model page table entries, we create a new <code>entry</code> submodule:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>memory::Frame; </span><span style=color:#608b4e;>// needed later
</span><span>
</span><span style=color:#569cd6;>pub struct </span><span>Entry(</span><span style=color:#569cd6;>u64</span><span>);
</span><span>
</span><span style=color:#569cd6;>impl </span><span>Entry {
</span><span>    </span><span style=color:#569cd6;>pub fn </span><span>is_unused(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>bool </span><span>{
</span><span>        self.</span><span style=color:#b5cea8;>0 </span><span>== </span><span style=color:#b5cea8;>0
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#569cd6;>pub fn </span><span>set_unused(</span><span style=color:#569cd6;>&mut </span><span>self) {
</span><span>        self.</span><span style=color:#b5cea8;>0 </span><span>= </span><span style=color:#b5cea8;>0</span><span>;
</span><span>    }
</span><span>}
</span></code></pre><p>We define that an unused entry is completely 0. That allows us to distinguish unused entries from other non-present entries in the future. For example, we could define one of the available bits as the <code>swapped_out</code> bit for pages that are swapped to disk.<p>Next we will model the contained physical address and the various flags. Remember, entries have the following format:<table><thead><tr><th>Bit(s)<th>Name<th>Meaning<tbody><tr><td>0<td>present<td>the page is currently in memory<tr><td>1<td>writable<td>it‚Äôs allowed to write to this page<tr><td>2<td>user accessible<td>if not set, only kernel mode code can access this page<tr><td>3<td>write through caching<td>writes go directly to memory<tr><td>4<td>disable cache<td>no cache is used for this page<tr><td>5<td>accessed<td>the CPU sets this bit when this page is used<tr><td>6<td>dirty<td>the CPU sets this bit when a write to this page occurs<tr><td>7<td>huge page/null<td>must be 0 in P1 and P4, creates a 1GiB page in P3, creates a 2MiB page in P2<tr><td>8<td>global<td>page isn‚Äôt flushed from caches on address space switch (PGE bit of CR4 register must be set)<tr><td>9-11<td>available<td>can be used freely by the OS<tr><td>12-51<td>physical address<td>the page aligned 52bit physical address of the frame or the next page table<tr><td>52-62<td>available<td>can be used freely by the OS<tr><td>63<td>no execute<td>forbid executing code on this page (the NXE bit in the EFER register must be set)</table><p>To model the various flags, we will use the <a href=https://github.com/rust-lang-nursery/bitflags>bitflags</a> crate. To add it as a dependency, add the following to your <code>Cargo.toml</code>:<pre class=language-toml data-lang=toml style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-toml data-lang=toml><span>[</span><span style=color:#808080;>dependencies</span><span>]
</span><span style=color:#ff3333;>...
</span><span style=color:#569cd6;>bitflags </span><span>= </span><span style=color:#d69d85;>"0.9.1"
</span></code></pre><p>To import the macro, we need to use <code>#[macro_use]</code> above the <code>extern crate</code> definition:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#608b4e;>// in src/lib.rs
</span><span>#[macro_use]
</span><span style=color:#569cd6;>extern crate</span><span> bitflags;
</span></code></pre><p>Now we can model the various flags:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span>bitflags! {
</span><span>    </span><span style=color:#569cd6;>pub struct </span><span>EntryFlags: u64 {
</span><span>        const PRESENT =         1 << 0;
</span><span>        const WRITABLE =        1 << 1;
</span><span>        const USER_ACCESSIBLE = 1 << 2;
</span><span>        const WRITE_THROUGH =   1 << 3;
</span><span>        const NO_CACHE =        1 << 4;
</span><span>        const ACCESSED =        1 << 5;
</span><span>        const DIRTY =           1 << 6;
</span><span>        const HUGE_PAGE =       1 << 7;
</span><span>        const GLOBAL =          1 << 8;
</span><span>        const NO_EXECUTE =      1 << 63;
</span><span>    }
</span><span>}
</span></code></pre><p>To extract the flags from the entry we create an <code>Entry::flags</code> method that uses <a href=https://docs.rs/bitflags/0.9.1/bitflags/example_generated/struct.Flags.html#method.from_bits_truncate>from_bits_truncate</a>:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>flags(</span><span style=color:#569cd6;>&</span><span>self) -> EntryFlags {
</span><span>    EntryFlags::from_bits_truncate(self.</span><span style=color:#b5cea8;>0</span><span>)
</span><span>}
</span></code></pre><p>This allows us to check for flags through the <code>contains()</code> function. For example, <code>flags().contains(PRESENT | WRITABLE)</code> returns true if the entry contains <em>both</em> flags.<p>To extract the physical address, we add a <code>pointed_frame</code> method:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>pointed_frame(</span><span style=color:#569cd6;>&</span><span>self) -> Option&LTFrame> {
</span><span>    </span><span style=color:#569cd6;>if </span><span>self.flags().contains(</span><span style=color:#b4cea8;>PRESENT</span><span>) {
</span><span>        Some(Frame::containing_address(
</span><span>            self.</span><span style=color:#b5cea8;>0 </span><span style=color:#569cd6;>as usize & </span><span style=color:#b5cea8;>0x000fffff_fffff000
</span><span>        ))
</span><span>    } </span><span style=color:#569cd6;>else </span><span>{
</span><span>        None
</span><span>    }
</span><span>}
</span></code></pre><p>If the entry is present, we mask bits 12‚Äì51 and return the corresponding frame. If the entry is not present, it does not point to a valid frame so we return <code>None</code>.<p>To modify entries, we add a <code>set</code> method that updates the flags and the pointed frame:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>set(</span><span style=color:#569cd6;>&mut </span><span>self, frame: Frame, flags: EntryFlags) {
</span><span>    assert!(frame.start_address() </span><span style=color:#569cd6;>& !</span><span style=color:#b5cea8;>0x000fffff_fffff000 </span><span>== </span><span style=color:#b5cea8;>0</span><span>);
</span><span>    self.</span><span style=color:#b5cea8;>0 </span><span>= (frame.start_address() </span><span style=color:#569cd6;>as u64</span><span>) </span><span style=color:#569cd6;>|</span><span> flags.bits();
</span><span>}
</span></code></pre><p>The start address of a frame should be page aligned and smaller than 2^52 (since x86 uses 52bit physical addresses). Since an invalid address could mess up the entry, we add an assertion. To actually set the entry, we just need to <code>or</code> the start address and the flag bits.<p>The missing <code>Frame::start_address</code> method is pretty simple:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>self::paging::PhysicalAddress;
</span><span>
</span><span style=color:#569cd6;>fn </span><span>start_address(</span><span style=color:#569cd6;>&</span><span>self) -> PhysicalAddress {
</span><span>    self.number * </span><span style=color:#b4cea8;>PAGE_SIZE
</span><span>}
</span></code></pre><p>We add it to the <code>impl Frame</code> block in <code>memory/mod.rs</code>.<h3 id=page-tables><a aria-label="Anchor link for: page-tables" class=zola-anchor href=#page-tables>üîó</a>Page Tables</h3><p>To model page tables, we create a basic <code>Table</code> struct in a new <code>table</code> submodule:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>memory::paging::entry::*;
</span><span style=color:#569cd6;>use </span><span>memory::paging::</span><span style=color:#b4cea8;>ENTRY_COUNT</span><span>;
</span><span>
</span><span style=color:#569cd6;>pub struct </span><span>Table {
</span><span>    entries: [Entry; ENTRY_COUNT],
</span><span>}
</span></code></pre><p>It‚Äôs just an array of 512 page table entries.<p>To make the <code>Table</code> indexable itself, we can implement the <code>Index</code> and <code>IndexMut</code> traits:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>core::ops::{Index, IndexMut};
</span><span>
</span><span style=color:#569cd6;>impl </span><span>Index<</span><span style=color:#569cd6;>usize</span><span>> </span><span style=color:#569cd6;>for </span><span>Table {
</span><span>    </span><span style=color:#569cd6;>type </span><span style=color:#4ec9b0;>Output </span><span>= Entry;
</span><span>
</span><span>    </span><span style=color:#569cd6;>fn </span><span>index(</span><span style=color:#569cd6;>&</span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> </span><span style=color:#569cd6;>&</span><span>Entry {
</span><span>        </span><span style=color:#569cd6;>&</span><span>self.entries[index]
</span><span>    }
</span><span>}
</span><span>
</span><span style=color:#569cd6;>impl </span><span>IndexMut<</span><span style=color:#569cd6;>usize</span><span>> </span><span style=color:#569cd6;>for </span><span>Table {
</span><span>    </span><span style=color:#569cd6;>fn </span><span>index_mut(</span><span style=color:#569cd6;>&mut </span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> </span><span style=color:#569cd6;>&mut</span><span> Entry {
</span><span>        </span><span style=color:#569cd6;>&mut </span><span>self.entries[index]
</span><span>    }
</span><span>}
</span></code></pre><p>Now it‚Äôs possible to get the 42th entry through <code>some_table[42]</code>. Of course we could replace <code>usize</code> with <code>u32</code> or even <code>u16</code> here but it would cause more numerical conversions (<code>x as u16</code>).<p>Let‚Äôs add a method that sets all entries to unused. We will need it when we create new page tables in the future. The method looks like this:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>zero(</span><span style=color:#569cd6;>&mut </span><span>self) {
</span><span>    </span><span style=color:#569cd6;>for</span><span> entry </span><span style=color:#569cd6;>in </span><span>self.entries.iter_mut() {
</span><span>        entry.set_unused();
</span><span>    }
</span><span>}
</span></code></pre><p>Now we can read page tables and retrieve the mapping information. We can also update them through the <code>IndexMut</code> trait and the <code>Entry::set</code> method. But how do we get references to the various page tables?<p>We could read the <code>CR3</code> register to get the physical address of the P4 table and read its entries to get the P3 addresses. The P3 entries then point to the P2 tables and so on. But this method only works for identity-mapped pages. In the future we will create new page tables, which aren‚Äôt in the identity-mapped area anymore. Since we can‚Äôt access them through their physical address, we need a way to map them to virtual addresses.<h2 id=mapping-page-tables><a aria-label="Anchor link for: mapping-page-tables" class=zola-anchor href=#mapping-page-tables>üîó</a>Mapping Page Tables</h2><p>So how do we map the page tables itself? We don‚Äôt have that problem for the current P4, P3, and P2 table since they are part of the identity-mapped area, but we need a way to access future tables, too.<p>One solution is to identity map all page tables. That way we would not need to differentiate virtual and physical addresses and could easily access the tables. But it clutters the virtual address space and increases fragmentation. And it makes creating page tables much more complicated since we need a physical frame whose corresponding page isn‚Äôt already used for something else.<p>An alternative solution is to map the page tables only temporary. To read/write a page table, we would map it to some free virtual address until we‚Äôre done. We could use a small pool of such virtual addresses and reuse them for various tables. This method occupies only few virtual addresses and thus is a good solution for 32-bit systems, which have small address spaces. But it makes things much more complicated since we need to temporary map up to 4 tables to access a single page. And the temporary mapping requires modification of other page tables, which need to be mapped, too.<p>We will solve the problem in another way using a trick called <em>recursive mapping</em>.<h3 id=recursive-mapping><a aria-label="Anchor link for: recursive-mapping" class=zola-anchor href=#recursive-mapping>üîó</a>Recursive Mapping</h3><p>The trick is to map the P4 table recursively: The last entry doesn‚Äôt point to a P3 table, but to the P4 table itself. We can use this entry to remove a translation level so that we land on a page table instead. For example, we can ‚Äúloop‚Äù once to access a P1 table:<p><img alt="access P1 table through recursive paging" src=recursive_mapping_access_p1.svg><p>By selecting the 511th P4 entry, which points points to the P4 table itself, the P4 table is used as the P3 table. Similarly, the P3 table is used as a P2 table and the P2 table is treated like a P1 table. Thus the P1 table becomes the target page and can be accessed through the offset.<p>It‚Äôs also possible to access P2 tables by looping twice. And if we select the 511th entry three times, we can access and modify P3 tables:<p><img alt="access P3 table through recursive paging" src=recursive_mapping_access_p3.svg><p>So we just need to specify the desired P3 table in the address through the P1 index. By choosing the 511th entry multiple times, we stay on the P4 table until the address‚Äôs P1 index becomes the actual P4 index.<p>To access the P4 table itself, we loop once more and thus never leave the frame:<p><img alt="access P4 table through recursive paging" src=recursive_mapping_access_p4.svg><p>So we can access and modify page tables of all levels by just setting one P4 entry once. Most work is done by the CPU, we just the recursive entry to remove one or more translation levels. It may seem a bit strange at first, but it‚Äôs a clean and simple solution once you wrapped your head around it.<p>By using recursive mapping, each page table is accessible through an unique virtual address. The math checks out, too: If all page tables are used, there is 1 P4 table, 511 P3 tables (the last entry is used for the recursive mapping), <code>511*512</code> P2 tables, and <code>511*512*512</code> P1 tables. So there are <code>134217728</code> page tables altogether. Each page table occupies 4KiB, so we need <code>134217728 * 4KiB = 512GiB</code> to store them. That‚Äôs exactly the amount of memory that can be accessed through one P4 entry since <code>4KiB per page * 512 P1 entries * 512 P2 entries * 512 P3 entries = 512GiB</code>.<p>Of course recursive mapping has some disadvantages, too. It occupies a P4 entry and thus 512GiB of the virtual address space. But since we‚Äôre in long mode and have a 48-bit address space, there are still 225.5TiB left. The bigger problem is that only the active table can be modified by default. To access another table, the recursive entry needs to be replaced temporary. We will tackle this problem in the next post when we switch to a new page table.<h3 id=implementation><a aria-label="Anchor link for: implementation" class=zola-anchor href=#implementation>üîó</a>Implementation</h3><p>To map the P4 table recursively, we just need to point the 511th entry to the table itself. Of course we could do it in Rust, but it would require some fiddling with unsafe pointers. It‚Äôs easier to just add some lines to our boot assembly:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span style=color:#569cd6;>mov </span><span>eax, p4_table
</span><span style=color:#569cd6;>or </span><span>eax, 0b11</span><span style=color:#608b4e;> ; present + writable
</span><span style=color:#569cd6;>mov </span><span>[p4_table + </span><span style=color:#b4cea8;>511 </span><span>* </span><span style=color:#b4cea8;>8</span><span>], eax
</span></code></pre><p>I put it right after the <code>set_up_page_tables</code> label, but you can add it wherever you like.<p>Now we can use special virtual addresses to access the page tables. The P4 table is available at <code>0xfffffffffffff000</code>. Let‚Äôs add a P4 constant to the <code>table</code> submodule:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub const </span><span style=color:#b4cea8;>P4</span><span>: </span><span style=color:#569cd6;>*mut</span><span> Table = </span><span style=color:#b5cea8;>0xffffffff_fffff000 </span><span style=color:#569cd6;>as *mut _</span><span>;
</span></code></pre><p>Let‚Äôs switch to the octal system, since it makes more sense for the other special addresses. The P4 address from above is equivalent to <code>0o177777_777_777_777_777_0000</code> in octal. You can see that is has index <code>777</code> in all tables and offset <code>0000</code>. The <code>177777</code> bits on the left are the sign extension bits, which are copies of the 47th bit. They are required because x86 only uses 48bit virtual addresses.<p>The other tables can be accessed through the following addresses:<table><thead><tr><th>Table<th>Address<th>Indexes<tbody><tr><td>P4<td><code>0o177777_777_777_777_777_0000</code><td>‚Äì<tr><td>P3<td><code>0o177777_777_777_777_XXX_0000</code><td><code>XXX</code> is the P4 index<tr><td>P2<td><code>0o177777_777_777_XXX_YYY_0000</code><td>like above, and <code>YYY</code> is the P3 index<tr><td>P1<td><code>0o177777_777_XXX_YYY_ZZZ_0000</code><td>like above, and <code>ZZZ</code> is the P2 index</table><p>If we look closely, we can see that the P3 address is equal to <code>(P4 << 9) | XXX_0000</code>. And the P2 address is calculated through <code>(P3 << 9) | YYY_0000</code>. So to get the next address, we need to shift it 9 bits to the left and add the table index. As a formula:<pre style=background-color:#1e1e1e;color:#dcdcdc;><code><span>next_table_address = (table_address << 9) | (index << 12)
</span></code></pre><h3 id=the-next-table-methods><a aria-label="Anchor link for: the-next-table-methods" class=zola-anchor href=#the-next-table-methods>üîó</a>The <code>next_table</code> Methods</h3><p>Let‚Äôs add the above formula as a <code>Table</code> method:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>fn </span><span>next_table_address(</span><span style=color:#569cd6;>&</span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> Option<</span><span style=color:#569cd6;>usize</span><span>> {
</span><span>    </span><span style=color:#569cd6;>let</span><span> entry_flags = self[index].flags();
</span><span>    </span><span style=color:#569cd6;>if</span><span> entry_flags.contains(</span><span style=color:#b4cea8;>PRESENT</span><span>) </span><span style=color:#569cd6;>&& !</span><span>entry_flags.contains(</span><span style=color:#b4cea8;>HUGE_PAGE</span><span>) {
</span><span>        </span><span style=color:#569cd6;>let</span><span> table_address = self </span><span style=color:#569cd6;>as *const _ as usize</span><span>;
</span><span>        Some((table_address << </span><span style=color:#b5cea8;>9</span><span>) </span><span style=color:#569cd6;>| </span><span>(index << </span><span style=color:#b5cea8;>12</span><span>))
</span><span>    } </span><span style=color:#569cd6;>else </span><span>{
</span><span>        None
</span><span>    }
</span><span>}
</span></code></pre><p>The next table address is only valid if the corresponding entry is present and does not create a huge page. Then we can do some pointer casting to get the table address and use the formula to calculate the next address.<p>If the index is out of bounds, the function will panic since Rust checks array bounds. The panic is desired here since a wrong index should not be possible and indicates a bug.<p>To convert the address into references, we add two functions:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>next_table(</span><span style=color:#569cd6;>&</span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> Option<</span><span style=color:#569cd6;>&</span><span>Table> {
</span><span>    self.next_table_address(index)
</span><span>        .map(|address| </span><span style=color:#569cd6;>unsafe </span><span>{ </span><span style=color:#569cd6;>&</span><span>*(address </span><span style=color:#569cd6;>as *const _</span><span>) })
</span><span>}
</span><span>
</span><span style=color:#569cd6;>pub fn </span><span>next_table_mut(</span><span style=color:#569cd6;>&mut </span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> Option<</span><span style=color:#569cd6;>&mut</span><span> Table> {
</span><span>    self.next_table_address(index)
</span><span>        .map(|address| </span><span style=color:#569cd6;>unsafe </span><span>{ </span><span style=color:#569cd6;>&mut </span><span>*(address </span><span style=color:#569cd6;>as *mut _</span><span>) })
</span><span>}
</span></code></pre><p>We convert the address into raw pointers through <code>as</code> casts and then convert them into Rust references through <code>&mut *</code>. The latter is an <code>unsafe</code> operation since Rust can‚Äôt guarantee that the raw pointer is valid.<p>Note that <code>self</code> stays borrowed as long as the returned reference is valid. This is because of Rust‚Äôs <a href=https://doc.rust-lang.org/1.30.0/book/first-edition/lifetimes.html#lifetime-elision>lifetime elision</a> rules. Basically, these rules say that the lifetime of an output reference is the same as the lifetime of the input reference by default. So the above function signatures are expanded to:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>next_table<</span><span style=color:#569cd6;>'a</span><span>>(</span><span style=color:#569cd6;>&'a </span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> Option<</span><span style=color:#569cd6;>&'a</span><span> Table> {</span><span style=color:#569cd6;>...</span><span>}
</span><span>
</span><span style=color:#569cd6;>pub fn </span><span>next_table_mut<</span><span style=color:#569cd6;>'a</span><span>>(</span><span style=color:#569cd6;>&'a mut </span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>)
</span><span>    -> Option<</span><span style=color:#569cd6;>&'a mut</span><span> Table>
</span><span>{</span><span style=color:#569cd6;>...</span><span>}
</span></code></pre><p>Note the additional lifetime parameters, which are identical for input and output references. That‚Äôs exactly what we want. It ensures that we can‚Äôt modify tables as long as we have references to lower tables. For example, it would be very bad if we could unmap a P3 table if we still write to one of its P2 tables.<h4 id=safety><a aria-label="Anchor link for: safety" class=zola-anchor href=#safety>üîó</a>Safety</h4><p>Now we can start at the <code>P4</code> constant and use the <code>next_table</code> functions to access the lower tables. And we don‚Äôt even need <code>unsafe</code> blocks to do it! Right now, your alarm bells should be ringing. Thanks to Rust, everything we‚Äôve done before in this post was completely safe. But we just introduced two unsafe blocks to convince Rust that there are valid tables at the specified addresses. Can we really be sure?<p>First, these addresses are only valid if the P4 table is mapped recursively. Since the paging module will be the only module that modifies page tables, we can introduce an invariant for the module:<blockquote><p><em>The 511th entry of the active P4 table must always be mapped to the active P4 table itself.</em></blockquote><p>So if we switch to another P4 table at some time, it needs to be identity mapped <em>before</em> it becomes active. As long as we obey this invariant, we can safely use the special addresses. But even with this invariant, there is a big problem with the two methods:<p><em>What happens if we call them on a P1 table?</em><p>Well, they would calculate the address of the next table (which does not exist) and treat it as a page table. Either they construct an invalid address (if <code>XXX < 400</code>)<sup class=footnote-reference><a href=#fn-invalid-address>1</a></sup> or access the mapped page itself. That way, we could easily corrupt memory or cause CPU exceptions by accident. So these two functions are not <em>safe</em> in Rust terms. Thus we need to make them <code>unsafe</code> functions unless we find some clever solution.<h2 id=some-clever-solution><a aria-label="Anchor link for: some-clever-solution" class=zola-anchor href=#some-clever-solution>üîó</a>Some Clever Solution</h2><p>We can use Rust‚Äôs type system to statically guarantee that the <code>next_table</code> methods can only be called on P4, P3, and P2 tables, but not on a P1 table. The idea is to add a <code>Level</code> parameter to the <code>Table</code> type and implement the <code>next_table</code> methods only for level 4, 3, and 2.<p>To model the levels we use a trait and empty enums:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub trait </span><span>TableLevel {}
</span><span>
</span><span style=color:#569cd6;>pub enum </span><span>Level4 {}
</span><span style=color:#569cd6;>pub enum </span><span>Level3 {}
</span><span style=color:#569cd6;>pub enum </span><span>Level2 {}
</span><span style=color:#569cd6;>pub enum </span><span>Level1 {}
</span><span>
</span><span style=color:#569cd6;>impl </span><span>TableLevel </span><span style=color:#569cd6;>for </span><span>Level4 {}
</span><span style=color:#569cd6;>impl </span><span>TableLevel </span><span style=color:#569cd6;>for </span><span>Level3 {}
</span><span style=color:#569cd6;>impl </span><span>TableLevel </span><span style=color:#569cd6;>for </span><span>Level2 {}
</span><span style=color:#569cd6;>impl </span><span>TableLevel </span><span style=color:#569cd6;>for </span><span>Level1 {}
</span></code></pre><p>An empty enum has size zero and disappears completely after compiling. Unlike an empty struct, it‚Äôs not possible to instantiate an empty enum. Since we will use <code>TableLevel</code> and the table levels in exported types, they need to be public.<p>To differentiate the P1 table from the other tables, we introduce a <code>HierarchicalLevel</code> trait, which is a subtrait of <code>TableLevel</code>. But we implement it only for the levels 4, 3, and 2:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub trait </span><span>HierarchicalLevel: TableLevel {}
</span><span>
</span><span style=color:#569cd6;>impl </span><span>HierarchicalLevel </span><span style=color:#569cd6;>for </span><span>Level4 {}
</span><span style=color:#569cd6;>impl </span><span>HierarchicalLevel </span><span style=color:#569cd6;>for </span><span>Level3 {}
</span><span style=color:#569cd6;>impl </span><span>HierarchicalLevel </span><span style=color:#569cd6;>for </span><span>Level2 {}
</span></code></pre><p>Now we add the level parameter to the <code>Table</code> type:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>core::marker::PhantomData;
</span><span>
</span><span style=color:#569cd6;>pub struct </span><span>Table&LTL: TableLevel> {
</span><span>    entries: [Entry; ENTRY_COUNT],
</span><span>    level: PhantomData&LTL>,
</span><span>}
</span></code></pre><p>We need to add a <a href=https://doc.rust-lang.org/core/marker/struct.PhantomData.html#unused-type-parameters>PhantomData</a> field because unused type parameters are not allowed in Rust.<p>Since we changed the <code>Table</code> type, we need to update every use of it:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub const </span><span style=color:#b4cea8;>P4</span><span>: </span><span style=color:#569cd6;>*mut </span><span>Table&LTLevel4> = </span><span style=color:#b5cea8;>0xffffffff_fffff000 </span><span style=color:#569cd6;>as *mut _</span><span>;
</span><span style=color:#569cd6;>...
</span><span style=color:#569cd6;>impl</span><span>&LTL> Table&LTL> </span><span style=color:#569cd6;>where</span><span> L: TableLevel
</span><span>{
</span><span>    </span><span style=color:#569cd6;>pub fn </span><span>zero(</span><span style=color:#569cd6;>&mut </span><span>self) {</span><span style=color:#569cd6;>...</span><span>}
</span><span>}
</span><span>
</span><span style=color:#569cd6;>impl</span><span>&LTL> Table&LTL> </span><span style=color:#569cd6;>where</span><span> L: HierarchicalLevel
</span><span>{
</span><span>    </span><span style=color:#569cd6;>pub fn </span><span>next_table(</span><span style=color:#569cd6;>&</span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> Option<</span><span style=color:#569cd6;>&</span><span>Table<</span><span style=color:#ff3333;>??</span><span style=color:#569cd6;>?</span><span>>> {</span><span style=color:#569cd6;>...</span><span>}
</span><span>
</span><span>    </span><span style=color:#569cd6;>pub fn </span><span>next_table_mut(</span><span style=color:#569cd6;>&mut </span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> Option<</span><span style=color:#569cd6;>&mut </span><span>Table<</span><span style=color:#ff3333;>??</span><span style=color:#569cd6;>?</span><span>>>
</span><span>    {</span><span style=color:#569cd6;>...</span><span>}
</span><span>
</span><span>    </span><span style=color:#569cd6;>fn </span><span>next_table_address(</span><span style=color:#569cd6;>&</span><span>self, index: </span><span style=color:#569cd6;>usize</span><span>) -> Option<</span><span style=color:#569cd6;>usize</span><span>> {</span><span style=color:#569cd6;>...</span><span>}
</span><span>}
</span><span>
</span><span style=color:#569cd6;>impl</span><span>&LTL> Index<</span><span style=color:#569cd6;>usize</span><span>> </span><span style=color:#569cd6;>for </span><span>Table&LTL> </span><span style=color:#569cd6;>where</span><span> L: TableLevel {</span><span style=color:#569cd6;>...</span><span>}
</span><span>
</span><span style=color:#569cd6;>impl</span><span>&LTL> IndexMut<</span><span style=color:#569cd6;>usize</span><span>> </span><span style=color:#569cd6;>for </span><span>Table&LTL> </span><span style=color:#569cd6;>where</span><span> L: TableLevel {</span><span style=color:#569cd6;>...</span><span>}
</span></code></pre><p>Now the <code>next_table</code> methods are only available for P4, P3, and P2 tables. But they have the incomplete return type <code>Table&LT???></code> now. What should we fill in for the <code>???</code>?<p>For a P4 table we would like to return a <code>Table&LTLevel3></code>, for a P3 table a <code>Table&LTLevel2></code>, and for a P2 table a <code>Table&LTLevel1></code>. So we want to return a table of the <em>next level</em>.<p>We can define the next level by adding an associated type to the <code>HierarchicalLevel</code> trait:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>trait </span><span>HierarchicalLevel: TableLevel {
</span><span>    </span><span style=color:#569cd6;>type </span><span style=color:#4ec9b0;>NextLevel</span><span>: TableLevel;
</span><span>}
</span><span>
</span><span style=color:#569cd6;>impl </span><span>HierarchicalLevel </span><span style=color:#569cd6;>for </span><span>Level4 {
</span><span>    </span><span style=color:#569cd6;>type </span><span style=color:#4ec9b0;>NextLevel </span><span>= Level3;
</span><span>}
</span><span>
</span><span style=color:#569cd6;>impl </span><span>HierarchicalLevel </span><span style=color:#569cd6;>for </span><span>Level3 {
</span><span>    </span><span style=color:#569cd6;>type </span><span style=color:#4ec9b0;>NextLevel </span><span>= Level2;
</span><span>}
</span><span>
</span><span style=color:#569cd6;>impl </span><span>HierarchicalLevel </span><span style=color:#569cd6;>for </span><span>Level2 {
</span><span>    </span><span style=color:#569cd6;>type </span><span style=color:#4ec9b0;>NextLevel </span><span>= Level1;
</span><span>}
</span></code></pre><p>Now we can replace the <code>Table&LT???></code> types with <code>Table&LTL::NextLevel></code> types and our code works as intended. You can try it with a simple test function:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>fn </span><span>test() {
</span><span>    </span><span style=color:#569cd6;>let</span><span> p4 = </span><span style=color:#569cd6;>unsafe </span><span>{ </span><span style=color:#569cd6;>&</span><span>*</span><span style=color:#b4cea8;>P4 </span><span>};
</span><span>    p4.next_table(</span><span style=color:#b5cea8;>42</span><span>)
</span><span>      .and_then(|p3| p3.next_table(</span><span style=color:#b5cea8;>1337</span><span>))
</span><span>      .and_then(|p2| p2.next_table(</span><span style=color:#b5cea8;>0xdeadbeaf</span><span>))
</span><span>      .and_then(|p1| p1.next_table(</span><span style=color:#b5cea8;>0xcafebabe</span><span>))
</span><span>}
</span></code></pre><p>Most of the indexes are completely out of bounds, so it would panic if it‚Äôs called. But we don‚Äôt need to call it since it already fails at compile time:<pre style=background-color:#1e1e1e;color:#dcdcdc;><code><span>error: no method named `next_table` found for type
</span><span>  `&memory::paging::table::Table&LTmemory::paging::table::Level1>`
</span><span>  in the current scope
</span></code></pre><p>Remember that this is bare metal kernel code. We just used type system magic to make low-level page table manipulations safer. Rust is just awesome!<h2 id=translating-addresses><a aria-label="Anchor link for: translating-addresses" class=zola-anchor href=#translating-addresses>üîó</a>Translating Addresses</h2><p>Now let‚Äôs do something useful with our new module. We will create a function that translates a virtual address to the corresponding physical address. We add it to the <code>paging/mod.rs</code> module:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>translate(virtual_address: VirtualAddress)
</span><span>    -> Option&LTPhysicalAddress>
</span><span>{
</span><span>    </span><span style=color:#569cd6;>let</span><span> offset = virtual_address % </span><span style=color:#b4cea8;>PAGE_SIZE</span><span>;
</span><span>    translate_page(Page::containing_address(virtual_address))
</span><span>        .map(|frame| frame.number * </span><span style=color:#b4cea8;>PAGE_SIZE </span><span>+ offset)
</span><span>}
</span></code></pre><p>It uses two functions we haven‚Äôt defined yet: <code>translate_page</code> and <code>Page::containing_address</code>. Let‚Äôs start with the latter:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>containing_address(address: VirtualAddress) -> Page {
</span><span>    assert!(address < </span><span style=color:#b5cea8;>0x0000_8000_0000_0000 </span><span style=color:#569cd6;>||
</span><span>        address >= </span><span style=color:#b5cea8;>0xffff_8000_0000_0000</span><span>,
</span><span>        </span><span style=color:#d69d85;>"invalid address: 0x{:x}"</span><span>, address);
</span><span>    Page { number: address / </span><span style=color:#b4cea8;>PAGE_SIZE </span><span>}
</span><span>}
</span></code></pre><p>The assertion is needed because there can be invalid addresses. Addresses on x86 are just 48-bit long and the other bits are just <em>sign extension</em>, i.e. a copy of the most significant bit. For example:<pre style=background-color:#1e1e1e;color:#dcdcdc;><code><span>invalid address: 0x0000_8000_0000_0000
</span><span>valid address:   0xffff_8000_0000_0000
</span><span>                        ‚îî‚îÄ‚îÄ bit 47
</span></code></pre><p>So the address space is split into two halves: the <em>higher half</em> containing addresses with sign extension and the <em>lower half</em> containing addresses without. Everything in between is invalid.<p>Since we added <code>containing_address</code>, we add the inverse method as well (maybe we need it later):<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>fn </span><span>start_address(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>usize </span><span>{
</span><span>    self.number * </span><span style=color:#b4cea8;>PAGE_SIZE
</span><span>}
</span></code></pre><p>The other missing function, <code>translate_page</code>, looks like this:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>memory::Frame;
</span><span>
</span><span style=color:#569cd6;>fn </span><span>translate_page(page: Page) -> Option&LTFrame> {
</span><span>    </span><span style=color:#569cd6;>use </span><span>self::entry::</span><span style=color:#b4cea8;>HUGE_PAGE</span><span>;
</span><span>
</span><span>    </span><span style=color:#569cd6;>let</span><span> p3 = </span><span style=color:#569cd6;>unsafe </span><span>{ </span><span style=color:#569cd6;>&</span><span>*table::</span><span style=color:#b4cea8;>P4 </span><span>}.next_table(page.p4_index());
</span><span>
</span><span>    </span><span style=color:#569cd6;>let </span><span>huge_page </span><span style=color:#569cd6;>= </span><span>|| {
</span><span>        </span><span style=color:#608b4e;>// TODO
</span><span>    };
</span><span>
</span><span>    p3.and_then(|p3| p3.next_table(page.p3_index()))
</span><span>      .and_then(|p2| p2.next_table(page.p2_index()))
</span><span>      .and_then(|p1| p1[page.p1_index()].pointed_frame())
</span><span>      .or_else(huge_page)
</span><span>}
</span></code></pre><p>We use an unsafe block to convert the raw <code>P4</code> pointer to a reference. Then we use the <a href=https://doc.rust-lang.org/nightly/core/option/enum.Option.html#method.and_then>Option::and_then</a> function to go through the four table levels. If some entry along the way is <code>None</code>, we check if the page is a huge page through the (unimplemented) <code>huge_page</code> closure.<p>The <code>Page::p*_index</code> functions return the different table indexes. They look like this:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>fn </span><span>p4_index(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>usize </span><span>{
</span><span>    (self.number >> </span><span style=color:#b5cea8;>27</span><span>) </span><span style=color:#569cd6;>& </span><span style=color:#b5cea8;>0o777
</span><span>}
</span><span style=color:#569cd6;>fn </span><span>p3_index(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>usize </span><span>{
</span><span>    (self.number >> </span><span style=color:#b5cea8;>18</span><span>) </span><span style=color:#569cd6;>& </span><span style=color:#b5cea8;>0o777
</span><span>}
</span><span style=color:#569cd6;>fn </span><span>p2_index(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>usize </span><span>{
</span><span>    (self.number >> </span><span style=color:#b5cea8;>9</span><span>) </span><span style=color:#569cd6;>& </span><span style=color:#b5cea8;>0o777
</span><span>}
</span><span style=color:#569cd6;>fn </span><span>p1_index(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>usize </span><span>{
</span><span>    (self.number >> </span><span style=color:#b5cea8;>0</span><span>) </span><span style=color:#569cd6;>& </span><span style=color:#b5cea8;>0o777
</span><span>}
</span></code></pre><h3 id=safety-1><a aria-label="Anchor link for: safety-1" class=zola-anchor href=#safety-1>üîó</a>Safety</h3><p>We use an <code>unsafe</code> block to convert the raw <code>P4</code> pointer into a shared reference. It‚Äôs safe because we don‚Äôt create any <code>&mut</code> references to the table right now and don‚Äôt switch the P4 table either. But as soon as we do something like that, we have to revisit this method.<h3 id=huge-pages><a aria-label="Anchor link for: huge-pages" class=zola-anchor href=#huge-pages>üîó</a>Huge Pages</h3><p>The <code>huge_page</code> closure calculates the corresponding frame if huge pages are used. Its content looks like this:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span>p3.and_then(|p3| {
</span><span>      </span><span style=color:#569cd6;>let</span><span> p3_entry = </span><span style=color:#569cd6;>&</span><span>p3[page.p3_index()];
</span><span>      </span><span style=color:#608b4e;>// 1GiB page?
</span><span>      </span><span style=color:#569cd6;>if let </span><span>Some(start_frame) = p3_entry.pointed_frame() {
</span><span>          </span><span style=color:#569cd6;>if</span><span> p3_entry.flags().contains(</span><span style=color:#b4cea8;>HUGE_PAGE</span><span>) {
</span><span>              </span><span style=color:#608b4e;>// address must be 1GiB aligned
</span><span>              assert!(start_frame.number % (</span><span style=color:#b4cea8;>ENTRY_COUNT </span><span>* </span><span style=color:#b4cea8;>ENTRY_COUNT</span><span>) == </span><span style=color:#b5cea8;>0</span><span>);
</span><span>              </span><span style=color:#569cd6;>return </span><span>Some(Frame {
</span><span>                  number: start_frame.number + page.p2_index() *
</span><span>                          </span><span style=color:#b4cea8;>ENTRY_COUNT </span><span>+ page.p1_index(),
</span><span>              });
</span><span>          }
</span><span>      }
</span><span>      </span><span style=color:#569cd6;>if let </span><span>Some(p2) = p3.next_table(page.p3_index()) {
</span><span>          </span><span style=color:#569cd6;>let</span><span> p2_entry = </span><span style=color:#569cd6;>&</span><span>p2[page.p2_index()];
</span><span>          </span><span style=color:#608b4e;>// 2MiB page?
</span><span>          </span><span style=color:#569cd6;>if let </span><span>Some(start_frame) = p2_entry.pointed_frame() {
</span><span>              </span><span style=color:#569cd6;>if</span><span> p2_entry.flags().contains(</span><span style=color:#b4cea8;>HUGE_PAGE</span><span>) {
</span><span>                  </span><span style=color:#608b4e;>// address must be 2MiB aligned
</span><span>                  assert!(start_frame.number % </span><span style=color:#b4cea8;>ENTRY_COUNT </span><span>== </span><span style=color:#b5cea8;>0</span><span>);
</span><span>                  </span><span style=color:#569cd6;>return </span><span>Some(Frame {
</span><span>                      number: start_frame.number + page.p1_index()
</span><span>                  });
</span><span>              }
</span><span>          }
</span><span>      }
</span><span>      None
</span><span>  })
</span></code></pre><p>This function is much longer and more complex than the <code>translate_page</code> function itself. To avoid this complexity in the future, we will only work with standard 4KiB pages from now on.<h2 id=mapping-pages><a aria-label="Anchor link for: mapping-pages" class=zola-anchor href=#mapping-pages>üîó</a>Mapping Pages</h2><p>Let‚Äôs add a function that modifies the page tables to map a <code>Page</code> to a <code>Frame</code>:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub use </span><span>self::entry::*;
</span><span style=color:#569cd6;>use </span><span>memory::FrameAllocator;
</span><span>
</span><span style=color:#569cd6;>pub fn </span><span>map_to&LTA>(page: Page, frame: Frame, flags: EntryFlags,
</span><span>                 allocator: </span><span style=color:#569cd6;>&mut</span><span> A)
</span><span>    </span><span style=color:#569cd6;>where</span><span> A: FrameAllocator
</span><span>{
</span><span>    </span><span style=color:#569cd6;>let</span><span> p4 = </span><span style=color:#569cd6;>unsafe </span><span>{ </span><span style=color:#569cd6;>&mut </span><span>*</span><span style=color:#b4cea8;>P4 </span><span>};
</span><span>    </span><span style=color:#569cd6;>let mut</span><span> p3 = p4.next_table_create(page.p4_index(), allocator);
</span><span>    </span><span style=color:#569cd6;>let mut</span><span> p2 = p3.next_table_create(page.p3_index(), allocator);
</span><span>    </span><span style=color:#569cd6;>let mut</span><span> p1 = p2.next_table_create(page.p2_index(), allocator);
</span><span>
</span><span>    assert!(p1[page.p1_index()].is_unused());
</span><span>    p1[page.p1_index()].set(frame, flags </span><span style=color:#569cd6;>| </span><span style=color:#b4cea8;>PRESENT</span><span>);
</span><span>}
</span></code></pre><p>We add an re-export for all <code>entry</code> types since they are required to call the function. We assert that the page is unmapped and always set the present flag (since it wouldn‚Äôt make sense to map a page without setting it).<p>The <code>Table::next_table_create</code> method doesn‚Äôt exist yet. It should return the next table if it exists, or create a new one. For the implementation we need the <code>FrameAllocator</code> from the <a href=https://os.phil-opp.com/allocating-frames/#a-memory-module>previous post</a> and the <code>Table::zero</code> method:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>memory::FrameAllocator;
</span><span>
</span><span style=color:#569cd6;>pub fn </span><span>next_table_create&LTA>(</span><span style=color:#569cd6;>&mut </span><span>self,
</span><span>                            index: </span><span style=color:#569cd6;>usize</span><span>,
</span><span>                            allocator: </span><span style=color:#569cd6;>&mut</span><span> A)
</span><span>                            -> </span><span style=color:#569cd6;>&mut </span><span>Table<</span><span style=color:#569cd6;>L::</span><span>NextLevel>
</span><span>    </span><span style=color:#569cd6;>where</span><span> A: FrameAllocator
</span><span>{
</span><span>    </span><span style=color:#569cd6;>if </span><span>self.next_table(index).is_none() {
</span><span>        assert!(</span><span style=color:#569cd6;>!</span><span>self.entries[index].flags().contains(</span><span style=color:#b4cea8;>HUGE_PAGE</span><span>),
</span><span>                </span><span style=color:#d69d85;>"mapping code does not support huge pages"</span><span>);
</span><span>        </span><span style=color:#569cd6;>let</span><span> frame = allocator.allocate_frame().expect(</span><span style=color:#d69d85;>"no frames available"</span><span>);
</span><span>        self.entries[index].set(frame, </span><span style=color:#b4cea8;>PRESENT </span><span style=color:#569cd6;>| </span><span style=color:#b4cea8;>WRITABLE</span><span>);
</span><span>        self.next_table_mut(index).unwrap().zero();
</span><span>    }
</span><span>    self.next_table_mut(index).unwrap()
</span><span>}
</span></code></pre><p>We can use <code>unwrap()</code> here since the next table definitely exists.<h3 id=safety-2><a aria-label="Anchor link for: safety-2" class=zola-anchor href=#safety-2>üîó</a>Safety</h3><p>We used an <code>unsafe</code> block in <code>map_to</code> to convert the raw <code>P4</code> pointer to a <code>&mut</code> reference. That‚Äôs bad. It‚Äôs now possible that the <code>&mut</code> reference is not exclusive, which breaks Rust‚Äôs guarantees. It‚Äôs only a matter time before we run into a data race. For example, imagine that one thread maps an entry to <code>frame_A</code> and another thread (on the same core) tries to map the same entry to <code>frame_B</code>.<p>The problem is that there‚Äôs no clear <em>owner</em> for the page tables. So let‚Äôs define page table ownership!<h3 id=page-table-ownership><a aria-label="Anchor link for: page-table-ownership" class=zola-anchor href=#page-table-ownership>üîó</a>Page Table Ownership</h3><p>We define the following:<blockquote><p>A page table owns all of its subtables.</blockquote><p>We already obey this rule: To get a reference to a table, we need to borrow it from its parent table through the <code>next_table</code> method. But who owns the P4 table?<blockquote><p>The recursively mapped P4 table is owned by a <code>ActivePageTable</code> struct.</blockquote><p>We just defined some random owner for the P4 table. But it will solve our problems. And it will also provide the interface to other modules.<p>So let‚Äôs create the struct:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>use </span><span>self::table::{Table, Level4};
</span><span style=color:#569cd6;>use </span><span>core::ptr::Unique;
</span><span>
</span><span style=color:#569cd6;>pub struct </span><span>ActivePageTable {
</span><span>    p4: Unique&LTTable&LTLevel4>>,
</span><span>}
</span></code></pre><p>We can‚Äôt store the <code>Table&LTLevel4></code> directly because it needs to be at a special memory location (like the <a href=https://os.phil-opp.com/printing-to-screen/#the-text-buffer>VGA text buffer</a>). We could use a raw pointer or <code>&mut</code> instead of <a href=https://doc.rust-lang.org/1.10.0/core/ptr/struct.Unique.html>Unique</a>, but Unique indicates ownership better.<p>Because the <code>ActivePageTable</code> owns the unique recursive mapped P4 table, there must be only one <code>ActivePageTable</code> instance. Thus we make the constructor function unsafe:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>impl </span><span>ActivePageTable {
</span><span>    </span><span style=color:#569cd6;>pub unsafe fn </span><span>new() -> ActivePageTable {
</span><span>        ActivePageTable {
</span><span>            p4: Unique::new_unchecked(table::</span><span style=color:#b4cea8;>P4</span><span>),
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>We add some methods to get P4 references:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>fn </span><span>p4(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>&</span><span>Table&LTLevel4> {
</span><span>    </span><span style=color:#569cd6;>unsafe </span><span>{ self.p4.as_ref() }
</span><span>}
</span><span>
</span><span style=color:#569cd6;>fn </span><span>p4_mut(</span><span style=color:#569cd6;>&mut </span><span>self) -> </span><span style=color:#569cd6;>&mut </span><span>Table&LTLevel4> {
</span><span>    </span><span style=color:#569cd6;>unsafe </span><span>{ self.p4.as_mut() }
</span><span>}
</span></code></pre><p>Since we will only create valid P4 pointers, the <code>unsafe</code> blocks are safe. However, we don‚Äôt make these functions public since they can be used to make page tables invalid. Only the higher level functions (such as <code>translate</code> or <code>map_to</code>) should be usable from other modules.<p>Now we can make the <code>map_to</code> and <code>translate</code> functions safe by making them methods of <code>ActivePageTable</code>:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>impl </span><span>ActivePageTable {
</span><span>    </span><span style=color:#569cd6;>pub unsafe fn </span><span>new() -> ActivePageTable {</span><span style=color:#569cd6;>...</span><span>}
</span><span>
</span><span>    </span><span style=color:#569cd6;>fn </span><span>p4(</span><span style=color:#569cd6;>&</span><span>self) -> </span><span style=color:#569cd6;>&</span><span>Table&LTLevel4> {</span><span style=color:#569cd6;>...</span><span>}
</span><span>
</span><span>    </span><span style=color:#569cd6;>fn </span><span>p4_mut(</span><span style=color:#569cd6;>&mut </span><span>self) -> </span><span style=color:#569cd6;>&mut </span><span>Table&LTLevel4> {</span><span style=color:#569cd6;>...</span><span>}
</span><span>
</span><span>    </span><span style=color:#569cd6;>pub fn </span><span>translate(</span><span style=color:#569cd6;>&</span><span>self, virtual_address: VirtualAddress)
</span><span>        -> Option&LTPhysicalAddress>
</span><span>    {
</span><span>        </span><span style=color:#569cd6;>...
</span><span>        self.translate_page(</span><span style=color:#569cd6;>...</span><span>).map(</span><span style=color:#569cd6;>...</span><span>)
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#569cd6;>fn </span><span>translate_page(</span><span style=color:#569cd6;>&</span><span>self, page: Page) -> Option&LTFrame> {
</span><span>        </span><span style=color:#569cd6;>let</span><span> p3 = self.p4().next_table(</span><span style=color:#569cd6;>...</span><span>);
</span><span>        </span><span style=color:#569cd6;>...
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#569cd6;>pub fn </span><span>map_to&LTA>(</span><span style=color:#569cd6;>&mut </span><span>self,
</span><span>                     page: Page,
</span><span>                     frame: Frame,
</span><span>                     flags: EntryFlags,
</span><span>                     allocator: </span><span style=color:#569cd6;>&mut</span><span> A)
</span><span>        </span><span style=color:#569cd6;>where</span><span> A: FrameAllocator
</span><span>    {
</span><span>        </span><span style=color:#569cd6;>let mut</span><span> p3 = self.p4_mut().next_table_create(</span><span style=color:#569cd6;>...</span><span>);
</span><span>        </span><span style=color:#569cd6;>...
</span><span>    }
</span><span>}
</span></code></pre><p>Now the <code>p4()</code> and <code>p4_mut()</code> methods should be the only methods containing an <code>unsafe</code> block in the <code>paging/mod.rs</code> file.<h3 id=more-mapping-functions><a aria-label="Anchor link for: more-mapping-functions" class=zola-anchor href=#more-mapping-functions>üîó</a>More Mapping Functions</h3><p>For convenience, we add a <code>map</code> method that just picks a free frame for us:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>map&LTA>(</span><span style=color:#569cd6;>&mut </span><span>self, page: Page, flags: EntryFlags, allocator: </span><span style=color:#569cd6;>&mut</span><span> A)
</span><span>    </span><span style=color:#569cd6;>where</span><span> A: FrameAllocator
</span><span>{
</span><span>    </span><span style=color:#569cd6;>let</span><span> frame = allocator.allocate_frame().expect(</span><span style=color:#d69d85;>"out of memory"</span><span>);
</span><span>    self.map_to(page, frame, flags, allocator)
</span><span>}
</span></code></pre><p>We also add a <code>identity_map</code> function to make it easier to remap the kernel in the next post:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>identity_map&LTA>(</span><span style=color:#569cd6;>&mut </span><span>self,
</span><span>                       frame: Frame,
</span><span>                       flags: EntryFlags,
</span><span>                       allocator: </span><span style=color:#569cd6;>&mut</span><span> A)
</span><span>    </span><span style=color:#569cd6;>where</span><span> A: FrameAllocator
</span><span>{
</span><span>    </span><span style=color:#569cd6;>let</span><span> page = Page::containing_address(frame.start_address());
</span><span>    self.map_to(page, frame, flags, allocator)
</span><span>}
</span></code></pre><h3 id=unmapping-pages><a aria-label="Anchor link for: unmapping-pages" class=zola-anchor href=#unmapping-pages>üîó</a>Unmapping Pages</h3><p>To unmap a page, we set the corresponding P1 entry to unused:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>fn </span><span>unmap&LTA>(</span><span style=color:#569cd6;>&mut </span><span>self, page: Page, allocator: </span><span style=color:#569cd6;>&mut</span><span> A)
</span><span>    </span><span style=color:#569cd6;>where</span><span> A: FrameAllocator
</span><span>{
</span><span>    assert!(self.translate(page.start_address()).is_some());
</span><span>
</span><span>    </span><span style=color:#569cd6;>let</span><span> p1 = self.p4_mut()
</span><span>                 .next_table_mut(page.p4_index())
</span><span>                 .and_then(|p3| p3.next_table_mut(page.p3_index()))
</span><span>                 .and_then(|p2| p2.next_table_mut(page.p2_index()))
</span><span>                 .expect(</span><span style=color:#d69d85;>"mapping code does not support huge pages"</span><span>);
</span><span>    </span><span style=color:#569cd6;>let</span><span> frame = p1[page.p1_index()].pointed_frame().unwrap();
</span><span>    p1[page.p1_index()].set_unused();
</span><span>    </span><span style=color:#608b4e;>// TODO free p(1,2,3) table if empty
</span><span>    allocator.deallocate_frame(frame);
</span><span>}
</span></code></pre><p>The assertion ensures that the page is mapped. Thus the corresponding P1 table and frame must exist for a standard 4KiB page. We set the entry to unused and free the associated frame in the supplied frame allocator.<p>We can also free the P1, P2, or even P3 table when the last entry is freed. But checking the whole table on every <code>unmap</code> would be very expensive. So we leave the <code>TODO</code> in place until we find a good solution. I‚Äôm open for suggestions :).<p><em>Spoiler</em>: There is an ugly bug in this function, which we will find in the next section.<h2 id=testing-and-bugfixing><a aria-label="Anchor link for: testing-and-bugfixing" class=zola-anchor href=#testing-and-bugfixing>üîó</a>Testing and Bugfixing</h2><p>To test it, we add a <code>test_paging</code> function in <code>memory/paging/mod.rs</code>:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>pub fn </span><span>test_paging&LTA>(allocator: </span><span style=color:#569cd6;>&mut</span><span> A)
</span><span>    </span><span style=color:#569cd6;>where</span><span> A: FrameAllocator
</span><span>{
</span><span>    </span><span style=color:#569cd6;>let mut</span><span> page_table = </span><span style=color:#569cd6;>unsafe </span><span>{ ActivePageTable::new() };
</span><span>
</span><span>    </span><span style=color:#608b4e;>// test it
</span><span>}
</span></code></pre><p>We borrow the frame allocator since we will need it for the mapping functions. To be able to call that function from main, we need to re-export it in <code>memory/mod.rs</code>:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#608b4e;>// in memory/mod.rs
</span><span style=color:#569cd6;>pub use </span><span>self::paging::test_paging;
</span><span>
</span><span style=color:#608b4e;>// lib.rs
</span><span style=color:#569cd6;>let mut</span><span> frame_allocator = </span><span style=color:#569cd6;>...</span><span>;
</span><span>memory::test_paging(</span><span style=color:#569cd6;>&mut</span><span> frame_allocator);
</span></code></pre><h3 id=map-to><a aria-label="Anchor link for: map-to" class=zola-anchor href=#map-to>üîó</a>map_to</h3><p>Let‚Äôs test the <code>map_to</code> function:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>let</span><span> addr = </span><span style=color:#b5cea8;>42 </span><span>* </span><span style=color:#b5cea8;>512 </span><span>* </span><span style=color:#b5cea8;>512 </span><span>* </span><span style=color:#b5cea8;>4096</span><span>; </span><span style=color:#608b4e;>// 42th P3 entry
</span><span style=color:#569cd6;>let</span><span> page = Page::containing_address(addr);
</span><span style=color:#569cd6;>let</span><span> frame = allocator.allocate_frame().expect(</span><span style=color:#d69d85;>"no more frames"</span><span>);
</span><span>println!(</span><span style=color:#d69d85;>"None = </span><span style=color:#b4cea8;>{:?}</span><span style=color:#d69d85;>, map to </span><span style=color:#b4cea8;>{:?}</span><span style=color:#d69d85;>"</span><span>,
</span><span>         page_table.translate(addr),
</span><span>         frame);
</span><span>page_table.map_to(page, frame, EntryFlags::empty(), allocator);
</span><span>println!(</span><span style=color:#d69d85;>"Some = </span><span style=color:#b4cea8;>{:?}</span><span style=color:#d69d85;>"</span><span>, page_table.translate(addr));
</span><span>println!(</span><span style=color:#d69d85;>"next free frame: </span><span style=color:#b4cea8;>{:?}</span><span style=color:#d69d85;>"</span><span>, allocator.allocate_frame());
</span></code></pre><p>We just map some random page to a free frame. To be able to borrow the page table as <code>&mut</code>, we need to make it mutable.<p>You should see output similar to this:<pre style=background-color:#1e1e1e;color:#dcdcdc;><code><span>None = None, map to Frame { number: 0 }
</span><span>Some = Some(0)
</span><span>next free frame: Some(Frame { number: 3 })
</span></code></pre><p>It‚Äôs frame 0 because it‚Äôs the first frame returned by the frame allocator. Since we map the 42th P3 entry, the mapping code needs to create a P2 and a P1 table. So the next free frame returned by the allocator is frame 3.<h3 id=unmap><a aria-label="Anchor link for: unmap" class=zola-anchor href=#unmap>üîó</a>unmap</h3><p>To test the <code>unmap</code> function, we unmap the test page so that it translates to <code>None</code> again:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span>page_table.unmap(Page::containing_address(addr), allocator);
</span><span>println!(</span><span style=color:#d69d85;>"None = </span><span style=color:#b4cea8;>{:?}</span><span style=color:#d69d85;>"</span><span>, page_table.translate(addr));
</span></code></pre><p>It causes a panic since we call the unimplemented <code>deallocate_frame</code> method in <code>unmap</code>. If we comment this call out, it works without problems. But there is some bug in this function nevertheless.<p>Let‚Äôs read something from the mapped page (of course before we unmap it again):<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span>println!(</span><span style=color:#d69d85;>"</span><span style=color:#b4cea8;>{:#x}</span><span style=color:#d69d85;>"</span><span>, </span><span style=color:#569cd6;>unsafe </span><span>{
</span><span>    *(Page::containing_address(addr).start_address() </span><span style=color:#569cd6;>as *const u64</span><span>)
</span><span>});
</span></code></pre><p>Since we don‚Äôt zero the mapped pages, the output is random. For me, it‚Äôs <code>0xf000ff53f000ff53</code>.<p>If <code>unmap</code> worked correctly, reading it again after unmapping should cause a page fault. But it doesn‚Äôt. Instead, it just prints the same number again. When we remove the first read, we get the desired page fault (i.e. QEMU reboots again and again). So this seems to be some cache issue.<p>An x86 processor has many different caches because always accessing the main memory would be very slow. Most of these caches are completely <em>transparent</em>. That means everything works exactly the same as without them, it‚Äôs just much faster. But there is one cache, that needs to be updated manually: the <em>translation lookaside buffer</em>.<p>The translation lookaside buffer, or TLB, caches the translation of virtual to physical addresses. It‚Äôs filled automatically when a page is accessed. But it‚Äôs not updated transparently when the mapping of a page changes. This is the reason that we still can access the page even through we unmapped it in the page table.<p>So to fix our <code>unmap</code> function, we need to remove the cached translation from the TLB. We can use the <a href=https://docs.rs/x86_64>x86_64</a> crate to do this easily. To add it, we append the following to our <code>Cargo.toml</code>:<pre class=language-toml data-lang=toml style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-toml data-lang=toml><span>[</span><span style=color:#808080;>dependencies</span><span>]
</span><span style=color:#ff3333;>...
</span><span style=color:#569cd6;>x86_64 </span><span>= </span><span style=color:#d69d85;>"0.1.2"
</span></code></pre><p>Now we can use it to fix <code>unmap</code>:<pre class=language-rust data-lang=rust style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-rust data-lang=rust><span style=color:#569cd6;>...
</span><span>    p1[page.p1_index()].set_unused();
</span><span>
</span><span>    </span><span style=color:#569cd6;>use </span><span>x86_64::instructions::tlb;
</span><span>    </span><span style=color:#569cd6;>use </span><span>x86_64::VirtualAddress;
</span><span>    tlb::flush(VirtualAddress(page.start_address()));
</span><span>
</span><span>    </span><span style=color:#608b4e;>// TODO free p(1,2,3) table if empty
</span><span>    </span><span style=color:#608b4e;>//allocator.deallocate_frame(frame);
</span><span>}
</span></code></pre><p>Now the desired page fault occurs even when we access the page before.<h2 id=conclusion><a aria-label="Anchor link for: conclusion" class=zola-anchor href=#conclusion>üîó</a>Conclusion</h2><p>This post has become pretty long. So let‚Äôs summarize what we‚Äôve done:<ul><li>we created a paging module and modeled page tables plus entries<li>we mapped the P4 page recursively and created <code>next_table</code> methods<li>we used empty enums and associated types to make the <code>next_table</code> functions safe<li>we wrote a function to translate virtual to physical addresses<li>we created safe functions to map and unmap pages<li>and we fixed stack overflow and TLB related bugs</ul><h2 id=what-s-next><a aria-label="Anchor link for: what-s-next" class=zola-anchor href=#what-s-next>üîó</a>What‚Äôs next?</h2><p>In the <a href=https://os.phil-opp.com/remap-the-kernel/>next post</a> we will extend this module and add a function to modify inactive page tables. Through that function, we will create a new page table hierarchy that maps the kernel correctly using 4KiB pages. Then we will switch to the new table to get a safer kernel environment.<p>Afterwards, we will use this paging module to build a heap allocator. This will allow us to use allocation and collection types such as <code>Box</code> and <code>Vec</code>.<p><small>Image sources: <sup class=footnote-reference><a href=#virtual_physical_translation_source>2</a></sup></small><h2 id=footnotes><a aria-label="Anchor link for: footnotes" class=zola-anchor href=#footnotes>üîó</a>Footnotes</h2><div class=footnote-definition id=fn-invalid-address><sup class=footnote-definition-label>1</sup><p>If the <code>XXX</code> part of the address is smaller than <code>0o400</code>, it‚Äôs binary representation doesn‚Äôt start with <code>1</code>. But the sign extension bits, which should be a copy of that bit, are <code>1</code> instead of <code>0</code>. Thus the address is not valid.</div><div class=footnote-definition id=virtual_physical_translation_source><sup class=footnote-definition-label>2</sup><p>Image sources: Modified versions of an image from <a href=https://commons.wikimedia.org/wiki/File:X86_Paging_64bit.svg>Wikipedia</a>. The modified files are licensed under the Creative Commons Attribution-Share Alike 3.0 Unported license.</div></main><div><hr><div class=PageNavigation><a class=prev href=/allocating-frames/>¬´ Allocating Frames</a><a class=next href=/remap-the-kernel/>Remap the Kernel ¬ª</a></div><hr><section><h2>Comments (Archived)</h2><section id=isso-thread><div id=isso-root><div class="isso-comment isso-no-votes" id=isso-53><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-53 rel=nofollow><time title="Thu Dec 10 2015 19:30:43 GMT+0100 (Central European Standard Time)" datetime=2015-11-04T18:30:43Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>There is some interesting discussion on <a href=https://www.reddit.com/r/programming/comments/3w7sps/write_an_os_in_rust_accessing_and_modifying_page/ rel=nofollow>/r/programming</a> and <a href=https://www.reddit.com/r/rust/comments/3w31ow/writing_an_os_in_rust_accessing_and_modifying/ rel=nofollow>/r/rust</a>.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class=isso-comment id=isso-54><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=9cd68c077547 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Matteo Meli</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-54 rel=nofollow><time title="Tue Dec 15 2015 10:51:58 GMT+0100 (Central European Standard Time)" datetime=2015-11-02T09:51:58Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Hi Philipp,<p>First of all thanks a lot for sharing this series of article. Just a question: do you have an idea why doubling the stack size would not be sufficient to avoid the silent stack overflow you mentioned? To make my code work I had to triple it...</div><div class=isso-comment-footer><span class=votes>1</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-55><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-55 rel=nofollow><time title="Tue Dec 15 2015 13:27:21 GMT+0100 (Central European Standard Time)" datetime=2015-11-02T12:27:21Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>What are you doing in your main? Maybe there is something stack intensive before the `test_paging` call? My main function looks like <a href=https://github.com/phil-opp/blog_os/blob/first_edition_post_6/src/lib.rs rel=nofollow>this</a>. I removed most of the example code from the previous posts, so maybe that's the reason..</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-56><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=9cd68c077547 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Matteo Meli</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-56 rel=nofollow><time title="Tue Dec 15 2015 13:38:14 GMT+0100 (Central European Standard Time)" datetime=2015-11-02T12:38:14Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>You're right! The main difference in my code is that I set up interrupts. It must be that. Thanks</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-57><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-57 rel=nofollow><time title="Tue Dec 15 2015 22:48:01 GMT+0100 (Central European Standard Time)" datetime=2015-11-02T21:48:01Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Nice! I assume that you have some experience with OS development?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-58><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=9cd68c077547 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Matteo Meli</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-58 rel=nofollow><time title="Wed Dec 16 2015 13:16:24 GMT+0100 (Central European Standard Time)" datetime=2015-11-03T12:16:24Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Not really much actually, but trying to work my way through. Currently stuck trying to load the kernel in the higher half... Do you have any references to point me to?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-59><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-59 rel=nofollow><time title="Wed Dec 16 2015 14:39:02 GMT+0100 (Central European Standard Time)" datetime=2015-11-03T13:39:02Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Only the stuff from the OSDev wiki but I think that you are aware of it already.<p>I would link the Rust code to the higher half but keep all startup assembly identity mapped. Then map the Rust code from the long mode assembly and jump to it.<p>Maybe it's even possible to use the same linker script as before since rustc generates position independent code by default (AFAIK).</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-60><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=58d5a04d7f49 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #5698c4" height=8 width=8 x=4 y=12></rect><rect style="fill: #5698c4" height=8 width=8 x=36 y=12></rect><rect style="fill: #5698c4" height=8 width=8 x=4 y=28></rect><rect style="fill: #5698c4" height=8 width=8 x=36 y=28></rect><rect style="fill: #5698c4" height=8 width=8 x=4 y=36></rect><rect style="fill: #5698c4" height=8 width=8 x=36 y=36></rect><rect style="fill: #5698c4" height=8 width=8 x=12 y=4></rect><rect style="fill: #5698c4" height=8 width=8 x=28 y=4></rect><rect style="fill: #5698c4" height=8 width=8 x=12 y=12></rect><rect style="fill: #5698c4" height=8 width=8 x=28 y=12></rect><rect style="fill: #5698c4" height=8 width=8 x=12 y=20></rect><rect style="fill: #5698c4" height=8 width=8 x=28 y=20></rect><rect style="fill: #5698c4" height=8 width=8 x=12 y=28></rect><rect style="fill: #5698c4" height=8 width=8 x=28 y=28></rect><rect style="fill: #5698c4" height=8 width=8 x=12 y=36></rect><rect style="fill: #5698c4" height=8 width=8 x=28 y=36></rect><rect style="fill: #5698c4" height=8 width=8 x=20 y=12></rect><rect style="fill: #5698c4" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Kiley Owen</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-60 rel=nofollow><time title="Wed Dec 16 2015 21:27:21 GMT+0100 (Central European Standard Time)" datetime=2015-11-03T20:27:21Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Is there a typo in the code in the huge pages section?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-61><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-61 rel=nofollow><time title="Wed Dec 16 2015 23:58:01 GMT+0100 (Central European Standard Time)" datetime=2015-11-03T22:58:01Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Maybe... What's the problem exactly?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-62><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=2b57bc2f067a shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>FreeFull</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-62 rel=nofollow><time title="Tue Jan 19 2016 11:49:22 GMT+0100 (Central European Standard Time)" datetime=2016-00-02T10:49:22Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>`TableEntryFlags` is mentioned exactly once. Where does it come from?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-63><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-63 rel=nofollow><time title="Tue Jan 19 2016 12:05:35 GMT+0100 (Central European Standard Time)" datetime=2016-00-02T11:05:35Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>It should be `EntryFlags`. Thanks for reporting, I <a href=https://github.com/phil-opp/blog_os/pull/120 rel=nofollow>pushed an update</a>.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-64><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=dc385569a1a6 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Ted Meyer</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-64 rel=nofollow><time title="Fri Jun 03 2016 21:52:53 GMT+0200 (Central European Summer Time)" datetime=2016-05-05T19:52:53Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>In order to decide when a page table should be freed, you can use the 52nd bit in the first 9 entries, to keep a score of how many present entries there are. It might be pretty bad for caching though.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-68><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-68 rel=nofollow><time title="Tue Jun 07 2016 21:35:58 GMT+0200 (Central European Summer Time)" datetime=2016-05-02T19:35:58Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>I like the idea. Alternatively, we could use bits 52 to 61 of the first entry. What's your concern about caching?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-69><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=dc385569a1a6 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Ted Meyer</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-69 rel=nofollow><time title="Wed Jun 08 2016 02:03:27 GMT+0200 (Central European Summer Time)" datetime=2016-05-03T00:03:27Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>My main concern with using all the bits in the first entry is that if ever in the future you want to go back and add more things, it would need to be changed.<p>As far as caching goes, it would depend on how big a cache line is, but if it is smaller than 9 table entries then there could be multiple cache misses on a single update (theoretically 9 bits could be changed for one addition / deletion of a page). Obviously not a _huge_ deal, but I think it's worth pointing out.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-322><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=88040d287f36 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Stephen Checkoway</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-322 rel=nofollow><time title="Mon Sep 25 2017 08:12:31 GMT+0200 (Central European Summer Time)" datetime=2017-08-01T06:12:31Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Neither choice seems like it works. Bits 62:MAXPHYADDR (where MAXPHYADDR is at most 52) are reserved and supposed to be set to 0. However, bits 11:9 appear to be free at every level of the page table hierarchy.<p>Somewhat annoyingly, 10 bits are needed since 513 values need to be represented. Thus one could use three bits from each of the first four entries.<p>x86-64 has a 64-byte cache line size so the four accesses do fit in a single cache line.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-65><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=99cda34eb55e shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Ryan Campbell</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-65 rel=nofollow><time title="Tue Jun 07 2016 21:08:31 GMT+0200 (Central European Summer Time)" datetime=2016-05-02T19:08:31Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Hey Phillip, started doing this a couple days ago and was able to make it this far. Unfortunately I am now having some compilation issues that appear to be a result of the x86 crate. I get "error: 'raw::Slice' does not name a structure" when compiling raw-cpuid, a dependency for x86. Thoughts?<p>edit: Ah-ha! I see you <a href=https://github.com/phil-opp/blog_os/issues/175 rel=nofollow>mentioned this a few days ago</a> . Thanks for everything!</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-66><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-66 rel=nofollow><time title="Tue Jun 07 2016 21:24:45 GMT+0200 (Central European Summer Time)" datetime=2016-05-02T19:24:45Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Yeah, the `raw::Slice` struct was deprecated and removed in the latest nightlies. However, the current version of the raw-cpuid crate still depends on it. The author is aware of the issue and will publish a new version in the next few days. Until then, you can try an older nightly as a workaround.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-67><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=99cda34eb55e shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Ryan Campbell</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-67 rel=nofollow><time title="Tue Jun 07 2016 21:29:28 GMT+0200 (Central European Summer Time)" datetime=2016-05-02T19:29:28Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Yep, I got it working just editing those couple of lines. Will pull new update tomorrow. Thanks!</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-70><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=59783d33552a shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Cris</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-70 rel=nofollow><time title="Fri Jun 10 2016 16:29:44 GMT+0200 (Central European Summer Time)" datetime=2016-05-05T14:29:44Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Can you explain me this self referencing trick for Page tables ?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-71><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-71 rel=nofollow><time title="Sun Jun 12 2016 14:48:55 GMT+0200 (Central European Summer Time)" datetime=2016-05-00T12:48:55Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Of course! I tried to do give a short overview in the <a href=http://os.phil-opp.com/modifying-page-tables.html#recursive-mapping rel=nofollow>Recursive Mapping</a> section. Which part of it is unclear? Or do you have a specific question?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-72><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=59783d33552a shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Cris</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-72 rel=nofollow><time title="Mon Jun 13 2016 10:49:03 GMT+0200 (Central European Summer Time)" datetime=2016-05-01T08:49:03Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>I didn't understand how looping once you can access P1 entry..<br>Can you give a short example..</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class=isso-comment id=isso-73><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-73 rel=nofollow><time title="Mon Jun 13 2016 13:20:04 GMT+0200 (Central European Summer Time)" datetime=2016-05-01T11:20:04Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>The virtual->physical address calculation is done in hardware, which expects 4 levels of page tables. In order to access the entries of a P1 table, we need to remove one level of translation. The trick is that all page tables have the (almost) same format, independent of the table level. So the CPU doesn't see a difference between e.g. a P4 and a P3 table.<p>This allows us to implement the recursive mapping trick. We lead the CPU to believe that the P2 table is the P1 table and that the P3 table is the P2 table. Thus we end up on the memory page of the P1 table and are able to modify its entries.<p>Likewise, the CPU interprets the P4 table as P3 table. But which table do we use as P4 table then? Well, we use the same P4 table as before. So our P4 is used twice by the CPU: At the first time, it is interpreted as a P4 table and at the second time as a P3 table.<p>Now only one piece is missing: We need a special P4 entry, which points to the its own table again. This way we can construct a virtual address for which the P4 table is used twice (once as P4 and once as P3).<p>I hope it helps :).<p></div><div class=isso-comment-footer><span class=votes>1</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-74><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=59783d33552a shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Cris</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-74 rel=nofollow><time title="Tue Jun 14 2016 05:23:03 GMT+0200 (Central European Summer Time)" datetime=2016-05-02T03:23:03Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Got it.. thanks</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-75><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=8dec010e6542 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Hoschi</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-75 rel=nofollow><time title="Thu Sep 22 2016 19:20:27 GMT+0200 (Central European Summer Time)" datetime=2016-08-04T17:20:27Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Hi everybody!<p>When I try to compile the code from this article, I get the following error:<p>error: private trait in public interface (error E0445)<p>It's fired here: impl&LTl> Table&LTl> where L: HierarchicalLevel {...}<p>This seems to be one of those errors, caused by the fact, Rust is still under development and some features change from time to time.<p>It compiles if I make the trait public:<br>pub trait HierarchicalLevel: TableLevel {....}<p>I wrote the code on my own and to make sure this is not an error caused by myself, I cloned the github repo and tried to compile it with the same result.<p>Maybe one of the more skilled OS devs here has an idea if it is a problem to mark the trait as public.<p>Thanks in advance!<p>Christian</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-76><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-76 rel=nofollow><time title="Sat Sep 24 2016 11:24:33 GMT+0200 (Central European Summer Time)" datetime=2016-08-06T09:24:33Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks a lot for reporting this! I thought that we've fixed this issue, but it seems like we've messed up somehow. I opened <a href=https://github.com/phil-opp/blog_os/issues/226 rel=nofollow>this issue</a> for it.<p>That said, I think that a public HierarchicalLevel is the correct solution. It shouldn't be a problem since you can't do anything bad by implementing HierarchicalLevel (e.g. you still can't construct a `Table`).</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-77><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=d81257dbb194 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Gil</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-77 rel=nofollow><time title="Tue Nov 22 2016 18:13:24 GMT+0100 (Central European Standard Time)" datetime=2016-10-02T17:13:24Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Hello,<p>You said that the P4 recursive loop must be set before paging is enabled.<br>But I wonder - the memory is currently identity mapped, so what difference is there in P4_table address in with/without paging?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-78><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-78 rel=nofollow><time title="Tue Nov 22 2016 18:52:17 GMT+0100 (Central European Standard Time)" datetime=2016-10-02T17:52:17Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Hmm, good point! The P4 table is part of the identity mapped area, so it should work even if we do it after enabling paging.<p>That sentence was added in <a href=https://github.com/phil-opp/blog_os/pull/246 rel=nofollow>#246</a>, but I don't know the reason anymore. I just tested it and it still works if I do the recursive mapping after paging is enabled. So maybe we should revert that PR‚Ä¶</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-79><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=d81257dbb194 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Gil</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-79 rel=nofollow><time title="Wed Nov 23 2016 12:19:13 GMT+0100 (Central European Standard Time)" datetime=2016-10-03T11:19:13Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks for the clarification :)</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-284><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=23e8cfb6ed1a shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Evan Higgins</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-284 rel=nofollow><time title="Wed May 17 2017 01:34:44 GMT+0200 (Central European Summer Time)" datetime=2017-04-02T23:34:44Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Hi Phil,<br>First off, I just want to say thanks for this tutorial, it's really great.<br>I've run into an issue on this section when implementing the memory::paging::test_paging function. Specifically, with the test for unmap. If everything up to and including the unmap function call is implemented it operates as expected and unmap panics, but if the corresponding println! is added the kernel goes into a boot loop. Based on what you have said in this section that seems to indicate a page fault, but I don't really understand why the existence of that println! causes it. It's more confusing because execution never actually reaches that macro, so it's just the inclusion of that line in the code that triggers it. To make things ever weirder, it quits boot-looping whenever I add a second (or third, etc.) instance of that println! call.<p>So my question is: Do you have any insight as to what could be the cause of this? Or, if nothing else, some avenues I could pursue for debugging?<p>Thanks</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-348><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=7b50508c3b66 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Matthew</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-348 rel=nofollow><time title="Fri Dec 08 2017 00:34:08 GMT+0100 (Central European Standard Time)" datetime=2017-11-04T23:34:08Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Hey Philipp, regarding the Testing and Bugfixing section, can you explain why only a P2 and a P1 table is created after running <code>map_to</code>? Why isn't a P3 table created?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-349><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=7b50508c3b66 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Matthew</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-349 rel=nofollow><time title="Fri Dec 08 2017 01:44:59 GMT+0100 (Central European Standard Time)" datetime=2017-11-05T00:44:59Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>I think I figured it out. Is it because we already mapped index 0 of P4 to a P3 table from <code>boot.asm</code>?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-350><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=c8fed02ed154 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-350 rel=nofollow><time title="Sat Dec 09 2017 17:59:33 GMT+0100 (Central European Standard Time)" datetime=2017-11-06T16:59:33Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Yes, exactly.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-356><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=bc722b76e15e shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Warren</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-356 rel=nofollow><time title="Fri Dec 22 2017 05:18:21 GMT+0100 (Central European Standard Time)" datetime=2017-11-05T04:18:21Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>I've implemented paging and everything seems to work correctly, but reading from an unmapped page causes a page fault even without flushing the translation lookaside buffer. I also tried it out with your repo and it exhibited the same behavior after I commented out the call to tlb::flush. Is there some QEMU setting that I need to change?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-361><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=c8fed02ed154 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-361 rel=nofollow><time title="Tue Jan 02 2018 17:07:14 GMT+0100 (Central European Standard Time)" datetime=2018-00-02T16:07:14Z>vor 12 Monaten</time></a><span class=note></span></div><div class=text><p>If the address isn't cached in the TLB, it works without a flush. The cache has limited space, so some translations are evicted when space runs out. Maybe try accessing the to be unmapped page right before unmapping it?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-360><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3f743f633c6b shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>sieken</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-360 rel=nofollow><time title="Tue Jan 02 2018 05:51:57 GMT+0100 (Central European Standard Time)" datetime=2018-00-02T04:51:57Z>vor 12 Monaten</time></a><span class=note></span></div><div class=text><p>Hi! First of all; This is an amazing project, thank you very much for your time and effort, and the work put down into doing this! I am a complete beginner in Rust, and follow this guide mainly to get a better grasp on operating system "basics". Your tutorials have been very good at explaining the code snippets in a simple manner, but sometimes it gets a bit confusing as to where functions and other code snippets should be placed in the file tree.. If you find the time, could you write the path/filename of where each code snippet goes? I'm sure it would be very helpful to other people who, like me, are not yet intuitive about "what parts go where".</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-362><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=c8fed02ed154 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-362 rel=nofollow><time title="Tue Jan 02 2018 17:17:45 GMT+0100 (Central European Standard Time)" datetime=2018-00-02T16:17:45Z>vor 12 Monaten</time></a><span class=note></span></div><div class=text><p>Thanks for the suggestion! I opened <a href=https://github.com/phil-opp/blog_os/issues/382 rel=nofollow>https://github.com/phil-opp/blog_os/issues/382</a> on Github to track this issue.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-366><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3b8c57b23442 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Anonym</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-366 rel=nofollow><time title="Fri Jan 12 2018 08:32:39 GMT+0100 (Central European Standard Time)" datetime=2018-00-05T07:32:39Z>vor 12 Monaten</time></a><span class=note></span></div><div class=text><p>Hi Phil, when I try to add the test code to test the unmap with the lines of code below, looks like the system can't boot up, and qemu just keeps rebooting. But if I remove this line. the code works perfectly. Could you please help to have a check.<p>println!("{:#x}", unsafe { *(Page::containing_address(addr).start_address() as *const u64) });</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-367><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3b8c57b23442 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Anonym</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-367 rel=nofollow><time title="Fri Jan 12 2018 09:17:59 GMT+0100 (Central European Standard Time)" datetime=2018-00-05T08:17:59Z>vor 12 Monaten</time></a><span class=note></span></div><div class=text><p>The issue has been solved, keep rebooting is caused by the page fault, and the root cause is some index is misused. After correct the index, the issue is gone.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-368><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=aa518cb1f155 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>varp</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-368 rel=nofollow><time title="Thu Jan 18 2018 22:47:12 GMT+0100 (Central European Standard Time)" datetime=2018-00-04T21:47:12Z>vor 11 Monaten</time></a><span class=note></span></div><div class=text><p>Hey Phil. This is a fairly basic question compared to some of the other comments here and I probably am missing something simple. When the Entry::pointed_frame function is made, it uses 0x000fffff_fffff000 to mask bits 12-51. Why that number? It doesn't only mask those bits. What am I missing?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-369><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=5db23f819f9f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-369 rel=nofollow><time title="Fri Jan 19 2018 07:37:02 GMT+0100 (Central European Standard Time)" datetime=2018-00-05T06:37:02Z>vor 11 Monaten</time></a><span class=note></span></div><div class=text><p>It clears the lowest and highest 12 bits. So bits 12 to 51 should be the only bits set afterwards.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-370><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=81bc229622f0 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=20></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>varp</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-370 rel=nofollow><time title="Fri Jan 19 2018 16:56:55 GMT+0100 (Central European Standard Time)" datetime=2018-00-05T15:56:55Z>vor 11 Monaten</time></a><span class=note></span></div><div class=text><p>I realize now I was messing up maths. I was thinking each digit in hex being 16 bits instead of 4 bits. Thanks</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-389><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=719a6678049d shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Jack Halford</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-389 rel=nofollow><time title="Wed Mar 07 2018 11:33:44 GMT+0100 (Central European Standard Time)" datetime=2018-02-03T10:33:44Z>vor 10 Monaten</time></a><span class=note></span></div><div class=text><p>hi phil, quick question<p>It seems that as soon as I enable x86 paging the VGA buffer is not accessible anymore (because 0xb8000 is not identity mapped yet?). So essentially the test_paging routine doesnt print anything... so my thinking tells me the identity map is the first thing to do after enabling paging, yet its the subject of the next chapter, am I not getting something?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-390><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=719a6678049d shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Jack Halford</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-390 rel=nofollow><time title="Mon Mar 12 2018 11:05:38 GMT+0100 (Central European Standard Time)" datetime=2018-02-01T10:05:38Z>vor 10 Monaten</time></a><span class=note></span></div><div class=text><p>I didn't realise the boot.asm p2 p3 p4 setup was already a preliminary identity paging with huge pages, that's awesome! I'm working on x86 protected mode so I only have p1,p2 and my huge pages are 4MiB.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-391><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=c8fed02ed154 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-391 rel=nofollow><time title="Tue Mar 13 2018 21:25:26 GMT+0100 (Central European Standard Time)" datetime=2018-02-02T20:25:26Z>vor 10 Monaten</time></a><span class=note></span></div><div class=text><p>Yeah, paging is enabled since entering longmode (with an identity mapping). Do you have any reason for only choosing protected mode?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div></div></section></section></div><footer class=footer><hr><small> ¬© <time datetime=2017>2017</time>. All rights reserved. <a href=https://os.phil-opp.com/contact/>Contact</a> </small></footer></div><script async data-goatcounter=https://phil-opp.goatcounter.com/count src=//gc.zgo.at/count.js></script>