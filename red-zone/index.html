<!doctype html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="The red zone is an optimization of the System V ABI that allows functions to temporarily use the 128 bytes below its stack frame without adjusting the stack pointer:
">
    <meta name="author" content="Philipp Oppermann">

    
        <link rel="canonical" href="https://os.phil-opp.com/red-zone/" />
    
    <link href="/css/poole.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">

    <script async src="/js/main.js"></script>

    <title>Disable the Red Zone | Writing an OS in Rust</title>
</head>

<body>
    <div class="container content">
        <header class="masthead">
            <div style="position:relative">
                <h1 class="masthead-title">
                    <a href="https://os.phil-opp.com" title="Home">Writing an OS in Rust</a>
                </h1>
                <p><small>Philipp&nbsp;Oppermann's&nbsp;blog</small></p>
                
            </div>
        </header>

        <main>
    <h1>Disable the Red Zone</h1>
    <p>The <a href="http://eli.thegreenplace.net/2011/09/06/stack-frame-layout-on-x86-64#the-red-zone">red zone</a> is an optimization of the <a href="http://wiki.osdev.org/System_V_ABI">System V ABI</a> that allows functions to temporarily use the 128 bytes below its stack frame without adjusting the stack pointer:</p>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<p><img src="https://os.phil-opp.com/red-zone/red-zone.svg" alt="stack frame with red zone" /></p>
<p>The image shows the stack frame of a function with <code>n</code> local variables. On function entry, the stack pointer is adjusted to make room on the stack for the return address and the local variables.</p>
<p>The red zone is defined as the 128 bytes below the adjusted stack pointer. The function can use this area for temporary data that's not needed across function calls. Thus, the two instructions for adjusting the stack pointer can be avoided in some cases (e.g. in small leaf functions).</p>
<p>However, this optimization leads to huge problems with exceptions or hardware interrupts. Let's assume that an exception occurs while a function uses the red zone:</p>
<p><img src="https://os.phil-opp.com/red-zone/red-zone-overwrite.svg" alt="red zone overwritten by exception handler" /></p>
<p>The CPU and the exception handler overwrite the data in red zone. But this data is still needed by the interrupted function. So the function won't work correctly anymore when we return from the exception handler. This might lead to strange bugs that <a href="http://forum.osdev.org/viewtopic.php?t=21720">take weeks to debug</a>.</p>
<p>To avoid such bugs when we implement exception handling in the future, we disable the red zone right from the beginning. This is achieved by adding the <code>&quot;disable-redzone&quot;: true</code> line to our target configuration file.</p>

</main>

        <div>
    <hr>
    <section>
        <h2>Comments</h2>
        
    <script src="https://utteranc.es/client.js"
        data-repo="phil-opp/blog_os"
        data-issue-term="url"
        data-label="comments"
        crossorigin="anonymous"
        async>
    </script>

    </section>
</div>

        <footer class="footer">
            <hr>
            <small>
                &copy; <time datetime="2020">2020</time>. All rights reserved.
                <a href="https://os.phil-opp.com/contact/">Contact</a>
            </small>
        </footer>
    </div>

    <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
    <script>
        (function(f, a, t, h, o, m){
            a[h]=a[h]||function(){
                (a[h].q=a[h].q||[]).push(arguments)
            };
            o=f.createElement('script'),
            m=f.getElementsByTagName('script')[0];
            o.async=1; o.src=t; o.id='fathom-script';
            m.parentNode.insertBefore(o,m)
        })(document, window, '//fathom.phil-opp.com/tracker.js', 'fathom');
        fathom('set', 'siteId', 'MUXWM');
        fathom('trackPageview');
    </script>
    <!-- / Fathom -->
</body>

</html>
