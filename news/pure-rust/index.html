<!doctype html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <meta name="description" content="This blog series creates a small operating system in the Rust programming language. Each post is a small tutorial and includes all needed code.">
    <meta name="author" content="Philipp Oppermann">

    
        <link rel="canonical" href="https://os.phil-opp.com/news/pure-rust/" />
    
    <link href="/css/edition-2/main.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="RSS feed for os.phil-opp.com" href="https://os.phil-opp.com/rss.xml" />

    <script>
        let theme = localStorage.getItem("theme");
        if (theme != null) {
            document.documentElement.setAttribute("data-theme", theme);
        }
    </script>

    <script async src="/js/edition-2/main.js"></script>

    <title>Writing an OS in pure Rust | Writing an OS in Rust</title>
</head>

<body>
    <div class="container content">
        <header class="masthead">
            <div style="position:relative">
                <h2 class="masthead-title">
                    <a href="https://os.phil-opp.com" title="Home">Writing an OS in Rust</a>
                </h2>
                <p><small>Philipp&nbsp;Oppermann's&nbsp;blog</small></p>
                
            </div>
        </header>

        <div class="theme-switch">
            <div class="light-switch" onclick="toggle_lights()" title="Switch between light and dark theme"></div>
            <div class="light-switch-reset" onclick="clear_theme_override()" title="Clear the theme override and go back to the system theme"></div>
        </div>

        <div>
            
            <main>
    <h1>Writing an OS in pure Rust</h1>
    <time datetime="2018-03-09" class="post-date">
        Mar 09, 2018
        
    </time>
    <p>Over the past six months we’ve been working on a second edition of this blog. Our goals for this new version are <a href="https://github.com/phil-opp/blog_os/issues/360">numerous</a> and we are still not done yet, but today we reached a major milestone: It is now possible to build the OS natively on Windows, macOS, and Linux <strong>without any non-Rust dependendencies</strong>.</p>
<span id="continue-reading"></span>
<p>The <a href="https://os.phil-opp.com/edition-1/">first edition</a> required several C-tools for building:</p>
<ul>
<li>We used the <a href="https://www.gnu.org/software/grub/"><code>GRUB</code></a> bootloader for booting our kernel. To create a bootable disk/CD image we used the <a href="https://www.gnu.org/software/grub/manual/grub/html_node/Invoking-grub_002dmkrescue.html"><code>grub-mkrescue</code></a> tool, which is very difficult to get to run on Windows.</li>
<li>The <a href="https://www.gnu.org/software/xorriso/"><code>xorriso</code></a> program was also required, because it is used by <code>grub-mkrescue</code>.</li>
<li>GRUB only boots to protected mode, so we needed some assembly code for <a href="https://os.phil-opp.com/entering-longmode/">entering long mode</a>. For building the assembly code, we used the <a href="https://www.nasm.us/xdoc/2.13.03/html/nasmdoc1.html"><code>nasm</code></a> assembler.</li>
<li>We used the GNU linker <a href="https://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_node/ld_3.html"><code>ld</code></a> for linking together the assembly files with the rust code, using a custom <a href="https://sourceware.org/binutils/docs/ld/Scripts.html">linker script</a>.</li>
<li>Finally, we used <a href="https://www.gnu.org/software/make/"><code>make</code></a> for automating the various build steps (assembling, compiling the Rust code, linking, invoking <code>grub-mkrescue</code>).</li>
</ul>
<p>We got lots of feedback that this setup was difficult to get running <a href="https://github.com/phil-opp/blog_os/issues/55">under macOS</a> and Windows. As a workaround, we <a href="https://github.com/phil-opp/blog_os/pull/373">added support for docker</a>, but that still required users to install and understand an additional dependency. So when we decided to create a second edition of the blog - originally because the order of posts led to jumps in difficulty - we thought about how we could avoid these C-dependencies.</p>
<p>There are lots of alternatives to <code>make</code>, including some Rust tools such as <a href="https://github.com/casey/just">just</a> and <a href="https://sagiegurari.github.io/cargo-make/">cargo-make</a>. Avoiding <code>nasm</code> is also possible by using Rust’s <a href="https://doc.rust-lang.org/stable/core/arch/macro.global_asm.html"><code>global_asm</code></a> feature instead. So there are only two problems left: the bootloader and the linker.</p>
<h2 id="a-custom-bootloader">A custom Bootloader</h2>
<p>To avoid the dependency on GRUB and to make things more ergonomic, we decided to write <a href="https://github.com/rust-osdev/bootloader">our own bootloader</a> using Rust’s <a href="https://doc.rust-lang.org/stable/core/arch/macro.global_asm.html"><code>global_asm</code></a> feature. This way, the kernel can be significantly simplified, since the switch to long mode and the initial page table layout can already be done in the bootloader. Thus, we can avoid the initial assembly level blog posts in the second edition and directly start with high level Rust code.</p>
<p>The bootloader is still an early prototype, but it is already capable of switching to long mode and loading the kernel in form of an 64-bit ELF binary. It also performs the correct page table mapping (with the correct read/write/execute permissions) as it’s specified in the ELF file and creates an initial physical memory map.</p>
<p>The plan for the future is to make the bootloader more stable, add documentation, and ultimately add a “Writing a Bootloader” series to the blog, which explains in detail how the bootloader works.</p>
<h2 id="linking-with-lld">Linking with LLD</h2>
<p>With our custom bootloader in place, the last remaining problem is platform independent linking. Fortunately there is <a href="https://lld.llvm.org/"><code>LLD</code></a>, the cross-platform linker from the LLVM project, which is already very stable for the <code>x86</code> architecture. As a bonus, <code>LLD</code> is <a href="https://github.com/rust-lang/rust/pull/48125">now shipped with Rust</a>, which means that it can be used without any extra installation.</p>
<h2 id="the-new-posts">The new Posts</h2>
<p>The second edition is already live at <a href="https://os.phil-opp.com/edition-2/">https://os.phil-opp.com/second-edition</a>. Please tell us if you have any feedback on the new posts! We’re planning to move over the content from the <a href="https://os.phil-opp.com/edition-1/">first edition</a> iteratively, in a different order and with various other improvements.</p>
<p>Many thanks to everyone who helped to make Rust an even better language for OS development!</p>

</main>
        </div>

        <div>
    <hr>
    <section>
        <h2 id="comments">Comments</h2>
        
    
        
        
        
    

    
        
        
    

    <p class="comment-note">
        Do you have a problem, want to share feedback, or discuss further ideas? Feel free to leave a comment here! Please stick to English and follow Rust's <a href="https://www.rust-lang.org/policies/code-of-conduct">code of conduct</a>. This comment thread directly maps to a <a href="https://github.com/phil-opp/blog_os/discussions/categories/post-comments?discussions_q=%22Writing%20an%20OS%20in%20pure%20Rust%20%28News%20Post%29%22%20in%3Atitle"><em>discussion on GitHub</em></a>, so you can also comment there if you prefer.

    </p>

    <div class="giscus"></div>

    <script src="https://giscus.app/client.js"
        data-repo="phil-opp/blog_os"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzOTU3NTEwMQ=="
        data-category="Post Comments"
        data-category-id="MDE4OkRpc2N1c3Npb25DYXRlZ29yeTMzMDE4OTg1"
    
        data-mapping="specific"
    
        data-term="Writing an OS in pure Rust (News Post)"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
    </script>

    <p class="comment-directly-on-github">
        Instead of authenticating the <a href="https://giscus.app">giscus</a> application, you can also comment directly <a href="https://github.com/phil-opp/blog_os/discussions/categories/post-comments?discussions_q=%22Writing%20an%20OS%20in%20pure%20Rust%20%28News%20Post%29%22%20in%3Atitle"><em>on GitHub</em></a>.
    </p>

    </section>

</div>

        <footer class="footer">
            <hr>
            <small>
                &copy; <time datetime="2022">2022</time>. All rights reserved.
                <a class="spaced" href="https://github.com/phil-opp/blog_os#license">License</a>
                <a class="spaced" href="https://os.phil-opp.com/contact/">Contact</a>
            </small>
        </footer>
    </div>
</body>

</html>
