<!doctype html><html lang=en><head><meta charset=UTF-8><meta content=yes name=apple-mobile-web-app-capable><meta content="width=device-width,initial-scale=1" name=viewport><meta content="This blog series creates a small operating system in the Rust programming language. Each post is a small tutorial and includes all needed code." name=description><meta content="Philipp Oppermann" name=author><link href=/css/edition-1/poole.css rel=stylesheet><link href=/css/edition-1/main.css rel=stylesheet><link href=/css/edition-1/isso.css rel=stylesheet><script async src=/js/edition-1/main.js></script><title>Entering Long Mode | Writing an OS in Rust (First Edition)</title><body><div class="container content"><header class=masthead><h2 class=masthead-title><a href=/edition-1 title=Home>Writing an OS in Rust (First Edition)</a></h2><p><small>Philipp¬†Oppermann's¬†blog</small></header><main><h1>Entering Long Mode</h1><time class=post-date datetime=2015-08-25> Aug 25, 2015 (updated on Oct 29, 2015) </time><aside id=toc-aside><h2>Table of Contents</h2><ol><li><a href=#some-tests>Some Tests</a> <ol><li><a href=#creating-a-stack>Creating a Stack</a><li><a href=#multiboot-check>Multiboot check</a><li><a href=#cpuid-check>CPUID check</a><li><a href=#long-mode-check>Long Mode check</a><li><a href=#putting-it-together>Putting it together</a></ol><li><a href=#paging>Paging</a> <ol><li><a href=#set-up-identity-paging>Set Up Identity Paging</a><li><a href=#enable-paging>Enable Paging</a></ol><li><a href=#the-global-descriptor-table>The Global Descriptor Table</a> <ol><li><a href=#loading-the-gdt>Loading the GDT</a></ol><li><a href=#what-s-next>What‚Äôs next?</a><li><a href=#footnotes>Footnotes</a></ol></aside><div class=warning><b>No longer updated!</b> You are viewing the a post of the first edition of ‚ÄúWriting an OS in Rust‚Äù, which is no longer updated. You can find the second edition <a href=https://os.phil-opp.com/edition-2/>here</a>.</div><p>In the <a href=https://os.phil-opp.com/multiboot-kernel/>previous post</a> we created a minimal multiboot kernel. It just prints <code>OK</code> and hangs. The goal is to extend it and call 64-bit <a href=https://www.rust-lang.org/>Rust</a> code. But the CPU is currently in <a href=https://en.wikipedia.org/wiki/Protected_mode>protected mode</a> and allows only 32-bit instructions and up to 4GiB memory. So we need to set up <em>Paging</em> and switch to the 64-bit <a href=https://en.wikipedia.org/wiki/Long_mode>long mode</a> first.</p><span id=continue-reading></span><p>I tried to explain everything in detail and to keep the code as simple as possible. If you have any questions, suggestions, or issues, please leave a comment or <a href=https://github.com/phil-opp/blog_os/issues>create an issue</a> on Github. The source code is available in a <a href=https://github.com/phil-opp/blog_os/tree/first_edition_post_2/src/arch/x86_64>repository</a>, too.<h2 id=some-tests><a aria-label="Anchor link for: some-tests" class=zola-anchor href=#some-tests>üîó</a>Some Tests</h2><p>To avoid bugs and strange errors on old CPUs we should check if the processor supports every needed feature. If not, the kernel should abort and display an error message. To handle errors easily, we create an error procedure in <code>boot.asm</code>. It prints a rudimentary <code>ERR: X</code> message, where X is an error code letter, and hangs:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span style=color:#608b4e;>; Prints `ERR: ` and the given error code to screen and hangs.
</span><span style=color:#608b4e;>; parameter: error code (in ascii) in al
</span><span>error:
</span><span>    </span><span style=color:#569cd6;>mov </span><span>dword [</span><span style=color:#b4cea8;>0xb8000</span><span>], </span><span style=color:#b4cea8;>0x4f524f45
</span><span>    </span><span style=color:#569cd6;>mov </span><span>dword [</span><span style=color:#b4cea8;>0xb8004</span><span>], </span><span style=color:#b4cea8;>0x4f3a4f52
</span><span>    </span><span style=color:#569cd6;>mov </span><span>dword [</span><span style=color:#b4cea8;>0xb8008</span><span>], </span><span style=color:#b4cea8;>0x4f204f20
</span><span>    </span><span style=color:#569cd6;>mov </span><span>byte  [</span><span style=color:#b4cea8;>0xb800a</span><span>], al
</span><span>    </span><span style=color:#569cd6;>hlt
</span></code></pre><p>At address <code>0xb8000</code> begins the so-called <a href=https://en.wikipedia.org/wiki/VGA-compatible_text_mode>VGA text buffer</a>. It‚Äôs an array of screen characters that are displayed by the graphics card. A <a href=https://os.phil-opp.com/printing-to-screen/>future post</a> will cover the VGA buffer in detail and create a Rust interface to it. But for now, manual bit-fiddling is the easiest option.<p>A screen character consists of a 8 bit color code and a 8 bit <a href=https://en.wikipedia.org/wiki/ASCII>ASCII</a> character. We used the color code <code>4f</code> for all characters, which means white text on red background. <code>0x52</code> is an ASCII <code>R</code>, <code>0x45</code> is an <code>E</code>, <code>0x3a</code> is a <code>:</code>, and <code>0x20</code> is a space. The second space is overwritten by the given ASCII byte. Finally the CPU is stopped with the <code>hlt</code> instruction.<p>Now we can add some check <em>functions</em>. A function is just a normal label with an <code>ret</code> (return) instruction at the end. The <code>call</code> instruction can be used to call it. Unlike the <code>jmp</code> instruction that just jumps to a memory address, the <code>call</code> instruction will push a return address to the stack (and the <code>ret</code> will jump to this address). But we don‚Äôt have a stack yet. The <a href=https://stackoverflow.com/a/1464052/866447>stack pointer</a> in the esp register could point to some important data or even invalid memory. So we need to update it and point it to some valid stack memory.<h3 id=creating-a-stack><a aria-label="Anchor link for: creating-a-stack" class=zola-anchor href=#creating-a-stack>üîó</a>Creating a Stack</h3><p>To create stack memory we reserve some bytes at the end of our <code>boot.asm</code>:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>...
</span><span>section .bss
</span><span>stack_bottom:
</span><span>    resb </span><span style=color:#b4cea8;>64
</span><span>stack_top:
</span></code></pre><p>A stack doesn‚Äôt need to be initialized because we will <code>pop</code> only when we <code>pushed</code> before. So storing the stack memory in the executable file would make it unnecessary large. By using the <a href=https://en.wikipedia.org/wiki/.bss>.bss</a> section and the <code>resb</code> (reserve byte) command, we just store the length of the uninitialized data (= 64). When loading the executable, GRUB will create the section of required size in memory.<p>To use the new stack, we update the stack pointer register right after <code>start</code>:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>global start
</span><span>
</span><span>section .text
</span><span>bits 32
</span><span>start:
</span><span>    </span><span style=color:#569cd6;>mov </span><span>esp, stack_top
</span><span>
</span><span style=color:#608b4e;>    ; print `OK` to screen
</span><span>    ...
</span></code></pre><p>We use <code>stack_top</code> because the stack grows downwards: A <code>push eax</code> subtracts 4 from <code>esp</code> and does a <code>mov [esp], eax</code> afterwards (<code>eax</code> is a general purpose register).<p>Now we have a valid stack pointer and are able to call functions. The following check functions are just here for completeness and I won‚Äôt explain details. Basically they all work the same: They will check for a feature and jump to <code>error</code> if it‚Äôs not available.<h3 id=multiboot-check><a aria-label="Anchor link for: multiboot-check" class=zola-anchor href=#multiboot-check>üîó</a>Multiboot check</h3><p>We rely on some Multiboot features in the next posts. To make sure the kernel was really loaded by a Multiboot compliant bootloader, we can check the <code>eax</code> register. According to the Multiboot specification (<a href=https://nongnu.askapache.com/grub/phcoder/multiboot.pdf>PDF</a>), the bootloader must write the magic value <code>0x36d76289</code> to it before loading a kernel. To verify that we can add a simple function:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>check_multiboot:
</span><span>    </span><span style=color:#569cd6;>cmp </span><span>eax, </span><span style=color:#b4cea8;>0x36d76289
</span><span>    </span><span style=color:#569cd6;>jne </span><span>.no_multiboot
</span><span>    </span><span style=color:#569cd6;>ret
</span><span>.no_multiboot:
</span><span>    </span><span style=color:#569cd6;>mov </span><span>al, </span><span style=color:#d69d85;>"0"
</span><span>    </span><span style=color:#569cd6;>jmp </span><span>error
</span></code></pre><p>We use the <code>cmp</code> instruction to compare the value in <code>eax</code> to the magic value. If the values are equal, the <code>cmp</code> instruction sets the zero flag in the <a href=https://en.wikipedia.org/wiki/FLAGS_register>FLAGS register</a>. The <code>jne</code> (‚Äújump if not equal‚Äù) instruction reads this zero flag and jumps to the given address if it‚Äôs not set. Thus we jump to the <code>.no_multiboot</code> label if <code>eax</code> does not contain the magic value.<p>In <code>no_multiboot</code>, we use the <code>jmp</code> (‚Äújump‚Äù) instruction to jump to our error function. We could just as well use the <code>call</code> instruction, which additionally pushes the return address. But the return address is not needed because <code>error</code> never returns. To pass <code>0</code> as error code to the <code>error</code> function, we move it into <code>al</code> before the jump (<code>error</code> will read it from there).<h3 id=cpuid-check><a aria-label="Anchor link for: cpuid-check" class=zola-anchor href=#cpuid-check>üîó</a>CPUID check</h3><p><a href=https://wiki.osdev.org/CPUID>CPUID</a> is a CPU instruction that can be used to get various information about the CPU. But not every processor supports it. CPUID detection is quite laborious, so we just copy a detection function from the <a href=https://wiki.osdev.org/Setting_Up_Long_Mode#Detection_of_CPUID>OSDev wiki</a>:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>check_cpuid:
</span><span style=color:#608b4e;>    ; Check if CPUID is supported by attempting to flip the ID bit (bit 21)
</span><span style=color:#608b4e;>    ; in the FLAGS register. If we can flip it, CPUID is available.
</span><span>
</span><span style=color:#608b4e;>    ; Copy FLAGS in to EAX via stack
</span><span>    </span><span style=color:#569cd6;>pushfd
</span><span>    </span><span style=color:#569cd6;>pop </span><span>eax
</span><span>
</span><span style=color:#608b4e;>    ; Copy to ECX as well for comparing later on
</span><span>    </span><span style=color:#569cd6;>mov </span><span>ecx, eax
</span><span>
</span><span style=color:#608b4e;>    ; Flip the ID bit
</span><span>    </span><span style=color:#569cd6;>xor </span><span>eax, </span><span style=color:#b4cea8;>1 </span><span><< </span><span style=color:#b4cea8;>21
</span><span>
</span><span style=color:#608b4e;>    ; Copy EAX to FLAGS via the stack
</span><span>    </span><span style=color:#569cd6;>push </span><span>eax
</span><span>    </span><span style=color:#569cd6;>popfd
</span><span>
</span><span style=color:#608b4e;>    ; Copy FLAGS back to EAX (with the flipped bit if CPUID is supported)
</span><span>    </span><span style=color:#569cd6;>pushfd
</span><span>    </span><span style=color:#569cd6;>pop </span><span>eax
</span><span>
</span><span style=color:#608b4e;>    ; Restore FLAGS from the old version stored in ECX (i.e. flipping the
</span><span style=color:#608b4e;>    ; ID bit back if it was ever flipped).
</span><span>    </span><span style=color:#569cd6;>push </span><span>ecx
</span><span>    </span><span style=color:#569cd6;>popfd
</span><span>
</span><span style=color:#608b4e;>    ; Compare EAX and ECX. If they are equal then that means the bit
</span><span style=color:#608b4e;>    ; wasn't flipped, and CPUID isn't supported.
</span><span>    </span><span style=color:#569cd6;>cmp </span><span>eax, ecx
</span><span>    </span><span style=color:#569cd6;>je </span><span>.no_cpuid
</span><span>    </span><span style=color:#569cd6;>ret
</span><span>.no_cpuid:
</span><span>    </span><span style=color:#569cd6;>mov </span><span>al, </span><span style=color:#d69d85;>"1"
</span><span>    </span><span style=color:#569cd6;>jmp </span><span>error
</span></code></pre><p>Basically, the <code>CPUID</code> instruction is supported if we can flip some bit in the <a href=https://en.wikipedia.org/wiki/FLAGS_register>FLAGS register</a>. We can‚Äôt operate on the flags register directly, so we need to load it into some general purpose register such as <code>eax</code> first. The only way to do this is to push the <code>FLAGS</code> register on the stack through the <code>pushfd</code> instruction and then pop it into <code>eax</code>. Equally, we write it back through <code>push ecx</code> and <code>popfd</code>. To flip the bit we use the <code>xor</code> instruction to perform an <a href=https://en.wikipedia.org/wiki/Exclusive_or>exclusive OR</a>. Finally we compare the two values and jump to <code>.no_cpuid</code> if both are equal (<code>je</code> ‚Äì ‚Äújump if equal‚Äù). The <code>.no_cpuid</code> code just jumps to the <code>error</code> function with error code <code>1</code>.<p>Don‚Äôt worry, you don‚Äôt need to understand the details.<h3 id=long-mode-check><a aria-label="Anchor link for: long-mode-check" class=zola-anchor href=#long-mode-check>üîó</a>Long Mode check</h3><p>Now we can use CPUID to detect whether long mode can be used. I use code from <a href=https://wiki.osdev.org/Setting_Up_Long_Mode#x86_or_x86-64>OSDev</a> again:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>check_long_mode:
</span><span style=color:#608b4e;>    ; test if extended processor info in available
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, </span><span style=color:#b4cea8;>0x80000000</span><span style=color:#608b4e;>    ; implicit argument for cpuid
</span><span>    </span><span style=color:#569cd6;>cpuid</span><span style=color:#608b4e;>                  ; get highest supported argument
</span><span>    </span><span style=color:#569cd6;>cmp </span><span>eax, </span><span style=color:#b4cea8;>0x80000001</span><span style=color:#608b4e;>    ; it needs to be at least 0x80000001
</span><span>    </span><span style=color:#569cd6;>jb </span><span>.no_long_mode</span><span style=color:#608b4e;>       ; if it's less, the CPU is too old for long mode
</span><span>
</span><span style=color:#608b4e;>    ; use extended info to test if long mode is available
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, </span><span style=color:#b4cea8;>0x80000001</span><span style=color:#608b4e;>    ; argument for extended processor info
</span><span>    </span><span style=color:#569cd6;>cpuid</span><span style=color:#608b4e;>                  ; returns various feature bits in ecx and edx
</span><span>    </span><span style=color:#569cd6;>test </span><span>edx, </span><span style=color:#b4cea8;>1 </span><span><< </span><span style=color:#b4cea8;>29</span><span style=color:#608b4e;>      ; test if the LM-bit is set in the D-register
</span><span>    </span><span style=color:#569cd6;>jz </span><span>.no_long_mode</span><span style=color:#608b4e;>       ; If it's not set, there is no long mode
</span><span>    </span><span style=color:#569cd6;>ret
</span><span>.no_long_mode:
</span><span>    </span><span style=color:#569cd6;>mov </span><span>al, </span><span style=color:#d69d85;>"2"
</span><span>    </span><span style=color:#569cd6;>jmp </span><span>error
</span></code></pre><p>Like many low-level things, CPUID is a bit strange. Instead of taking a parameter, the <code>cpuid</code> instruction implicitly uses the <code>eax</code> register as argument. To test if long mode is available, we need to call <code>cpuid</code> with <code>0x80000001</code> in <code>eax</code>. This loads some information to the <code>ecx</code> and <code>edx</code> registers. Long mode is supported if the 29th bit in <code>edx</code> is set. <a href=https://en.wikipedia.org/wiki/CPUID#EAX.3D80000001h:_Extended_Processor_Info_and_Feature_Bits>Wikipedia</a> has detailed information.<p>If you look at the assembly above, you‚Äôll probably notice that we call <code>cpuid</code> twice. The reason is that the CPUID command started with only a few functions and was extended over time. So old processors may not know the <code>0x80000001</code> argument at all. To test if they do, we need to invoke <code>cpuid</code> with <code>0x80000000</code> in <code>eax</code> first. It returns the highest supported parameter value in <code>eax</code>. If it‚Äôs at least <code>0x80000001</code>, we can test for long mode as described above. Else the CPU is old and doesn‚Äôt know what long mode is either. In that case, we directly jump to <code>.no_long_mode</code> through the <code>jb</code> instruction (‚Äújump if below‚Äù).<h3 id=putting-it-together><a aria-label="Anchor link for: putting-it-together" class=zola-anchor href=#putting-it-together>üîó</a>Putting it together</h3><p>We just call these check functions right after start:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>global start
</span><span>
</span><span>section .text
</span><span>bits 32
</span><span>start:
</span><span>    </span><span style=color:#569cd6;>mov </span><span>esp, stack_top
</span><span>
</span><span>    </span><span style=color:#569cd6;>call </span><span>check_multiboot
</span><span>    </span><span style=color:#569cd6;>call </span><span>check_cpuid
</span><span>    </span><span style=color:#569cd6;>call </span><span>check_long_mode
</span><span>
</span><span style=color:#608b4e;>    ; print `OK` to screen
</span><span>    ...
</span></code></pre><p>When the CPU doesn‚Äôt support a needed feature, we get an error message with an unique error code. Now we can start the real work.<h2 id=paging><a aria-label="Anchor link for: paging" class=zola-anchor href=#paging>üîó</a>Paging</h2><p><em>Paging</em> is a memory management scheme that separates virtual and physical memory. The address space is split into equal sized <em>pages</em> and a <em>page table</em> specifies which virtual page points to which physical page. If you never heard of paging, you might want to look at the paging introduction (<a href=http://pages.cs.wisc.edu/%7Eremzi/OSTEP/vm-paging.pdf>PDF</a>) of the <a href=http://pages.cs.wisc.edu/%7Eremzi/OSTEP/>Three Easy Pieces</a> OS book.<p>In long mode, x86 uses a page size of 4096 bytes and a 4 level page table that consists of:<ul><li>the Page-Map Level-4 Table (PML4),<li>the Page-Directory Pointer Table (PDP),<li>the Page-Directory Table (PD),<li>and the Page Table (PT).</ul><p>As I don‚Äôt like these names, I will call them P4, P3, P2, and P1 from now on.<p>Each page table contains 512 entries and one entry is 8 bytes, so they fit exactly in one page (<code>512*8 = 4096</code>). To translate a virtual address to a physical address the CPU<sup class=footnote-reference><a href=#hardware_lookup>1</a></sup> will do the following<sup class=footnote-reference><a href=#virtual_physical_translation_source>2</a></sup>:<p><img alt="translation of virtual to physical addresses in 64 bit mode" src=X86_Paging_64bit.svg><ol><li>Get the address of the P4 table from the CR3 register<li>Use bits 39-47 (9 bits) as an index into P4 (<code>2^9 = 512 = number of entries</code>)<li>Use the following 9 bits as an index into P3<li>Use the following 9 bits as an index into P2<li>Use the following 9 bits as an index into P1<li>Use the last 12 bits as page offset (<code>2^12 = 4096 = page size</code>)</ol><p>But what happens to bits 48-63 of the 64-bit virtual address? Well, they can‚Äôt be used. The ‚Äú64-bit‚Äù long mode is in fact just a 48-bit mode. The bits 48-63 must be copies of bit 47, so each valid virtual address is still unique. For more information see <a href=https://en.wikipedia.org/wiki/X86-64#Virtual_address_space_details>Wikipedia</a>.<p>An entry in the P4, P3, P2, and P1 tables consists of the page aligned 52-bit <em>physical</em> address of the frame or the next page table and the following bits that can be OR-ed in:<table><thead><tr><th>Bit(s)<th>Name<th>Meaning<tbody><tr><td>0<td>present<td>the page is currently in memory<tr><td>1<td>writable<td>it‚Äôs allowed to write to this page<tr><td>2<td>user accessible<td>if not set, only kernel mode code can access this page<tr><td>3<td>write through caching<td>writes go directly to memory<tr><td>4<td>disable cache<td>no cache is used for this page<tr><td>5<td>accessed<td>the CPU sets this bit when this page is used<tr><td>6<td>dirty<td>the CPU sets this bit when a write to this page occurs<tr><td>7<td>huge page/null<td>must be 0 in P1 and P4, creates a 1GiB page in P3, creates a 2MiB page in P2<tr><td>8<td>global<td>page isn‚Äôt flushed from caches on address space switch (PGE bit of CR4 register must be set)<tr><td>9-11<td>available<td>can be used freely by the OS<tr><td>52-62<td>available<td>can be used freely by the OS<tr><td>63<td>no execute<td>forbid executing code on this page (the NXE bit in the EFER register must be set)</table><h3 id=set-up-identity-paging><a aria-label="Anchor link for: set-up-identity-paging" class=zola-anchor href=#set-up-identity-paging>üîó</a>Set Up Identity Paging</h3><p>When we switch to long mode, paging will be activated automatically. The CPU will then try to read the instruction at the following address, but this address is now a virtual address. So we need to do <em>identity mapping</em>, i.e. map a physical address to the same virtual address.<p>The <code>huge page</code> bit is now very useful to us. It creates a 2MiB (when used in P2) or even a 1GiB page (when used in P3). So we could map the first <em>gigabytes</em> of the kernel with only one P4 and one P3 table by using 1GiB pages. Unfortunately 1GiB pages are relatively new feature, for example Intel introduced it 2010 in the <a href=https://en.wikipedia.org/wiki/Westmere_(microarchitecture)#Technology>Westmere architecture</a>. Therefore we will use 2MiB pages instead to make our kernel compatible to older computers, too.<p>To identity map the first gigabyte of our kernel with 512 2MiB pages, we need one P4, one P3, and one P2 table. Of course we will replace them with finer-grained tables later. But now that we‚Äôre stuck with assembly, we choose the easiest way.<p>We can add these two tables at the beginning<sup class=footnote-reference><a href=#page_table_alignment>3</a></sup> of the <code>.bss</code> section:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>...
</span><span>
</span><span>section .bss
</span><span>align </span><span style=color:#b4cea8;>4096
</span><span>p4_table:
</span><span>    resb </span><span style=color:#b4cea8;>4096
</span><span>p3_table:
</span><span>    resb </span><span style=color:#b4cea8;>4096
</span><span>p2_table:
</span><span>    resb </span><span style=color:#b4cea8;>4096
</span><span>stack_bottom:
</span><span>    resb </span><span style=color:#b4cea8;>64
</span><span>stack_top:
</span></code></pre><p>The <code>resb</code> command reserves the specified amount of bytes without initializing them, so the 8KiB don‚Äôt need to be saved in the executable. The <code>align 4096</code> ensures that the page tables are page aligned.<p>When GRUB creates the <code>.bss</code> section in memory, it will initialize it to <code>0</code>. So the <code>p4_table</code> is already valid (it contains 512 non-present entries) but not very useful. To be able to map 2MiB pages, we need to link P4‚Äôs first entry to the <code>p3_table</code> and P3‚Äôs first entry to the the <code>p2_table</code>:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>set_up_page_tables:
</span><span style=color:#608b4e;>    ; map first P4 entry to P3 table
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, p3_table
</span><span>    </span><span style=color:#569cd6;>or </span><span>eax, 0b11</span><span style=color:#608b4e;> ; present + writable
</span><span>    </span><span style=color:#569cd6;>mov </span><span>[p4_table], eax
</span><span>
</span><span style=color:#608b4e;>    ; map first P3 entry to P2 table
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, p2_table
</span><span>    </span><span style=color:#569cd6;>or </span><span>eax, 0b11</span><span style=color:#608b4e;> ; present + writable
</span><span>    </span><span style=color:#569cd6;>mov </span><span>[p3_table], eax
</span><span>
</span><span style=color:#608b4e;>    ; TODO map each P2 entry to a huge 2MiB page
</span><span>    </span><span style=color:#569cd6;>ret
</span></code></pre><p>We just set the present and writable bits (<code>0b11</code> is a binary number) in the aligned P3 table address and move it to the first 4 bytes of the P4 table. Then we do the same to link the first P3 entry to the <code>p2_table</code>.<p>Now we need to map P2‚Äôs first entry to a huge page starting at 0, P2‚Äôs second entry to a huge page starting at 2MiB, P2‚Äôs third entry to a huge page starting at 4MiB, and so on. It‚Äôs time for our first (and only) assembly loop:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>set_up_page_tables:
</span><span>    ...
</span><span style=color:#608b4e;>    ; map each P2 entry to a huge 2MiB page
</span><span>    </span><span style=color:#569cd6;>mov </span><span>ecx, </span><span style=color:#b4cea8;>0</span><span style=color:#608b4e;>         ; counter variable
</span><span>
</span><span>.map_p2_table:
</span><span style=color:#608b4e;>    ; map ecx-th P2 entry to a huge page that starts at address 2MiB*ecx
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, </span><span style=color:#b4cea8;>0x200000</span><span style=color:#608b4e;>  ; 2MiB
</span><span>    </span><span style=color:#569cd6;>mul </span><span>ecx</span><span style=color:#608b4e;>            ; start address of ecx-th page
</span><span>    </span><span style=color:#569cd6;>or </span><span>eax, 0b10000011</span><span style=color:#608b4e;> ; present + writable + huge
</span><span>    </span><span style=color:#569cd6;>mov </span><span>[p2_table + ecx * </span><span style=color:#b4cea8;>8</span><span>], eax</span><span style=color:#608b4e;> ; map ecx-th entry
</span><span>
</span><span>    </span><span style=color:#569cd6;>inc </span><span>ecx</span><span style=color:#608b4e;>            ; increase counter
</span><span>    </span><span style=color:#569cd6;>cmp </span><span>ecx, </span><span style=color:#b4cea8;>512</span><span style=color:#608b4e;>       ; if counter == 512, the whole P2 table is mapped
</span><span>    </span><span style=color:#569cd6;>jne </span><span>.map_p2_table</span><span style=color:#608b4e;>  ; else map the next entry
</span><span>
</span><span>    </span><span style=color:#569cd6;>ret
</span></code></pre><p>Maybe I should first explain how an assembly loop works. We use the <code>ecx</code> register as a counter variable, just like <code>i</code> in a for loop. After mapping the <code>ecx-th</code> entry, we increase <code>ecx</code> by one and jump to <code>.map_p2_table</code> again if it‚Äôs still smaller than 512.<p>To map a P2 entry we first calculate the start address of its page in <code>eax</code>: The <code>ecx-th</code> entry needs to be mapped to <code>ecx * 2MiB</code>. We use the <code>mul</code> operation for that, which multiplies <code>eax</code> with the given register and stores the result in <code>eax</code>. Then we set the <code>present</code>, <code>writable</code>, and <code>huge page</code> bits and write it to the P2 entry. The address of the <code>ecx-th</code> entry in P2 is <code>p2_table + ecx * 8</code>, because each entry is 8 bytes large.<p>Now the first gigabyte (512 * 2MiB) of our kernel is identity mapped and thus accessible through the same physical and virtual addresses.<h3 id=enable-paging><a aria-label="Anchor link for: enable-paging" class=zola-anchor href=#enable-paging>üîó</a>Enable Paging</h3><p>To enable paging and enter long mode, we need to do the following:<ol><li>write the address of the P4 table to the CR3 register (the CPU will look there, see the <a href=https://os.phil-opp.com/entering-longmode/#paging>paging section</a>)<li>long mode is an extension of <a href=https://en.wikipedia.org/wiki/Physical_Address_Extension>Physical Address Extension</a> (PAE), so we need to enable PAE first<li>Set the long mode bit in the EFER register<li>Enable Paging</ol><p>The assembly function looks like this (some boring bit-moving to various registers):<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>enable_paging:
</span><span style=color:#608b4e;>    ; load P4 to cr3 register (cpu uses this to access the P4 table)
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, p4_table
</span><span>    </span><span style=color:#569cd6;>mov </span><span>cr3, eax
</span><span>
</span><span style=color:#608b4e;>    ; enable PAE-flag in cr4 (Physical Address Extension)
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, cr4
</span><span>    </span><span style=color:#569cd6;>or </span><span>eax, </span><span style=color:#b4cea8;>1 </span><span><< </span><span style=color:#b4cea8;>5
</span><span>    </span><span style=color:#569cd6;>mov </span><span>cr4, eax
</span><span>
</span><span style=color:#608b4e;>    ; set the long mode bit in the EFER MSR (model specific register)
</span><span>    </span><span style=color:#569cd6;>mov </span><span>ecx, </span><span style=color:#b4cea8;>0xC0000080
</span><span>    </span><span style=color:#569cd6;>rdmsr
</span><span>    </span><span style=color:#569cd6;>or </span><span>eax, </span><span style=color:#b4cea8;>1 </span><span><< </span><span style=color:#b4cea8;>8
</span><span>    </span><span style=color:#569cd6;>wrmsr
</span><span>
</span><span style=color:#608b4e;>    ; enable paging in the cr0 register
</span><span>    </span><span style=color:#569cd6;>mov </span><span>eax, cr0
</span><span>    </span><span style=color:#569cd6;>or </span><span>eax, </span><span style=color:#b4cea8;>1 </span><span><< </span><span style=color:#b4cea8;>31
</span><span>    </span><span style=color:#569cd6;>mov </span><span>cr0, eax
</span><span>
</span><span>    </span><span style=color:#569cd6;>ret
</span></code></pre><p>The <code>or eax, 1 << X</code> is a common pattern. It sets the bit <code>X</code> in the eax register (<code><<</code> is a left shift). Through <code>rdmsr</code> and <code>wrmsr</code> it‚Äôs possible to read/write to the so-called model specific registers at address <code>ecx</code> (in this case <code>ecx</code> points to the EFER register).<p>Finally we need to call our new functions in <code>start</code>:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>...
</span><span>start:
</span><span>    </span><span style=color:#569cd6;>mov </span><span>esp, stack_top
</span><span>
</span><span>    </span><span style=color:#569cd6;>call </span><span>check_multiboot
</span><span>    </span><span style=color:#569cd6;>call </span><span>check_cpuid
</span><span>    </span><span style=color:#569cd6;>call </span><span>check_long_mode
</span><span>
</span><span>    </span><span style=color:#569cd6;>call </span><span>set_up_page_tables</span><span style=color:#608b4e;> ; new
</span><span>    </span><span style=color:#569cd6;>call </span><span>enable_paging</span><span style=color:#608b4e;>     ; new
</span><span>
</span><span style=color:#608b4e;>    ; print `OK` to screen
</span><span>    </span><span style=color:#569cd6;>mov </span><span>dword [</span><span style=color:#b4cea8;>0xb8000</span><span>], </span><span style=color:#b4cea8;>0x2f4b2f4f
</span><span>    </span><span style=color:#569cd6;>hlt
</span><span>...
</span></code></pre><p>To test it we execute <code>make run</code>. If the green OK is still printed, we have successfully enabled paging!<h2 id=the-global-descriptor-table><a aria-label="Anchor link for: the-global-descriptor-table" class=zola-anchor href=#the-global-descriptor-table>üîó</a>The Global Descriptor Table</h2><p>After enabling Paging, the processor is in long mode. So we can use 64-bit instructions now, right? Wrong. The processor is still in a 32-bit compatibility submode. To actually execute 64-bit code, we need to set up a new Global Descriptor Table. The Global Descriptor Table (GDT) was used for <em>Segmentation</em> in old operating systems. I won‚Äôt explain Segmentation but the <a href=http://pages.cs.wisc.edu/%7Eremzi/OSTEP/>Three Easy Pieces</a> OS book has good introduction (<a href=http://pages.cs.wisc.edu/%7Eremzi/OSTEP/vm-segmentation.pdf>PDF</a>) again.<p>Today almost everyone uses Paging instead of Segmentation (and so do we). But on x86, a GDT is always required, even when you‚Äôre not using Segmentation. GRUB has set up a valid 32-bit GDT for us but now we need to switch to a long mode GDT.<p>A GDT always starts with a 0-entry and contains an arbitrary number of segment entries afterwards. A 64-bit entry has the following format:<table><thead><tr><th>Bit(s)<th>Name<th>Meaning<tbody><tr><td>0-41<td>ignored<td>ignored in 64-bit mode<tr><td>42<td>conforming<td>the current privilege level can be higher than the specified level for code segments (else it must match exactly)<tr><td>43<td>executable<td>if set, it‚Äôs a code segment, else it‚Äôs a data segment<tr><td>44<td>descriptor type<td>should be 1 for code and data segments<tr><td>45-46<td>privilege<td>the <a href=https://wiki.osdev.org/Security#Rings>ring level</a>: 0 for kernel, 3 for user<tr><td>47<td>present<td>must be 1 for valid selectors<tr><td>48-52<td>ignored<td>ignored in 64-bit mode<tr><td>53<td>64-bit<td>should be set for 64-bit code segments<tr><td>54<td>32-bit<td>must be 0 for 64-bit segments<tr><td>55-63<td>ignored<td>ignored in 64-bit mode</table><p>We need one code segment, a data segment is not necessary in 64-bit mode. Code segments have the following bits set: <em>descriptor type</em>, <em>present</em>, <em>executable</em> and the <em>64-bit</em> flag. Translated to assembly the long mode GDT looks like this:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>section .rodata
</span><span>gdt64:
</span><span>    dq </span><span style=color:#b4cea8;>0</span><span style=color:#608b4e;> ; zero entry
</span><span>    dq (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>43</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>44</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>47</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>53</span><span>)</span><span style=color:#608b4e;> ; code segment
</span></code></pre><p>We chose the <code>.rodata</code> section here because it‚Äôs initialized read-only data. The <code>dq</code> command stands for <code>define quad</code> and outputs a 64-bit constant (similar to <code>dw</code> and <code>dd</code>). And the <code>(1<&LT43)</code> is a bit shift that sets bit 43.<h3 id=loading-the-gdt><a aria-label="Anchor link for: loading-the-gdt" class=zola-anchor href=#loading-the-gdt>üîó</a>Loading the GDT</h3><p>To load our new 64-bit GDT, we have to tell the CPU its address and length. We do this by passing the memory location of a special pointer structure to the <code>lgdt</code> (load GDT) instruction. The pointer structure looks like this:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>gdt64:
</span><span>    dq </span><span style=color:#b4cea8;>0</span><span style=color:#608b4e;> ; zero entry
</span><span>    dq (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>43</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>44</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>47</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>53</span><span>)</span><span style=color:#608b4e;> ; code segment
</span><span>.pointer:
</span><span>    dw $ - gdt64 - </span><span style=color:#b4cea8;>1
</span><span>    dq gdt64
</span></code></pre><p>The first 2 bytes specify the (GDT length - 1). The <code>$</code> is a special symbol that is replaced with the current address (it‚Äôs equal to <code>.pointer</code> in our case). The following 8 bytes specify the GDT address. Labels that start with a point (such as <code>.pointer</code>) are sub-labels of the last label without point. To access them, they must be prefixed with the parent label (e.g., <code>gdt64.pointer</code>).<p>Now we can load the GDT in <code>start</code>:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>start:
</span><span>    ...
</span><span>    </span><span style=color:#569cd6;>call </span><span>enable_paging
</span><span>
</span><span style=color:#608b4e;>    ; load the 64-bit GDT
</span><span>    </span><span style=color:#569cd6;>lgdt </span><span>[gdt64.pointer]
</span><span>
</span><span style=color:#608b4e;>    ; print `OK` to screen
</span><span>    ...
</span></code></pre><p>When you still see the green <code>OK</code>, everything went fine and the new GDT is loaded. But we still can‚Äôt execute 64-bit code: The code selector register <code>cs</code> still has the values from the old GDT. To update it, we need to load it with the GDT offset (in bytes) of the desired segment. In our case the code segment starts at byte 8 of the GDT, but we don‚Äôt want to hardcode that 8 (in case we modify our GDT later). Instead, we add a <code>.code</code> label to our GDT, that calculates the offset directly from the GDT:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>section .rodata
</span><span>gdt64:
</span><span>    dq </span><span style=color:#b4cea8;>0</span><span style=color:#608b4e;> ; zero entry
</span><span>.code: equ $ - gdt64</span><span style=color:#608b4e;> ; new
</span><span>    dq (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>43</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>44</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>47</span><span>) | (</span><span style=color:#b4cea8;>1</span><span><<</span><span style=color:#b4cea8;>53</span><span>)</span><span style=color:#608b4e;> ; code segment
</span><span>.pointer:
</span><span>    ...
</span></code></pre><p>We can‚Äôt just use a normal label here, since we need the table <em>offset</em>. We calculate this offset using the current address <code>$</code> and set the label to this value using <a href=https://www.nasm.us/doc/nasmdoc3.html#section-3.2.4>equ</a>. Now we can use <code>gdt64.code</code> instead of 8 and this label will still work if we modify the GDT.<p>In order to finally enter the true 64-bit mode, we need to load <code>cs</code> with <code>gdt64.code</code>. But we can‚Äôt do it through <code>mov</code>. The only way to reload the code selector is a <em>far jump</em> or a <em>far return</em>. These instructions work like a normal jump/return but change the code selector. We use a far jump to a long mode label:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>global start
</span><span>extern long_mode_start
</span><span>...
</span><span>start:
</span><span>    ...
</span><span>    </span><span style=color:#569cd6;>lgdt </span><span>[gdt64.pointer]
</span><span>
</span><span>    </span><span style=color:#569cd6;>jmp </span><span>gdt64.code:long_mode_start
</span><span>...
</span></code></pre><p>The actual <code>long_mode_start</code> label is defined as <code>extern</code>, so it‚Äôs part of another file. The <code>jmp gdt64.code:long_mode_start</code> is the mentioned far jump.<p>I put the 64-bit code into a new file to separate it from the 32-bit code, thereby we can‚Äôt call the (now invalid) 32-bit code accidentally. The new file (I named it <code>long_mode_init.asm</code>) looks like this:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>global long_mode_start
</span><span>
</span><span>section .text
</span><span>bits 64
</span><span>long_mode_start:
</span><span style=color:#608b4e;>    ; print `OKAY` to screen
</span><span>    </span><span style=color:#569cd6;>mov </span><span>rax, </span><span style=color:#b4cea8;>0x2f592f412f4b2f4f
</span><span>    </span><span style=color:#569cd6;>mov </span><span>qword [</span><span style=color:#b4cea8;>0xb8000</span><span>], rax
</span><span>    </span><span style=color:#569cd6;>hlt
</span></code></pre><p>You should see a green <code>OKAY</code> on the screen. Some notes on this last step:<ul><li>As the CPU expects 64-bit instructions now, we use <code>bits 64</code><li>We can now use the extended registers. Instead of the 32-bit <code>eax</code>, <code>ebx</code>, etc. we now have the 64-bit <code>rax</code>, <code>rbx</code>, ‚Ä¶<li>and we can write these 64-bit registers directly to memory using <code>mov qword</code> (quad word)</ul><p><em>Congratulations</em>! You have successfully wrestled through this CPU configuration and compatibility mode mess :).<h4 id=one-last-thing><a aria-label="Anchor link for: one-last-thing" class=zola-anchor href=#one-last-thing>üîó</a>One Last Thing</h4><p>Above, we reloaded the code segment register <code>cs</code> with the new GDT offset. However, the data segment registers <code>ss</code>, <code>ds</code>, <code>es</code>, <code>fs</code>, and <code>gs</code> still contain the data segment offsets of the old GDT. This isn‚Äôt necessarily bad, since they‚Äôre ignored by almost all instructions in 64-bit mode. However, there are a few instructions that expect a valid data segment descriptor <em>or the null descriptor</em> in those registers. An example is the the <a href=https://os.phil-opp.com/returning-from-exceptions/#the-iretq-instruction>iretq</a> instruction that we‚Äôll need in the <a href=https://os.phil-opp.com/returning-from-exceptions/><em>Returning from Exceptions</em></a> post.<p>To avoid future problems, we reload all data segment registers with null:<pre class=language-nasm data-lang=nasm style=background-color:#1e1e1e;color:#dcdcdc;><code class=language-nasm data-lang=nasm><span>long_mode_start:
</span><span style=color:#608b4e;>    ; load 0 into all data segment registers
</span><span>    </span><span style=color:#569cd6;>mov </span><span>ax, </span><span style=color:#b4cea8;>0
</span><span>    </span><span style=color:#569cd6;>mov </span><span>ss, ax
</span><span>    </span><span style=color:#569cd6;>mov </span><span>ds, ax
</span><span>    </span><span style=color:#569cd6;>mov </span><span>es, ax
</span><span>    </span><span style=color:#569cd6;>mov </span><span>fs, ax
</span><span>    </span><span style=color:#569cd6;>mov </span><span>gs, ax
</span><span>
</span><span style=color:#608b4e;>    ; print `OKAY` to screen
</span><span>    ...
</span></code></pre><h2 id=what-s-next><a aria-label="Anchor link for: what-s-next" class=zola-anchor href=#what-s-next>üîó</a>What‚Äôs next?</h2><p>It‚Äôs time to finally leave assembly behind and switch to <a href=https://www.rust-lang.org/>Rust</a>. Rust is a systems language without garbage collections that guarantees memory safety. Through a real type system and many abstractions it feels like a high-level language but can still be low-level enough for OS development. The <a href=https://os.phil-opp.com/set-up-rust/>next post</a> describes the Rust setup.<h2 id=footnotes><a aria-label="Anchor link for: footnotes" class=zola-anchor href=#footnotes>üîó</a>Footnotes</h2><div class=footnote-definition id=hardware_lookup><sup class=footnote-definition-label>1</sup><p>In the x86 architecture, the page tables are <em>hardware walked</em>, so the CPU will look at the table on its own when it needs a translation. Other architectures, for example MIPS, just throw an exception and let the OS translate the virtual address.</div><div class=footnote-definition id=virtual_physical_translation_source><sup class=footnote-definition-label>2</sup><p>Image source: <a href=https://commons.wikimedia.org/wiki/File:X86_Paging_64bit.svg>Wikipedia</a>, with modified font size, page table naming, and removed sign extended bits. The modified file is licensed under the Creative Commons Attribution-Share Alike 3.0 Unported license.</div><div class=footnote-definition id=page_table_alignment><sup class=footnote-definition-label>3</sup><p>Page tables need to be page-aligned as the bits 0-11 are used for flags. By putting these tables at the beginning of <code>.bss</code>, the linker can just page align the whole section and we don‚Äôt have unused padding bytes in between.</div></main><div><hr><div class=PageNavigation><a class=prev href=/multiboot-kernel/>¬´ A minimal Multiboot Kernel</a><a class=next href=/set-up-rust/>Set Up Rust ¬ª</a></div><hr><section><h2>Comments (Archived)</h2><section id=isso-thread><div id=isso-root><div class="isso-comment isso-no-votes" id=isso-227><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=4d0a4c8513ba shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Daniel</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-227 rel=nofollow><time title="Sat Oct 24 2015 16:16:34 GMT+0200 (Central European Summer Time)" datetime=2015-09-06T14:16:34Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p><p>Hi, thank you for the blog posts, finding them really accessible and interesting.<p>The <code>test_long_mode</code> function doesn't look quite right:<br><pre><code><br>test_long_mode:<br>  mov eax, 0x80000000     ; Set the A-register to 0x80000000.<br>  cpuid                               ; CPU identification.<br>  cmp eax, 0x80000001     ; Compare the A-register with 0x80000001.<br>  jb .no_long_mode           ; It is less, there is no long mode.<br>  mov eax, 0x80000000     ; Set the A-register to 0x80000000.<br>  cpuid                               ; CPU identification.<br>  cmp eax, 0x80000001     ; Compare the A-register with 0x80000001.<br>  jb .no_long_mode           ; It is less, there is no long mode.<br>  ret<br></code></pre><p><br>^ should probaly be (according to your linked OSDEV page):<p><pre><code><br>test_long_mode:<br>  mov eax, 0x80000000      ; Set the A-register to 0x80000000.<br>  cpuid                                ; CPU identification.<br>  cmp eax, 0x80000001      ; Compare the A-register with 0x80000001.<br>  jb .no_long_mode            ; It is less, there is no long mode.<br>  mov eax, 0x80000001      ; Set the A-register to 0x80000001.<br>  cpuid                                ; CPU identification.<br>  test edx, 1 << 29              ; Test if the LM-bit, which is bit 29, is set in the D-register.<br>  jz .no_long_mode             ; They aren't, there is no long mode.<br>  ret<br></code></pre><p></div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-228><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-228 rel=nofollow><time title="Sat Oct 24 2015 17:16:30 GMT+0200 (Central European Summer Time)" datetime=2015-09-06T15:16:30Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>You're right, thank you! I created an Github issue and will fix it soon: <a href=https://github.com/phil-opp/blog_os/issues/6 rel=nofollow>https://github.com/phil-opp...</a></div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-229><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=4d0a4c8513ba shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Daniel Ferguson</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-229 rel=nofollow><time title="Sun Oct 25 2015 13:37:41 GMT+0100 (Central European Standard Time)" datetime=2015-09-00T12:37:41Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>Thank you! For any further issues I run into would you prefer I posted to the github page?<p>I ran into another snag, at the end of the paging setup section (just before the GDT section) you state:<p>"To test it we execute make run. If the green OK is still printed, we have successfully enabled paging!"<p>I'm assuming (based on trying it out) it would not be bootable at that stage, though it may in some way be down to the specifics of my setup or mistakes on my part.<p>When run with qemu it repeatedly restarts and doesn't reach an 'OK' boot.<br>Removing the `enable_paging` call allows the OS to boot properly, though the paging will not be set up. Further forwards, once the GDT is implemented, the OS once more boots without a hitch.<p>I checked out the repo and stripped out the later steps to compensate for any errors I made in copying.<p>Thanks again for these posts.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-230><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-230 rel=nofollow><time title="Sun Oct 25 2015 14:35:18 GMT+0100 (Central European Standard Time)" datetime=2015-09-00T13:35:18Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>Post issues wherever you want (and thank you for doing it).<p>Hmm, I can't reproduce it on my machine. I checked out commit 457a613 (see link below) and it ran without problems. Could you try the code from this commit?<p>Link to 457a613: <a href=https://github.com/phil-opp/blog_os/tree/457a61341a3b62c9c99981bf2fa90a333aedc928/src/arch/x86_64 rel=nofollow>https://github.com/phil-opp...</a></div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-231><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=4d0a4c8513ba shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Daniel Ferguson</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-231 rel=nofollow><time title="Sun Oct 25 2015 15:56:04 GMT+0100 (Central European Standard Time)" datetime=2015-09-00T14:56:04Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>Apologies, I did a quick diff against that commit (which runs fine) and found I missed the `align 4096` in `section .bss`. Putting that in fixed it (you did include it in this post), fault is all mine.<p>Thanks again!</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-232><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=6334312b9f4a shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>emk1024</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-232 rel=nofollow><time title="Wed Oct 28 2015 23:18:55 GMT+0100 (Central European Standard Time)" datetime=2015-09-03T22:18:55Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>This is fun!<p>Continuing my saga of trying to get this running under Ubuntu 14.04 LTS on a MacBook Pro, if you find that enabling long paging causes an infinite reboot cycle (triple fault?) in QEMU, then you might want to check your qemu-system-x86_64 version. Version 2.0 will reboot infinitely as soon as you try to turn on paging. Version 2.1.2, however, works fine.<p>Is this perhaps a problem with huge pages? Would it help to add another feature test?<p>In order to prevent more debugging fun, I've downloaded and built your blog_os repo, and I can now see it print "Hello world", so it should be smooth sailing from here. :-)<p>Once again, thank you for a cool series of blog posts! Are there any OS development books that you recommend for ideas on further enhancing this basic system?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-233><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-233 rel=nofollow><time title="Thu Oct 29 2015 11:21:28 GMT+0100 (Central European Standard Time)" datetime=2015-09-04T10:21:28Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>You're right, support for 1GB pages was <a href=http://wiki.qemu.org/ChangeLog/2.1 rel=nofollow>introduced in QEMU 2.1</a> in 2014. Intel CPUs support it since <a href=https://en.wikipedia.org/wiki/Westmere_(microarchitecture)#Technology rel=nofollow>Westmere</a> (2010).<p>There is indeed a way to test support: <a href=https://en.wikipedia.org/wiki/CPUID#EAX.3D80000001h:_Extended_Processor_Info_and_Feature_Bits rel=nofollow>CPUID 0x80000001, EDX bit 26</a>. But I'm not quite sure if it's good to rely on such a "new" feature at all... Maybe I change it to use 2MB pages instead...<p>I opened an <a href=https://github.com/phil-opp/blog_os/issues/17 rel=nofollow>issue</a> for it. Thank you very much for the hint!<p>Edit: Updated the code and article to use 2MiB pages instead of 1GiB pages. It now works on my old PC from 2005 again :).</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-234><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-234 rel=nofollow><time title="Thu Oct 29 2015 20:32:02 GMT+0100 (Central European Standard Time)" datetime=2015-09-04T19:32:02Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p><blockquote>Are there any OS development books that you recommend for ideas on further enhancing this basic system?</blockquote><p><p>Well, there is the <a href=http://pages.cs.wisc.edu/~remzi/OSTEP/ rel=nofollow>Three Easy Pieces</a> book I linked in the post, which gives a theoretical overview over different OS concepts. Then there's <a href=http://littleosbook.github.io rel=nofollow>the little book about OS development</a>, which is more practical and contains C example code. Of course there are <a href=https://wiki.osdev.org/Books#Operating_Systems rel=nofollow>many paid books</a>, too.<p>Besides books, the <a href=https://wiki.osdev.org/Main_Page rel=nofollow>OSDev Wiki</a> is also a good resource for many topics. Looking at the source of e.g. <a href=https://github.com/redox-os/redox rel=nofollow>Redox</a> can be helpful, too.<p>For exotical ideas, I really like the concept of <a href=https://en.wikipedia.org/wiki/Phantom_OS rel=nofollow>Phantom OS</a> and Rust's memory safety might allow something similar‚Ä¶ We'll see ;)<p></div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-235><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=795b6c68aba8 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=20></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=20></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=20></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Tom Smeding</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-235 rel=nofollow><time title="Thu Oct 29 2015 21:46:13 GMT+0100 (Central European Standard Time)" datetime=2015-09-04T20:46:13Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>There's still some text in the article referring to the gigabyte page, like "Now the first gigabyte of our kernel is identity mapped", but otherwise, immense thanks for this article; even though I'm not going to use Rust, these two articles actually got me up and running in long mode *without* hassle!</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-236><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-236 rel=nofollow><time title="Fri Oct 30 2015 09:50:09 GMT+0100 (Central European Standard Time)" datetime=2015-09-05T08:50:09Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>That's correct, actually. We mapped the first gigabyte through 512 2MiB pages instead of one 1GiB page. So the outcome is the same but the code is more complicated...<p>But I see that this can cause confusion, so I will clarify it.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-237><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=795b6c68aba8 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=20></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=20></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=20></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Tom Smeding</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-237 rel=nofollow><time title="Fri Oct 30 2015 11:00:14 GMT+0100 (Central European Standard Time)" datetime=2015-09-05T10:00:14Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>Oh of course, silly me :P</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class=isso-comment-loader id=isso-loader-232><a class=load_hidden href=# rel=nofollow>3 versteckt</a></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-238><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=0bc2df00636d shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Tobias Schottdorf</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-238 rel=nofollow><time title="Sun Nov 08 2015 16:53:32 GMT+0100 (Central European Standard Time)" datetime=2015-10-00T15:53:32Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>> An entry in the P4, P3, P2, and P1 tables consists of the page aligned 52-bit physical address of the page/next page table and the following bits that can be OR-ed in:<p>I can't quite make sense of that - so the physical addresses which are available to virtual addressing are only 52bit (instead of all 64bit)? There appear to be 24 flags which can be or'ed in, but wouldn't that necessitate overwriting parts of the physical address (52bit + 22bit > 64bit) of the page/page table?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-239><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-239 rel=nofollow><time title="Sun Nov 08 2015 19:20:42 GMT+0100 (Central European Standard Time)" datetime=2015-10-00T18:20:42Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>The key is that the physical addresses are page aligned. The last 12 bits are thus guaranteed to be 0 and can be used to store some flags. So there are 24 bits for the various flags and 52-12=40 bits for the aligned physical address.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-256><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=c08d83f42dfd shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Nicholas Platt</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-256 rel=nofollow><time title="Sun Mar 20 2016 19:55:05 GMT+0100 (Central European Standard Time)" datetime=2016-02-00T18:55:05Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>I'm confused about this as well. Why say "52-bit physical address" if the address is only 40 bits? Is it because the address is between sets of flags? Meaning, do the table entries really look like this?<p><pre>+-------+----------------------------------------+-------+<br>| flags | physical address (frame or next table) | flags |<br>+-------+----------------------------------------+-------+<br> 63      51                                       11     0</pre><p><p>Can you check my understanding:<p><pre>* Virtual addresses are effectively 48 bits:<br>    * Highest 16 bits are sign extension of 48th bit<br>    * Next 36 bits are used to navigate the paging tables<br>    * Lowest 12 bits are used as offset from physical address<br>      found in P1<br><br>* Physical addresses are effectively 40 bits and page aligned<br><br>* Paging table entries are 64 bits:<br>    * Highest 12 bits are flags<br>    * Next 40 bits are the physical address of a table or frame<br>    * Lowest 12 bits are flags<br></pre><p><p>Thus physical addresses identify the start of each aligned frame, and virtual addresses identify the location within the frame.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-258><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-258 rel=nofollow><time title="Sun Mar 20 2016 23:44:25 GMT+0100 (Central European Standard Time)" datetime=2016-02-00T22:44:25Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>The physical address is 52 bits. It is possible to address up to 2^52 bytes of memory with it. Operating systems without paging (e.g. MS-DOS) directly use the physical address to access memory. And so do we before we enable paging.<p>As soon as we enable paging, the CPU uses the memory management unit (MMU) to translate used addresses (‚Äúvirtual addresses‚Äù) to the real memory addresses. These virtual addresses are effectively 48 bits on x86_64 and behave exactly as you stated.<p>So why are only 40 physical address bits stored in the page table? The reason is that the physical memory is split into page sized chunks, which are called frames. The first frame starts at physical address 0, the second frame at physical address 4096, and so on. Thus the physical address of a frame is always page aligned. There are still non-page-aligned physical addresses but they can't be the start of a frame.<p>So the lowest 12 bits of a valid physical frame address are always 0. We don't need to store anything if we know that it is always 0. Thus these bits can be used to store useful information instead (flags in our case).<p>I hope this helps in clearing up your confusion.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-259><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=c08d83f42dfd shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Nicholas Platt</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-259 rel=nofollow><time title="Mon Mar 21 2016 01:26:20 GMT+0100 (Central European Standard Time)" datetime=2016-02-01T00:26:20Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks, this has indeed become more clear as I've worked with it. I wrote (and just revised due to better understanding) <a href=https://github.com/caipre/mezzo/commit/d73dc2d3a84b68fd5c83c0c9959ffdf20a34ebde rel=nofollow>a detailed comment</a> and that helped nail it down for me.<p>In case it's not clear to anyone else, the reason the lower bits are always 0 is because <code>4096 = 0x1000</code>.<p>Another question then: since we're aligning on 2mib pages here (<code>0x200000</code>), can we access the extra few bits (21 vs 12)?<p>I'll try this myself once I'm allocating pages.<p><strong>Edit:</strong><br>It seems like this idea works. I added the following lines after the paging table setup and didn't encounter any processor exceptions:<p><pre>; try writing within reserved address space,<br>; in a middle entry of P4<br>mov eax, (1 << 31)<br>or [p4_table + (256*8)], eax</pre><p><p>I guess this works, just be sure you're acting on a 2mib page and not a 4kib page.<p></div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-260><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-260 rel=nofollow><time title="Mon Mar 21 2016 08:38:23 GMT+0100 (Central European Standard Time)" datetime=2016-02-01T07:38:23Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>That's an interesting question! The <a href=https://support.amd.com/TechDocs/24593.pdf rel=nofollow>AMD manual</a> says no in section 5.3.4 in Figure 5-25 on page 135. The bits between 13 and 20 are marked as ‚ÄúReserved, must be zero‚Äù. So it seems like a general protection fault occurs then.<p>Your example works because you only set a bit of a non-present page. AFAIK all bits of non-present pages are available to the OS (except the present bit). If you want to test it, you can set a bit between 13 and 20 in the currently used P2 table. The P3 and P4 table entries still need 40bits for storing the physical address of the next table since page tables only need to be 4KiB aligned.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-240><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=23a9539aaf13 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Ahmed Charles</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-240 rel=nofollow><time title="Wed Nov 18 2015 22:16:39 GMT+0100 (Central European Standard Time)" datetime=2015-10-03T21:16:39Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>You should probably mention that setting bit 16 in cr0 turns on write protection for read only pages, even in kernel mode.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-241><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-241 rel=nofollow><time title="Wed Nov 18 2015 23:14:05 GMT+0100 (Central European Standard Time)" datetime=2015-10-03T22:14:05Z>vor 4 Jahren</time></a><span class=note></span></div><div class=text><p>Good catch! I copied the code from my experimental kernel and it seems like I have missed that‚Ä¶ I'm not quite sure if I should keep and explain it, or just remove it. What do you think?<p>I opened an <a href=https://github.com/phil-opp/blog_os/issues/47 rel=nofollow>issue</a> for this.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-242><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3773460ec1e4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Wink Saville</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-242 rel=nofollow><time title="Sun Dec 27 2015 16:39:24 GMT+0100 (Central European Standard Time)" datetime=2015-11-00T15:39:24Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Philipp,<p>Just an FYI, In my <a href=https://github.com/winksaville/baremetal-x86_64 rel=nofollow>baremetal-x86_64</a> repo I ported your boot.asm to boot.gas.S so I could use the code with gnu Assembler.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-243><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-243 rel=nofollow><time title="Sun Dec 27 2015 16:50:47 GMT+0100 (Central European Standard Time)" datetime=2015-11-00T15:50:47Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Nice! You are porting it to C?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-244><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3773460ec1e4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Wink Saville</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-244 rel=nofollow><time title="Sun Dec 27 2015 19:36:09 GMT+0100 (Central European Standard Time)" datetime=2015-11-00T18:36:09Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Yes I'm using boot to launch my C based system, your code was the best and most straight forward code to get to long mode that I've seen. I found your code though Eric Kidd's posts to the rust mailing list on the interrupt issues, and I'm glad I'm not going to have to solve that problem yet again :)</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-245><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-245 rel=nofollow><time title="Mon Dec 28 2015 00:37:10 GMT+0100 (Central European Standard Time)" datetime=2015-11-00T23:37:10Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks! I'm glad that it has helped :)</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-246><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=823a84765cf4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>anula</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-246 rel=nofollow><time title="Thu Feb 18 2016 13:32:23 GMT+0100 (Central European Standard Time)" datetime=2016-01-04T12:32:23Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>I have an interesting problem, that probably has something to do with alignment (as usual while dealing with assembly), though I can't say for sure.<br>I tried to run the code that does all the checks, but with no paging yet (so prior to "Paging" header). Unfortunately, it always gets into some kind of loop, sometimes qemu throws an exception:<br>`qemu: fatal: Trying to execute code outside RAM or ROM at 0x000000002b100044`<br>So it probably tries to execute some random code.<p>If I delete call to check_long_mode, everything works properly, and green OK is printed to the screen. I don't even need to delete the whole call, it is enough to put `ret` after `test edx, 1 << 29` so it seems as if the jump to error code (`jz .no_long_mode`) was somehow to blame.<p>During the course of debugging, I added a small function, almost identical to `error` and discovered that just adding the function makes the error go away.<br>Here are both my codes: <a href=https://gist.github.com/anula/fe81dd8fb6a41e62a91c rel=nofollow>https://gist.github.com/anu...</a><br>The first one (boot.asm) enters the strange loop (executing random instructions?) on my laptop, the second one (boot2.asm) executes properly. And the only difference is addition of some code that is never called anyway.<p>Any ideas what may cause it?<p>EDIT:<br>Aligning stack to 4096 (bss is in my code above text section) also seems to solve the issue. Still, I don't really understand why is this happening. I thought that x86 doesn't need instructions to be aligned to anything specific?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-247><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-247 rel=nofollow><time title="Thu Feb 18 2016 17:57:38 GMT+0100 (Central European Standard Time)" datetime=2016-01-04T16:57:38Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>That was an interesting debugging session :D<p>I tried every debugging trick I knew, read the manual entries for all involved instructions, and even tried to use GDB. But I could not find the bug.<p>Then I gave up and just looked at the source code in the repo and created a diff to your code. And the problem was surprisingly simple:<p>You swapped `stack_bottom` and `stack_top`.<p>But this small change causes big problems. Every `push` or `call` instruction overwrites some bits of the `.text` section below. The last function in the source file and thus the last function in the `.text` section is `check_long_mode`. If you add something behind it, e.g. another error function, it is no longer overwritten and works again.<p>I think the counter-intuitive thing is that stuff further down in the source file ends up further up in memory. And the stack grows downwards to make it even more confusing. Maybe we should add a small note in the text, why `stack_bottom` needs to be _above_ `stack_top` in the file?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-248><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=823a84765cf4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>anula</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-248 rel=nofollow><time title="Thu Feb 18 2016 19:13:35 GMT+0100 (Central European Standard Time)" datetime=2016-01-04T18:13:35Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Uh, that is an.. embarrassing error. I checked all registers twice (easy to mistake eax with ecx) but somehow never thought to check that... I guess that when you see top above bottom in code you unconsciously decide that it is ok.<p>About the note - it would probably make sense, maybe it will make someone to check their code twice, and surely will be a good reminder for people that have little experience with low level things like that.<p>Thanks very much for the help - I guess it would take me a lot of time later to debug it, when it would start to mysteriously fall after I add another function call in Rust.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-249><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-249 rel=nofollow><time title="Fri Feb 19 2016 10:20:18 GMT+0100 (Central European Standard Time)" datetime=2016-01-05T09:20:18Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Not embarrassing at all, just hard to debug!<p>I created <a href=https://github.com/phil-opp/blog_os/issues/133 rel=nofollow>an issue</a> for the note, but it will take a while since I'm short on time right now. If you like, feel free to send a PR.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-250><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3773460ec1e4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Wink Saville</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-250 rel=nofollow><time title="Mon Feb 29 2016 23:58:33 GMT+0100 (Central European Standard Time)" datetime=2016-01-01T22:58:33Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Phillipp,<p>Previously I mentioned I'm using a derivative of your boot.S code to boot a C kernel. Things are going pretty good so far, but today I wanted to try to get interrupts going and have run into a brick wall.<p>I've simplified my test program to something to something very simple. All that happens is boot code jumps to the C code which enables interrupts and loops for a short period of time and then exits. There should be no interrupt sources so I'd expect this to run for as long as I'd like and then exit. And it does If the loop time is very short, but if I lengthen the loop it stops prematurely.<p>In a more sophisticated version of my program I initialize the Interrupt Descriptor Table and use the APIC to generate a one-shot timer interrupt. Here too, all is well if the delay is short, but when I lengthen the delay I get a Double Fault interrupt!<p>It almost feels like there is a watchdog timer or .......<p>Any suggestions welcome.<p>Thanks,<p>Wink</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-251><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-251 rel=nofollow><time title="Tue Mar 01 2016 17:17:21 GMT+0100 (Central European Standard Time)" datetime=2016-02-02T16:17:21Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>A double fault occurs when you don't handle an exception/interrupt or your exception handler causes another exception. Do you enable interrupts (<code>sti</code>) or do you just catch cpu exceptions? Maybe you forgot to handle the interrupts from the hardware timer? But it's difficult to help without the actual code‚Ä¶</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-252><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3773460ec1e4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Wink Saville</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-252 rel=nofollow><time title="Tue Mar 01 2016 21:32:36 GMT+0100 (Central European Standard Time)" datetime=2016-02-02T20:32:36Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Agreed, and I see that in my more sophisticated program, the question is what is it that I'm doing wrong. I believe I've setup the Interrupt Descriptor Table to handle all interrupts, i.e. I have an array of 256 interrupt gates. That program is here (https://github.com/winksaville/sadie but its too complicated to debug and I haven't yet checked in my non-working APIC timer code. But with that code I'm able to do software interrupts and also when my APIC timer code fires an interrupt fast enough it does work. So it would seem I've done most of the initialization "properly". Note, I'm also compiling my code with -mno-red-zone so that shouldn't be the problem.<p>So my debug strategy in situations such as this is to simplify. So the first thing was to just enable interrupts and doing nothing that should cause an interrupt to occur and then delay awhile in the code and see what happens. But, sure enough I'm still getting a double fault. Of course according to the documentation in the Intel SDM Volume 3 section 6.15 "Interrupt 8--Double Fault Exception (#DF)" the error code is 0 and CS EIP registers are undefined :(<p>Anyway, I then simplified to as simple as I can get. I modified your boot.asm program adding the code below the esp initialization that output's character to the VGA display.<p><pre><code><br>start:<br>  mov esp, stack_top<br><br>  ; Save registers<br>  push edx<br>  push ecx<br>  push ebx<br>  push eax<br><br>  ; Enable interrupts<br>  ;sti<br><br>  ; Initialize edx to vga buffer ah attribute, al ch<br>  mov edx, 0xb8000<br>  mov ax, 0x0f60<br><br>  ; ebx number of loops<br>  mov ebx,10000<br><br>.loop:<br><br>  ; Output next character and attribute<br>  mov word [edx], ax<br><br>  ; Increment to next character with wrap<br>  inc al<br>  cmp al, 0x7f<br>  jne .nextloc<br>  mov al,60<br><br>  ; Next location with wrap<br>.nextloc:<br>  add edx, 2<br>  and edx,0x7ff<br>  or  edx,0xb8000<br><br>  ; Delay<br>  mov ecx,0x2000<br>.delay:<br>  loop .delay<br><br>  ; Continue looping until ebx is 0<br>  dec ebx<br>  jnz .loop<br><br>  ; Disable interrupts<br>  cli<br><br>  ; Restore registers<br>  pop  eax<br>  pop  ebx<br>  pop  ecx<br>  pop  edx<br></code></pre><p><p>Here is a github repo: (https://github.com/winksaville/baremetal-po-x86_64/tree/test_enable_interrupts). If you add the above code to your boot.asm it will print 10,000 characters to the VGA display and then continue with the normal code paths. If the "sti" instruction is commented out, as it is above, then all is well. But if I uncomment the "sti" thus enabling interrupts then it fails.<p>I anticipated that enabling interrupts would succeed as I wouldn't expect any interrupts because the hardware is in a state where no interrupts should be generated. Or if grub or the BIOS is using interrupts then I'd expect things to also be OK.<p>Obviously I'm wrong and I'd hope you'd be able to suggest where my flaw is.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-253><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-253 rel=nofollow><time title="Wed Mar 02 2016 16:30:12 GMT+0100 (Central European Standard Time)" datetime=2016-02-03T15:30:12Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks for the overview and the simplified example! I haven't had the time to look at it in detail, but the problem in your simplified example could be the <a href=https://wiki.osdev.org/Programmable_Interval_Timer rel=nofollow>Programmable Interval timer</a>. From the ‚ÄúOutputs‚Äù section:<p><blockquote>The output from PIT channel 0 is connected to the PIC chip, so that it generates an "IRQ 0". Typically during boot the BIOS sets channel 0 with a count of 65535 or 0 (which translates to 65536), which gives an output frequency of 18.2065 Hz (or an IRQ every 54.9254 ms).</blockquote><p><p>So it seems like the BIOS turns it on by default so that it causes an interrupts every ~55ms. This causes a double fault, since there is no interrupt handler for IRQ 0.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-254><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3773460ec1e4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Wink Saville</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-254 rel=nofollow><time title="Thu Mar 03 2016 04:46:05 GMT+0100 (Central European Standard Time)" datetime=2016-02-04T03:46:05Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Philipp, you were correct, the PIT was the culprit causing the "Double Fault". Although it turns out the PIT is actually generating an Interrupt 8 so its not really a Double Fault it just a PIT interrupt.<p>My short term solution is to add a pit_isr as interrupt 8 handler and at the end of pit_isr send an EOI to the PIT using outb(0x20, 0x20). I also needed to issue a APIC EOI for my apic_timer_isr and I cleaned up the initialization. So now my system is cleanly handling these interrupts at least.<p>For the PIT I really want to disable it and I'd like to suggest disabling the PIT be part of boot.asm so that my simple sti, delay, cli test works. If/when I figure that out I'll let you know. Oh, and if know how to disalbe the PIT please let me know.<p>Thanks again for your help!</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-255><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=3773460ec1e4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=28></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Wink Saville</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-255 rel=nofollow><time title="Fri Mar 04 2016 01:53:38 GMT+0100 (Central European Standard Time)" datetime=2016-02-05T00:53:38Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Here is a solution. There doesn't seem to be a way to disable the PIT, but you can disable all IRQ's from the PIC, adding the following code to my test_enable_interrupts branch allows the code to work even with the enabling interrupts:<p>```<br> ; Disable PIC interrupts so we don't get interrupts if the PIC<br> ; was being used by grub or BIOS. See Disabling section of<br> ; <a href=https://wiki.osdev.org/PIC rel=nofollow>https://wiki.osdev.org/PIC</a>. If the application wants to use devices<br>; connected to the PIC, such at the PIT, it will probably want<br> ; to remap the PIC interrupts to be above 0 .. 31 which are<br> ; used or reserved by Intel. See the Initialisation section of<br> ; the same page for the PIC_remap subroutine.<p>mov al,0xff<br> out 0xa1, al<br> out 0x21, al<br>```<p>Thanks again for your help.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-257><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=c08d83f42dfd shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Nicholas Platt</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-257 rel=nofollow><time title="Sun Mar 20 2016 20:10:06 GMT+0100 (Central European Standard Time)" datetime=2016-02-00T19:10:06Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p><blockquote>To identity map the first gigabyte of our kernel with 512 2MiB pages, we need one P4, one P3, and one P2 table.</blockquote><p><p>Why don't we need to set up a P1 table? We don't even reserve the space for one since there's no <code>p1_table</code> label in the <code>.bss</code>. Is the CPU able to read the paging tables such that it knows to stop translating once it reaches an entry in P2 marked "huge"? What happens to bits 12-20 of the virtual address?<p></div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-264><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=4063fb57aa16 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Don Rowe</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-264 rel=nofollow><time title="Thu Jul 28 2016 08:09:33 GMT+0200 (Central European Summer Time)" datetime=2016-06-04T06:09:33Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Hi, Philipp! Thanks so much for creating this for us--it's been very fun to go from 0-OKAY with the ASM here, and I can't wait to get to the Rust portion (which is what drew me to this project in the first place. I'm a little confused, though, about the 4-level paging structure. Is there exactly one each of P2, P3, and P4, and then 512 different P1's that each point to various 4K physical pages?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-265><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-265 rel=nofollow><time title="Thu Jul 28 2016 09:41:38 GMT+0200 (Central European Summer Time)" datetime=2016-06-04T07:41:38Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks!<p>There is always exactly one P4. For each P4 entry, there is a P3. For each P3 entry, there is a P2. And for each P2 entry, there is a P1. Each entry of the P1 then points to a physical memory page.<p>So there is one P4 table, 1‚Ä¶512 P3 tables, 1‚Ä¶(512*512) P2 tables, and 1‚Ä¶(512*512*512) P1 tables. (And 1‚Ä¶(512*512*512*512) mapped 4k pages. 512^4 * 4k = 256TiB = 2^48 bytes is the maximum amount of addressable virtual memory.)<p>If we wanted to identity map the first 2MiB, it would require 512 4k pages and thus exactly 512 P1 entries. Every page table has 512 entries, so we need exactly one P1 (and one P2, P3, P4).<p>If we wanted to identity map the first 513 4k pages, we would need another P1 entry. Our first P1 is full, so we create another P1. Its first entry points to the 513th 4k page and the other entries are empty. Now we map the second P2 entry (which is currently empty) to the P1 table.<p>In our case, we want to identity map the first 512*2MiB. This requires 512*512 4k pages and thus 512 P1 tables. Fortunately, there is a useful hardware feature: huge pages. A huge page is 2MiB instead of 4k and is mapped directly by the P2 (so we completely skip the P1 table). This allows us to avoid the 512 P4 tables. Instead we map the 512P2 entries to huge pages.<p>The big advantage of a multilevel page table is that we don't need to create the page tables / page table entries for memory areas we don't use. In contrast, a single level page table would need 68719476736 entries to address the same amount of virtual memory. So the page table alone would need 68719476736*8=512GiB memory, which is much more than the total amount of RAM in a consumer PC.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-266><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=4063fb57aa16 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Don Rowe</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-266 rel=nofollow><time title="Fri Jul 29 2016 02:25:32 GMT+0200 (Central European Summer Time)" datetime=2016-06-05T00:25:32Z>vor 3 Jahren</time></a><span class=note></span></div><div class=text><p>Ah, I understand! Thank you.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-267><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=f852b3c6f433 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=20></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Lonami</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-267 rel=nofollow><time title="Sun Mar 05 2017 17:34:53 GMT+0100 (Central European Standard Time)" datetime=2017-02-00T16:34:53Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>So excited to get started with the next chapter!! ^¬∑^</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-268><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=4c5d67bd611a shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>lightning1141</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-268 rel=nofollow><time title="Thu Mar 16 2017 17:14:01 GMT+0100 (Central European Standard Time)" datetime=2017-02-04T16:14:01Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>If someone run the os get a check_long_mode error, try run qemu with this:<p>-cpu kvm64<br>Ps: Thanks Phil. This book is really helpful.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-285><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=30241fd32695 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Frank Afriat</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-285 rel=nofollow><time title="Tue Apr 04 2017 11:57:39 GMT+0200 (Central European Summer Time)" datetime=2017-03-02T09:57:39Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Thank you for the very clear blog and explanations.<br>Just a remark, would be clearer to add in the Paging section the meaning of bits 12-31 containing the physical address of the next P or the physical address.<p>What I don't understand is why P1 is not used and how the CPU know that there is no P1 and we link directly to the physical page ? It is also the role of the huge bit ? And also for 2 MB how is defined the offset ?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-286><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-286 rel=nofollow><time title="Mon Apr 17 2017 12:52:41 GMT+0200 (Central European Summer Time)" datetime=2017-03-01T10:52:41Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks!<p>We don't use a P1 because it would be cumbersome to set up 512 P1 tables in assembly. Instead, we set the huge bit in the P2 entries, which signals to the CPU that the entry directly points to the physical start address of a 2MiB page frame. This address has to be 2MiB aligned, so bits 0-23 have to be zero. When translating an address, these bits specify the offset in the 2MiB page.<p><blockquote>Just a remark, would be clearer to add in the Paging section the meaning of bits 12-31 containing the physical address of the next P or the physical address.</blockquote><p><p>Thanks for the suggestion! I opened <a href=https://github.com/phil-opp/blog_os/issues/314 rel=nofollow>#314</a> to track it.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-287><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=016d54da27c5 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Eran Sabala</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-287 rel=nofollow><time title="Sat Apr 22 2017 12:00:57 GMT+0200 (Central European Summer Time)" datetime=2017-03-06T10:00:57Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Very nice post.. Thanks for the effort (:</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-288><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=f6ffed79ea8d shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Anatol Pomozov</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-288 rel=nofollow><time title="Tue May 23 2017 16:12:18 GMT+0200 (Central European Summer Time)" datetime=2017-04-02T14:12:18Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks for the blogpost series. It is very useful for those who develops its own x86 operation system.<p>In my own project (unrelated to this Rust OS) I try to initialize segment registers with null descriptor like you do 'mov XX, 0'. Setting ds/es/fs/gs works fine, but when I try to set SS with null descriptor I get a crash. Looking at the documentation 'Intel 64 developers manual Vol. 2B 4-37' I see that 'MOV SS, 0' is prohibited and causes #GP(0).<p>I wonder why 'MOV SS, 0' works for you...</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-289><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=b9f05c2f35c4 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=12></rect><rect style="fill: #be5168" height=8 width=8 x=4 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=36 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=20></rect><rect style="fill: #be5168" height=8 width=8 x=12 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=28 y=36></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=4></rect><rect style="fill: #be5168" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Stefan Junker</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-289 rel=nofollow><time title="Tue May 23 2017 17:45:24 GMT+0200 (Central European Summer Time)" datetime=2017-04-02T15:45:24Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>I'm not certain why there is a limitation, but in the blog post the <br>data is written to `ax` first and then loaded from `ax` to `ss`.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-290><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=f6ffed79ea8d shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Anatol Pomozov</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-290 rel=nofollow><time title="Tue May 23 2017 18:04:41 GMT+0200 (Central European Summer Time)" datetime=2017-04-02T16:04:41Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>it seems that "mov" to segment register requires a general purpose register as source. In my code I also use 'movw %ax, %ds' I just made it a bit easier to read by using const value.<p>Anyway it is unrelated to my original question. Writing null descriptor to all segment registers (except %ss) is fine. Documentation also states that null descriptor cannot be used for the stack segment.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-291><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-291 rel=nofollow><time title="Thu Jun 08 2017 11:44:20 GMT+0200 (Central European Summer Time)" datetime=2017-05-04T09:44:20Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Hmm, do you have a link to the documentation? I can't find anything relevant on page 4-37 in this document: https://www.intel.com/Assets/en_US/PDF/manual/253667.pdf<p>The AMD64 manual states on page 253:<p><blockquote>Normally, an IRET that pops a null selector into the SS register causes a general-protection exception (#GP) to occur. However, in long mode, the null selector indicates the existence of nested interrupt handlers and/or privileged software in 64-bit mode. Long mode allows an IRET to pop a null selector into SS from the stack under the following conditions:<br>‚Ä¢ The target mode is 64-bit mode.<br>‚Ä¢ The target CPL&LT3.<br>In this case, the processor does not load an SS descriptor, and the null selector is loaded into SS without causing a #GP exception<br></blockquote><p><p>Maybe I interpreted that wrong, though‚Ä¶</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-292><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=f6ffed79ea8d shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Anatol Pomozov</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-292 rel=nofollow><time title="Thu Jun 08 2017 13:41:12 GMT+0200 (Central European Summer Time)" datetime=2017-05-04T11:41:12Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Hi Philipp, your link points to 6 years old Intel doc, here is the same but much more recent <a href=https://software.intel.com/sites/default/files/managed/7c/f1/253667-sdm-vol-2b.pdf rel=nofollow>https://software.intel.com/...</a><p>Scroll to 'MOV' instruction, page 4-37. There is a block algorithm for MOV that says<p>IF segment selector is NULL<br>THEN #GP(0); FI;<p>I believe I hit this issue.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-293><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=666df3217240 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=12></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=4 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=36 y=36></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=4></rect><rect style="fill: #9abf88" height=8 width=8 x=12 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=28 y=28></rect><rect style="fill: #9abf88" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-293 rel=nofollow><time title="Thu Jun 08 2017 13:53:10 GMT+0200 (Central European Summer Time)" datetime=2017-05-04T11:53:10Z>vor 2 Jahren</time></a><span class=note></span></div><div class=text><p>Thanks for the link!<p>Hmm, the listing is preceded by ‚ÄúLoading a segment register while in protected mode results in special checks and actions, as described in the following listing.‚Äù (emphasis mine)<p>Under ‚Äú64-Bit Mode Exceptions‚Äù (page 4-39) there are only 3 cases for a #GP(0):<p><blockquote>If the memory address is in a non-canonical form.<br>If an attempt is made to load SS register with NULL segment selector when CPL = 3.<br>If an attempt is made to load SS register with NULL segment selector when CPL < 3 and CPL ‚â† RPL.<br></blockquote><p><p>I see no reason why we should hit any of these‚Ä¶</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class=isso-comment-loader id=isso-loader-288><a class=load_hidden href=# rel=nofollow>1 versteckt</a></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-300><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=f6ffed79ea8d shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=36></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Anatol Pomozov</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-300 rel=nofollow><time title="Thu Jun 22 2017 20:21:41 GMT+0200 (Central European Summer Time)" datetime=2017-05-04T18:21:41Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>I have one more question. In your example you do a jump to long mode. As far as I know long 'call' can be used here as well. In fact call works in KVM and vmware but for some reason the operation crashes with #GP error. Do you know why it can be?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-306><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=5db23f819f9f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta>Philipp Oppermann<span class=spacer>‚Ä¢</span><a class=permalink href=#isso-306 rel=nofollow><time title="Sat Jul 08 2017 16:39:23 GMT+0200 (Central European Summer Time)" datetime=2017-06-06T14:39:23Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>You need to do a so-called far jump, which updates the code segment. I'm not sure right now if a far call is supported in long mode. Either way, returning to 32-bit code might not be a good idea anyway, since the opcodes might be interpreted differently.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-307><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=49569f04b2b6 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=28></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Tom√°≈° Kr√°l</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-307 rel=nofollow><time title="Wed Jul 12 2017 12:08:32 GMT+0200 (Central European Summer Time)" datetime=2017-06-03T10:08:32Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Hi, I can't get the boot.asm file to assemble because it gives me this error: src/arch/x86_64/boot.asm:(.text+0x4a): undefined reference to `long_mode_start'</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-308><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=5db23f819f9f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta>Philipp Oppermann<span class=spacer>‚Ä¢</span><a class=permalink href=#isso-308 rel=nofollow><time title="Wed Jul 12 2017 13:38:50 GMT+0200 (Central European Summer Time)" datetime=2017-06-03T11:38:50Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Does the error occur when invoking nasm? Then you need to add <code>extern long_mode_start</code> somewhere inside the boot.asm (e.g. at the beginning). If it occurs while invoking ld, make sure that the <code>long_mode_init.asm</code> file is assembled and passed to ld (and it should of course define a global <code>long_mode_start:</code> label).</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-311><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=2c7d5347c20f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Tom√°≈° Kr√°l</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-311 rel=nofollow><time title="Sun Jul 16 2017 12:29:49 GMT+0200 (Central European Summer Time)" datetime=2017-06-00T10:29:49Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Yep, I was missing the extern long_mode_start, thank you ! :)</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-310><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=2c7d5347c20f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Tom√°≈° Kr√°l</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-310 rel=nofollow><time title="Sun Jul 16 2017 12:28:50 GMT+0200 (Central European Summer Time)" datetime=2017-06-00T10:28:50Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Hi, I want to ask something about assembly. Why do I have to move p4_table to eax before moving eax into cr3 ? Why can't I move p4_table directly into cr3 ?</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-312><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=5db23f819f9f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta>Philipp Oppermann<span class=spacer>‚Ä¢</span><a class=permalink href=#isso-312 rel=nofollow><time title="Sun Jul 16 2017 13:21:43 GMT+0200 (Central European Summer Time)" datetime=2017-06-00T11:21:43Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Because the CR3 register can only be loaded from a register. So you have to load the <code>p4_table</code> address into a register first.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-315><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=9c7f9bf0db46 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=20></rect><rect style="fill: #e4bf80" height=8 width=8 x=4 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=36 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=4></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=12></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=28></rect><rect style="fill: #e4bf80" height=8 width=8 x=12 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=28 y=36></rect><rect style="fill: #e4bf80" height=8 width=8 x=20 y=12></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>fsb</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-315 rel=nofollow><time title="Tue Aug 01 2017 23:06:51 GMT+0200 (Central European Summer Time)" datetime=2017-07-02T21:06:51Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Hi,<p>out of curiosity: Does it make sense to keep the 32bit print instructions as "dead code" in the program? It can never be reached, right?<pre><code>; print `OK` to screen
mov dword [0xb8000], 0x2f4b2f4f
hlt
</code></pre></div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class=isso-comment id=isso-316><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=16a5ebe14cdd shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=4 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=36 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=12 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=28 y=20></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=4></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=12></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=28></rect><rect style="fill: #f19670" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-316 rel=nofollow><time title="Wed Aug 02 2017 14:26:45 GMT+0200 (Central European Summer Time)" datetime=2017-07-03T12:26:45Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Yeah, it should be unreachable after entering long mode (we would need to enter protected mode again). So it does not make much sense to keep it.</div><div class=isso-comment-footer><span class=votes>-1</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-345><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=58f409d0eeaa shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>David</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-345 rel=nofollow><time title="Sun Nov 26 2017 18:15:10 GMT+0100 (Central European Standard Time)" datetime=2017-10-00T17:15:10Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>You should probably mention that the "set_up_page_tables" function works with 32 bit addresses and 32-bit (4-byte) PTE/PDE entries, each holding the 20-bit, page-aligned, physical address of the next data structure (plus 12 bits of 0s, since each level is page aligned). Readers may be confused from the preceding explication of 64-bit PTEs, which are not used there (certainly I was).</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-351><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=5db23f819f9f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-351 rel=nofollow><time title="Sat Dec 09 2017 18:53:29 GMT+0100 (Central European Standard Time)" datetime=2017-11-06T17:53:29Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>We do use 8 byte PTEs with 64 bit addresses, but we only write the bottom 32 bits, since the higher 32 bits are zero.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class=isso-comment id=isso-352><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=58f409d0eeaa shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>David</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-352 rel=nofollow><time title="Thu Dec 14 2017 12:03:33 GMT+0100 (Central European Standard Time)" datetime=2017-11-04T11:03:33Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>I guess that what's unclear to me is why you say that each PTE entry contains the 52-bit physical address of the next frame/entry but in the table it looks like only bits 12-51 (40 bits) are used for that.</div><div class=isso-comment-footer><span class=votes>1</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class=isso-comment id=isso-353><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=90b57e8e7aa3 shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=36></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=20></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-353 rel=nofollow><time title="Thu Dec 14 2017 12:07:57 GMT+0100 (Central European Standard Time)" datetime=2017-11-04T11:07:57Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Oh, that's because page tables are always page aligned, i.e. bits 0-12 have to be always zero. The hardware manufacturers utilized that fact to use those bits for the flags instead.</div><div class=isso-comment-footer><span class=votes>1</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div><div class="isso-comment isso-no-votes" id=isso-354><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=58f409d0eeaa shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=4 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=36 y=36></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=12></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=12 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=28 y=28></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=4></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=20></rect><rect style="fill: #e279a3" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>David</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-354 rel=nofollow><time title="Thu Dec 14 2017 12:22:55 GMT+0100 (Central European Standard Time)" datetime=2017-11-04T11:22:55Z>letztes Jahr</time></a><span class=note></span></div><div class=text><p>Makes sense, thanks.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-392><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=182005e8435f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Shane</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-392 rel=nofollow><time title="Sat Mar 17 2018 03:04:21 GMT+0100 (Central European Standard Time)" datetime=2018-02-06T02:04:21Z>vor 9 Monaten</time></a><span class=note></span></div><div class=text><p>Is this rust or assembly? I've never used rust before although I've used assembly.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up><div class="isso-comment isso-no-votes" id=isso-393><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=5db23f819f9f shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=4 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=36 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=12></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=20></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=12 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=28 y=36></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=4></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=28></rect><rect style="fill: #447c69" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>Philipp Oppermann</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-393 rel=nofollow><time title="Sat Mar 17 2018 10:01:19 GMT+0100 (Central European Standard Time)" datetime=2018-02-06T09:01:19Z>vor 9 Monaten</time></a><span class=note></span></div><div class=text><p>This post is still in assembly. The next post is rust.</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></div></div><div class="isso-comment isso-no-votes" id=isso-394><div class=avatar><svg preserveaspectratio="xMinYMin meet" viewbox="0 0 48 48" data-hash=66f1dbcf42db shape-rendering=crispEdges version=1.1><rect style="fill: #f0f0f0" height=56 width=56 x=0 y=0></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=4 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=36 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=12 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=28 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=4></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=12></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=28></rect><rect style="fill: #9163b6" height=8 width=8 x=20 y=36></rect></svg></div><div class=text-wrapper><div class=isso-comment-header role=meta><span class=author>DaeMoohn</span><span class=spacer>‚Ä¢</span><a class=permalink href=#isso-394 rel=nofollow><time title="Mon Mar 19 2018 13:01:07 GMT+0100 (Central European Standard Time)" datetime=2018-02-01T12:01:07Z>vor 9 Monaten</time></a><span class=note></span></div><div class=text><p>Hi,<p>I'm trying to follow your steps while I'm trying to build a kernel in Rust. I have some questions at this point:<ol><li><p>you skipped the A20 gate checking altogether. Is that an error or you consider it so arcane that is just not needed? On my emulators I'm trying to activate it and my machine just goes haywire.<li><p>why do you map 1 GB for your kernel here? A smaller amount would surely be as suitable as 1 GB<li><p>some other sites/blogs/resources I read on the internet warn us to map the kernel to a higher area due to linker issues<li><p>I haven't read in detail the next posts, but I've seen you remap the kernel somewhere in the future. Is that because what you are doing here is just a quick way to go to long mode, and you actually do it as needed in Rust?<li><p>On OSDev they also mention something about a P5 coming in the future.</ol><p>Thanks, very informative reading!</div><div class=isso-comment-footer><span class=votes>0</span><a class=upvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,18.299c-0.651-0.669-7.512-7.203-7.512-7.203C 16.912,10.739, 16.456,10.56, 16,10.56c-0.458,0-0.914,0.179-1.261,0.536 c0,0-6.861,6.534-7.514,7.203c-0.651,0.669-0.696,1.872,0,2.586c 0.698,0.712, 1.669,0.77, 2.522,0L 16,14.89l 6.251,5.995 c 0.854,0.77, 1.827,0.712, 2.522,0C 25.47,20.17, 25.427,18.966, 24.773,18.299z"> </path> </g> </svg> </a><span class=spacer>|</span><a class=downvote href=# rel=nofollow><svg viewbox="0 0 32 32" fill=gray height=16 width=16 xmlns=http://www.w3.org/2000/svg xmlns:xlink=http://www.w3.org/1999/xlink> <g> <path d="M 24.773,13.701c-0.651,0.669-7.512,7.205-7.512,7.205C 16.912,21.262, 16.456,21.44, 16,21.44c-0.458,0-0.914-0.178-1.261-0.534 c0,0-6.861-6.536-7.514-7.205c-0.651-0.669-0.696-1.87,0-2.586c 0.698-0.714, 1.669-0.77, 2.522,0L 16,17.112l 6.251-5.995 c 0.854-0.77, 1.827-0.714, 2.522,0C 25.47,11.83, 25.427,13.034, 24.773,13.701z"> </path> </g> </svg> </a><a class=reply href=# rel=nofollow>Antworten</a></div><div class=isso-follow-up></div></div></div></div></section></section></div><footer class=footer><hr><small> ¬© <time datetime=2017>2017</time>. All rights reserved. <a href=https://os.phil-opp.com/contact/>Contact</a> </small></footer></div><script async data-goatcounter=https://phil-opp.goatcounter.com/count src=//gc.zgo.at/count.js></script>